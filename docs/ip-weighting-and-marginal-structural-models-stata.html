<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>12. IP Weighting and Marginal Structural Models: Stata | Causal Inference: What If. R and Stata code for Exercises</title>
  <meta name="description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="12. IP Weighting and Marginal Structural Models: Stata | Causal Inference: What If. R and Stata code for Exercises" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="12. IP Weighting and Marginal Structural Models: Stata | Causal Inference: What If. R and Stata code for Exercises" />
  
  <meta name="twitter:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

<meta name="author" content="Book by M. A. Hern치n and J. M. Robins" />
<meta name="author" content="R code by Joy Shi and Sean McGrath" />
<meta name="author" content="Stata code by Eleanor Murray and Roger Logan" />
<meta name="author" content="R Markdown code by Tom Palmer" />


<meta name="date" content="2022-07-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="why-model-stata.html"/>
<link rel="next" href="standardization-and-the-parametric-g-formula-stata.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Table of Contents</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-code"><i class="fa fa-check"></i>Downloading the code</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#installing-dependency-packages"><i class="fa fa-check"></i>Installing dependency packages</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-datasets"><i class="fa fa-check"></i>Downloading the datasets</a></li>
</ul></li>
<li class="part"><span><b>R code</b></span></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html"><i class="fa fa-check"></i>11. Why model?</a>
<ul>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.2"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.3"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.2"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.3"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.4"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.5"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.6"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.7"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.2"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.3"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.4"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.2"><i class="fa fa-check"></i>Program 14.2</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-one-possible-value-of-psi"><i class="fa fa-check"></i>G-estimation: Checking one possible value of psi</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-multiple-possible-values-of-psi"><i class="fa fa-check"></i>G-estimation: Checking multiple possible values of psi</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.3"><i class="fa fa-check"></i>Program 14.3</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-linear-mean-models"><i class="fa fa-check"></i>G-estimation: Closed form estimator linear mean models</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-for-2-parameter-model"><i class="fa fa-check"></i>G-estimation: Closed form estimator for 2-parameter model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.2"><i class="fa fa-check"></i>Program 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.3"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.4"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html"><i class="fa fa-check"></i>16. Instrumental variables estimation</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.2"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.3"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.4"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.5"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html"><i class="fa fa-check"></i>17. Causal survival analysis</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.2"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.3"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.4"><i class="fa fa-check"></i>Program 17.4</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.5"><i class="fa fa-check"></i>Program 17.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-r.html"><a href="session-information-r.html"><i class="fa fa-check"></i>Session information: R</a></li>
<li class="part"><span><b>Stata code</b></span></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html"><i class="fa fa-check"></i>11. Why model: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.1-1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.2-1"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.3-1"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.1-1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.2-1"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.3-1"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.4-1"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.5-1"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.6-1"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.7-1"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.1-1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.2-1"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.3-1"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.4-1"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.1-1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.2-1"><i class="fa fa-check"></i>Program 14.2</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.3-1"><i class="fa fa-check"></i>Program 14.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.1-1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#prorgam-15.2"><i class="fa fa-check"></i>Prorgam 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.3-1"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.4-1"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html"><i class="fa fa-check"></i>16. Instrumental variables estimation: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.1-1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.2-1"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.3-1"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.4-1"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.5-1"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html"><i class="fa fa-check"></i>17. Causal survival analysis: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.1-1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.2-1"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.3-1"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.4-1"><i class="fa fa-check"></i>Program 17.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-stata.html"><a href="session-information-stata.html"><i class="fa fa-check"></i>Session information: Stata</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Causal Inference: What If. R and Stata code for Exercises</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ip-weighting-and-marginal-structural-models-stata" class="section level1 unnumbered hasAnchor">
<h1>12. IP Weighting and Marginal Structural Models: Stata<a href="ip-weighting-and-marginal-structural-models-stata.html#ip-weighting-and-marginal-structural-models-stata" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Statamarkdown)</span></code></pre></div>
<pre><code>/***************************************************************
Stata code for Causal Inference: What If by Miguel Hernan &amp; Jamie Robins
Date: 10/10/2019
Author: Eleanor Murray 
For errors contact: ejmurray@bu.edu
***************************************************************/</code></pre>
<div id="program-12.1-1" class="section level2 hasAnchor">
<h2>Program 12.1<a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.1-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Descriptive statistics from NHEFS data (Table 12.1)</li>
</ul>
<div class="sourceCode" id="cb351"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb351-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs, <span class="kw">clear</span></span>
<span id="cb351-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*Provisionally ignore subjects with missing values for follow-up weight*/</span></span>
<span id="cb351-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-4" aria-hidden="true" tabindex="-1"></a><span class="co">/*Sample size after exclusion: N = 1566*/</span></span>
<span id="cb351-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-5" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">if</span> wt82==.</span>
<span id="cb351-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-7"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-7" aria-hidden="true" tabindex="-1"></a><span class="co">/* Calculate mean weight change in those with and without smoking cessation*/</span></span>
<span id="cb351-8"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-8" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">define</span> qsmk 0 <span class="st">&quot;No smoking cessation&quot;</span> 1 <span class="st">&quot;Smoking cessation&quot;</span></span>
<span id="cb351-9"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-9" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">values</span> qsmk qsmk</span>
<span id="cb351-10"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-10" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> years = <span class="kw">mean</span>(age) <span class="kw">if</span> age &lt; . </span>
<span id="cb351-11"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-11" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> years <span class="st">&quot;Age, years&quot;</span></span>
<span id="cb351-12"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-12" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> male = <span class="kw">mean</span>(100 * (sex==0)) <span class="kw">if</span> sex &lt; . </span>
<span id="cb351-13"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-13" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> male <span class="st">&quot;Men, %&quot;</span></span>
<span id="cb351-14"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-14" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> <span class="bn">white</span> = <span class="kw">mean</span>(100 * (race==0)) <span class="kw">if</span> race &lt; . </span>
<span id="cb351-15"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-15" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> <span class="bn">white</span> <span class="st">&quot;White, %&quot;</span></span>
<span id="cb351-16"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-16" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> university = <span class="kw">mean</span>(100 * (education == 5)) <span class="kw">if</span> education &lt; .</span>
<span id="cb351-17"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-17" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> university <span class="st">&quot;University, %&quot;</span></span>
<span id="cb351-18"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-18" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> kg = <span class="kw">mean</span>(wt71) <span class="kw">if</span> wt71 &lt; .</span>
<span id="cb351-19"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-19" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> kg <span class="st">&quot;Weight, kg&quot;</span></span>
<span id="cb351-20"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-20" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> cigs = <span class="kw">mean</span>(smokeintensity) <span class="kw">if</span> smokeintensity &lt; . </span>
<span id="cb351-21"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-21" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> cigs <span class="st">&quot;Cigarettes/day&quot;</span></span>
<span id="cb351-22"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-22" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> meansmkyrs = <span class="kw">mean</span>(smokeyrs) <span class="kw">if</span> smokeyrs &lt; .</span>
<span id="cb351-23"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-23" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> kg <span class="st">&quot;Years smoking&quot;</span></span>
<span id="cb351-24"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-24" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> noexer = <span class="kw">mean</span>(100 * (exercise == 2)) <span class="kw">if</span> exercise &lt; . </span>
<span id="cb351-25"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-25" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> noexer <span class="st">&quot;Little/no exercise&quot;</span></span>
<span id="cb351-26"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-26" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> qsmk, <span class="kw">sort</span>: <span class="kw">egen</span> inactive = <span class="kw">mean</span>(100 * (active==2)) <span class="kw">if</span> active &lt; . </span>
<span id="cb351-27"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-27" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> inactive <span class="st">&quot;Inactive daily life&quot;</span></span>
<span id="cb351-28"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb351-28" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">save</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">replace</span></span></code></pre></div>
<pre><code>(63 observations deleted)
</code></pre>
<div class="sourceCode" id="cb353"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb353-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">clear</span></span>
<span id="cb353-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb353-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb353-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*Output table*/</span></span>
<span id="cb353-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb353-4" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="kw">var</span> <span class="kw">of</span> <span class="kw">varlist</span> years male  <span class="bn">white</span> university kg cigs meansmkyrs noexer inactive {</span>
<span id="cb353-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb353-5" aria-hidden="true" tabindex="-1"></a>  tabdisp qsmk, cell(<span class="ot">`var&#39;</span>) <span class="kw">format</span>(%3.1f)</span>
<span id="cb353-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb353-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>  2.   tabdisp qsmk, cell(`var&#39;) format(%3.1f)
  3. }

---------------------------------
quit smoking between |
baseline and 1982    | Age, years
---------------------+-----------
No smoking cessation |       42.8
   Smoking cessation |       46.2
---------------------------------

---------------------------------
quit smoking between |
baseline and 1982    |     Men, %
---------------------+-----------
No smoking cessation |       46.6
   Smoking cessation |       54.6
---------------------------------

---------------------------------
quit smoking between |
baseline and 1982    |   White, %
---------------------+-----------
No smoking cessation |       85.4
   Smoking cessation |       91.1
---------------------------------

------------------------------------
quit smoking between |
baseline and 1982    | University, %
---------------------+--------------
No smoking cessation |           9.9
   Smoking cessation |          15.4
------------------------------------

------------------------------------
quit smoking between |
baseline and 1982    | Years smoking
---------------------+--------------
No smoking cessation |          70.3
   Smoking cessation |          72.4
------------------------------------

-------------------------------------
quit smoking between |
baseline and 1982    | Cigarettes/day
---------------------+---------------
No smoking cessation |           21.2
   Smoking cessation |           18.6
-------------------------------------

---------------------------------
quit smoking between |
baseline and 1982    | meansmkyrs
---------------------+-----------
No smoking cessation |       24.1
   Smoking cessation |       26.0
---------------------------------

-----------------------------------------
quit smoking between |
baseline and 1982    | Little/no exercise
---------------------+-------------------
No smoking cessation |               37.9
   Smoking cessation |               40.7
-----------------------------------------

------------------------------------------
quit smoking between |
baseline and 1982    | Inactive daily life
---------------------+--------------------
No smoking cessation |                 8.9
   Smoking cessation |                11.2
------------------------------------------</code></pre>
</div>
<div id="program-12.2-1" class="section level2 hasAnchor">
<h2>Program 12.2<a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.2-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating IP weights for Section 12.2</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb355"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb355-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">clear</span></span>
<span id="cb355-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a logistic model for the IP weights*/</span> </span>
<span id="cb355-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-4" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb355-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-5" aria-hidden="true" tabindex="-1"></a>c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71 </span>
<span id="cb355-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-7"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-7" aria-hidden="true" tabindex="-1"></a><span class="co">/*Output predicted conditional probability of quitting smoking for each individual*/</span></span>
<span id="cb355-8"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-8" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> p_qsmk, pr</span>
<span id="cb355-9"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-10"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-10" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate nonstabilized weights as P(A=1|covariates) if A = 1 and 1-P(A=1|covariates) if A = 0*/</span></span>
<span id="cb355-11"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-11" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">w</span>=.</span>
<span id="cb355-12"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-12" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="fu">w</span>=1/p_qsmk <span class="kw">if</span> qsmk==1</span>
<span id="cb355-13"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-13" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="fu">w</span>=1/(1-p_qsmk) <span class="kw">if</span> qsmk==0</span>
<span id="cb355-14"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-14" aria-hidden="true" tabindex="-1"></a><span class="co">/*Check the mean of the weights; we expect it to be close to 2.0*/</span></span>
<span id="cb355-15"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-15" aria-hidden="true" tabindex="-1"></a><span class="kw">summarize</span> <span class="fu">w</span></span>
<span id="cb355-16"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-17"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-17" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit marginal structural model in the pseudopopulation*/</span></span>
<span id="cb355-18"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-18" aria-hidden="true" tabindex="-1"></a><span class="co">/*Weights assigned using pweight = w*/</span></span>
<span id="cb355-19"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-19" aria-hidden="true" tabindex="-1"></a><span class="co">/*Robust standard errors using cluster() option where &#39;seqn&#39; is the ID variable*/</span></span>
<span id="cb355-20"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb355-20" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> wt82_71 qsmk [<span class="kw">pweight</span>=<span class="fu">w</span>], <span class="kw">cluster</span>(seqn) </span></code></pre></div>
<pre><code>Iteration 0:   log likelihood = -893.02712  
Iteration 1:   log likelihood = -839.70016  
Iteration 2:   log likelihood = -838.45045  
Iteration 3:   log likelihood = -838.44842  
Iteration 4:   log likelihood = -838.44842  

Logistic regression                                     Number of obs =  1,566
                                                        LR chi2(18)   = 109.16
                                                        Prob &gt; chi2   = 0.0000
Log likelihood = -838.44842                             Pseudo R2     = 0.0611

-------------------------------------------------------------------------------
         qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
          sex |  -.5274782   .1540497    -3.42   0.001      -.82941   -.2255463
         race |  -.8392636   .2100668    -4.00   0.000    -1.250987   -.4275404
          age |   .1212052   .0512663     2.36   0.018     .0207251    .2216853
              |
  c.age#c.age |  -.0008246   .0005361    -1.54   0.124    -.0018753    .0002262
              |
    education |
           1  |  -.4759606   .2262238    -2.10   0.035    -.9193511   -.0325701
           2  |  -.5047361    .217597    -2.32   0.020    -.9312184   -.0782538
           3  |  -.3895288   .1914353    -2.03   0.042    -.7647351   -.0143226
           4  |  -.4123596   .2772868    -1.49   0.137    -.9558318    .1311126
              |
smokeintens~y |  -.0772704   .0152499    -5.07   0.000    -.1071596   -.0473812
              |
           c. |
smokeintens~y#|
           c. |
smokeintens~y |   .0010451   .0002866     3.65   0.000     .0004835    .0016068
              |
     smokeyrs |  -.0735966   .0277775    -2.65   0.008    -.1280395   -.0191538
              |
   c.smokeyrs#|
   c.smokeyrs |   .0008441   .0004632     1.82   0.068    -.0000637    .0017519
              |
     exercise |
           0  |   -.395704   .1872401    -2.11   0.035    -.7626878   -.0287201
           1  |  -.0408635   .1382674    -0.30   0.768    -.3118627    .2301357
              |
       active |
           0  |   -.176784   .2149721    -0.82   0.411    -.5981215    .2445535
           1  |  -.1448395   .2111472    -0.69   0.493    -.5586806    .2690015
              |
         wt71 |  -.0152357   .0263161    -0.58   0.563    -.0668144     .036343
              |
c.wt71#c.wt71 |   .0001352   .0001632     0.83   0.407    -.0001846     .000455
              |
        _cons |   -1.19407   1.398493    -0.85   0.393    -3.935066    1.546925
-------------------------------------------------------------------------------


(1,566 missing values generated)

(403 real changes made)

(1,163 real changes made)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
           w |      1,566    1.996284    1.474787   1.053742   16.70009

(sum of wgt is 3,126.18084549904)

Linear regression                               Number of obs     =      1,566
                                                F(1, 1565)        =      42.81
                                                Prob &gt; F          =     0.0000
                                                R-squared         =     0.0435
                                                Root MSE          =     8.0713

                               (Std. err. adjusted for 1,566 clusters in seqn)
------------------------------------------------------------------------------
             |               Robust
     wt82_71 | Coefficient  std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        qsmk |   3.440535   .5258294     6.54   0.000     2.409131     4.47194
       _cons |   1.779978   .2248742     7.92   0.000     1.338892    2.221065
------------------------------------------------------------------------------</code></pre>
</div>
<div id="program-12.3-1" class="section level2 hasAnchor">
<h2>Program 12.3<a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.3-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating stabilized IP weights for Section 12.3</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb357"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb357-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">clear</span></span>
<span id="cb357-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a logistic model for the denominator of the IP weights and predict the conditional probability of smoking*/</span> </span>
<span id="cb357-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-4" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb357-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-5" aria-hidden="true" tabindex="-1"></a>c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71  </span>
<span id="cb357-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-6" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pd_qsmk, pr</span>
<span id="cb357-7"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-8"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-8" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a logistic model for the numerator of ip weights and predict Pr(A=1) */</span> </span>
<span id="cb357-9"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-9" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk </span>
<span id="cb357-10"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-10" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pn_qsmk, pr</span>
<span id="cb357-11"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-12"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-12" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate stabilized weights as f(A)/f(A|L)*/</span></span>
<span id="cb357-13"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-13" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> sw_a=.</span>
<span id="cb357-14"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-14" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=pn_qsmk/pd_qsmk <span class="kw">if</span> qsmk==1</span>
<span id="cb357-15"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-15" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=(1-pn_qsmk)/(1-pd_qsmk) <span class="kw">if</span> qsmk==0</span>
<span id="cb357-16"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-17"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-17" aria-hidden="true" tabindex="-1"></a><span class="co">/*Check distribution of the stabilized weights*/</span></span>
<span id="cb357-18"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-18" aria-hidden="true" tabindex="-1"></a><span class="kw">summarize</span> sw_a</span>
<span id="cb357-19"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-20"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-20" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit marginal structural model in the pseudopopulation*/</span></span>
<span id="cb357-21"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-21" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> wt82_71 qsmk [<span class="kw">pweight</span>=sw_a], <span class="kw">cluster</span>(seqn) </span>
<span id="cb357-22"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-23"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-23" aria-hidden="true" tabindex="-1"></a><span class="co">/**********************************************************</span></span>
<span id="cb357-24"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-24" aria-hidden="true" tabindex="-1"></a><span class="co">FINE POINT 12.2</span></span>
<span id="cb357-25"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-25" aria-hidden="true" tabindex="-1"></a><span class="co">Checking positivity</span></span>
<span id="cb357-26"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-26" aria-hidden="true" tabindex="-1"></a><span class="co">**********************************************************/</span></span>
<span id="cb357-27"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-28"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-28" aria-hidden="true" tabindex="-1"></a><span class="co">/*Check for missing values within strata of covariates, for example: */</span></span>
<span id="cb357-29"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-29" aria-hidden="true" tabindex="-1"></a><span class="kw">tab</span> age qsmk <span class="kw">if</span> race==0 &amp; sex==1 &amp; wt82!=.</span>
<span id="cb357-30"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb357-30" aria-hidden="true" tabindex="-1"></a><span class="kw">tab</span> age qsmk <span class="kw">if</span> race==1 &amp; sex==1 &amp; wt82!=.</span></code></pre></div>
<pre><code>Iteration 0:   log likelihood = -893.02712  
Iteration 1:   log likelihood = -839.70016  
Iteration 2:   log likelihood = -838.45045  
Iteration 3:   log likelihood = -838.44842  
Iteration 4:   log likelihood = -838.44842  

Logistic regression                                     Number of obs =  1,566
                                                        LR chi2(18)   = 109.16
                                                        Prob &gt; chi2   = 0.0000
Log likelihood = -838.44842                             Pseudo R2     = 0.0611

-------------------------------------------------------------------------------
         qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
          sex |  -.5274782   .1540497    -3.42   0.001      -.82941   -.2255463
         race |  -.8392636   .2100668    -4.00   0.000    -1.250987   -.4275404
          age |   .1212052   .0512663     2.36   0.018     .0207251    .2216853
              |
  c.age#c.age |  -.0008246   .0005361    -1.54   0.124    -.0018753    .0002262
              |
    education |
           1  |  -.4759606   .2262238    -2.10   0.035    -.9193511   -.0325701
           2  |  -.5047361    .217597    -2.32   0.020    -.9312184   -.0782538
           3  |  -.3895288   .1914353    -2.03   0.042    -.7647351   -.0143226
           4  |  -.4123596   .2772868    -1.49   0.137    -.9558318    .1311126
              |
smokeintens~y |  -.0772704   .0152499    -5.07   0.000    -.1071596   -.0473812
              |
           c. |
smokeintens~y#|
           c. |
smokeintens~y |   .0010451   .0002866     3.65   0.000     .0004835    .0016068
              |
     smokeyrs |  -.0735966   .0277775    -2.65   0.008    -.1280395   -.0191538
              |
   c.smokeyrs#|
   c.smokeyrs |   .0008441   .0004632     1.82   0.068    -.0000637    .0017519
              |
     exercise |
           0  |   -.395704   .1872401    -2.11   0.035    -.7626878   -.0287201
           1  |  -.0408635   .1382674    -0.30   0.768    -.3118627    .2301357
              |
       active |
           0  |   -.176784   .2149721    -0.82   0.411    -.5981215    .2445535
           1  |  -.1448395   .2111472    -0.69   0.493    -.5586806    .2690015
              |
         wt71 |  -.0152357   .0263161    -0.58   0.563    -.0668144     .036343
              |
c.wt71#c.wt71 |   .0001352   .0001632     0.83   0.407    -.0001846     .000455
              |
        _cons |   -1.19407   1.398493    -0.85   0.393    -3.935066    1.546925
-------------------------------------------------------------------------------



Iteration 0:   log likelihood = -893.02712  
Iteration 1:   log likelihood = -893.02712  

Logistic regression                                     Number of obs =  1,566
                                                        LR chi2(0)    =   0.00
                                                        Prob &gt; chi2   =      .
Log likelihood = -893.02712                             Pseudo R2     = 0.0000

------------------------------------------------------------------------------
        qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       _cons |  -1.059822   .0578034   -18.33   0.000    -1.173114    -.946529
------------------------------------------------------------------------------


(1,566 missing values generated)

(403 real changes made)

(1,163 real changes made)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        sw_a |      1,566    .9988444    .2882233   .3312489   4.297662

(sum of wgt is 1,564.19025221467)

Linear regression                               Number of obs     =      1,566
                                                F(1, 1565)        =      42.81
                                                Prob &gt; F          =     0.0000
                                                R-squared         =     0.0359
                                                Root MSE          =     7.7972

                               (Std. err. adjusted for 1,566 clusters in seqn)
------------------------------------------------------------------------------
             |               Robust
     wt82_71 | Coefficient  std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        qsmk |   3.440535   .5258294     6.54   0.000     2.409131     4.47194
       _cons |   1.779978   .2248742     7.92   0.000     1.338892    2.221065
------------------------------------------------------------------------------

           | quit smoking between
           |   baseline and 1982
       age | No smokin  Smoking c |     Total
-----------+----------------------+----------
        25 |        24          3 |        27 
        26 |        14          5 |        19 
        27 |        18          2 |        20 
        28 |        20          5 |        25 
        29 |        15          4 |        19 
        30 |        14          5 |        19 
        31 |        11          5 |        16 
        32 |        14          7 |        21 
        33 |        12          3 |        15 
        34 |        22          5 |        27 
        35 |        16          5 |        21 
        36 |        13          3 |        16 
        37 |        14          1 |        15 
        38 |         6          2 |         8 
        39 |        19          4 |        23 
        40 |        10          4 |        14 
        41 |        13          3 |        16 
        42 |        16          3 |        19 
        43 |        14          3 |        17 
        44 |         9          4 |        13 
        45 |        12          5 |        17 
        46 |        19          4 |        23 
        47 |        19          4 |        23 
        48 |        19          4 |        23 
        49 |        11          3 |        14 
        50 |        18          4 |        22 
        51 |         9          3 |        12 
        52 |        11          3 |        14 
        53 |        11          4 |        15 
        54 |        17          9 |        26 
        55 |         9          4 |        13 
        56 |         8          7 |        15 
        57 |         9          2 |        11 
        58 |         8          4 |        12 
        59 |         5          4 |         9 
        60 |         5          4 |         9 
        61 |         5          2 |         7 
        62 |         6          5 |        11 
        63 |         3          3 |         6 
        64 |         7          1 |         8 
        65 |         3          2 |         5 
        66 |         4          0 |         4 
        67 |         2          0 |         2 
        69 |         6          2 |         8 
        70 |         2          1 |         3 
        71 |         0          1 |         1 
        72 |         2          2 |         4 
        74 |         0          1 |         1 
-----------+----------------------+----------
     Total |       524        164 |       688 

           | quit smoking between
           |   baseline and 1982
       age | No smokin  Smoking c |     Total
-----------+----------------------+----------
        25 |         3          1 |         4 
        26 |         3          0 |         3 
        28 |         3          1 |         4 
        29 |         1          0 |         1 
        30 |         4          0 |         4 
        31 |         3          0 |         3 
        32 |         8          0 |         8 
        33 |         2          0 |         2 
        34 |         2          1 |         3 
        35 |         3          0 |         3 
        36 |         5          0 |         5 
        37 |         3          1 |         4 
        38 |         4          2 |         6 
        39 |         1          1 |         2 
        40 |         2          2 |         4 
        41 |         3          0 |         3 
        42 |         3          0 |         3 
        43 |         4          2 |         6 
        44 |         3          0 |         3 
        45 |         1          3 |         4 
        46 |         5          0 |         5 
        47 |         3          0 |         3 
        48 |         4          0 |         4 
        49 |         1          1 |         2 
        50 |         2          0 |         2 
        51 |         4          0 |         4 
        52 |         1          0 |         1 
        53 |         2          0 |         2 
        54 |         2          0 |         2 
        55 |         3          0 |         3 
        56 |         2          1 |         3 
        57 |         2          1 |         3 
        61 |         1          1 |         2 
        67 |         1          0 |         1 
        68 |         1          0 |         1 
        69 |         2          0 |         2 
        70 |         0          1 |         1 
-----------+----------------------+----------
     Total |        97         19 |       116 </code></pre>
</div>
<div id="program-12.4-1" class="section level2 hasAnchor">
<h2>Program 12.4<a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.4-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating the parameters of a marginal structural mean model with a continuous treatment Data from NHEFS</li>
<li>Section 12.4</li>
</ul>
<div class="sourceCode" id="cb359"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb359-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">clear</span></span>
<span id="cb359-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-3" aria-hidden="true" tabindex="-1"></a>* <span class="kw">drop</span> sw_a</span>
<span id="cb359-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-5" aria-hidden="true" tabindex="-1"></a><span class="co">/*Analysis restricted to subjects reporting &lt;=25 cig/day at baseline: N = 1162*/</span></span>
<span id="cb359-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-6" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> smokeintensity &lt;=25</span>
<span id="cb359-7"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-8"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-8" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a linear model for the denominator of the IP weights and calculate the mean expected smoking intensity*/</span> </span>
<span id="cb359-9"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-9" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> smkintensity82_71 sex race c.age##c.age ib(<span class="fu">last</span>).education c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb359-10"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-10" aria-hidden="true" tabindex="-1"></a>c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71</span>
<span id="cb359-11"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-11" aria-hidden="true" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">predict</span> p_den</span>
<span id="cb359-12"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-13"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-13" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate the denisty of the denomiator expectation using the mean expected smoking intensity and the residuals, assuming a normal distribution*/</span></span>
<span id="cb359-14"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-14" aria-hidden="true" tabindex="-1"></a><span class="co">/*Note: The regress command in STATA saves the root mean squared error for the immediate regression as e(rmse), thus there is no need to calculate it again. */</span></span>
<span id="cb359-15"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-15" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> dens_den = <span class="fu">normalden</span>(smkintensity82_71, p_den, <span class="fu">e</span>(rmse))</span>
<span id="cb359-16"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-17"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-17" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a linear model for the numerator of ip weights, calculate the mean expected value, and generate the density*/</span></span>
<span id="cb359-18"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-18" aria-hidden="true" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">regress</span> smkintensity82_71</span>
<span id="cb359-19"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-19" aria-hidden="true" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">predict</span> p_num</span>
<span id="cb359-20"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-20" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> dens_num = <span class="fu">normalden</span>( smkintensity82_71, p_num, <span class="fu">e</span>(rmse))</span>
<span id="cb359-21"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-22"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-22" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate the final stabilized weights from the estimated numerator and denominator, and check the weights distribution*/</span></span>
<span id="cb359-23"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-23" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> sw_a=dens_num/dens_den</span>
<span id="cb359-24"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-24" aria-hidden="true" tabindex="-1"></a><span class="kw">summarize</span> sw_a</span>
<span id="cb359-25"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-26"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-26" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a marginal structural model in the pseudopopulation*/</span></span>
<span id="cb359-27"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-27" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> wt82_71  c.smkintensity82_71##c.smkintensity82_71 [<span class="kw">pweight</span>=sw_a], <span class="kw">cluster</span>(seqn)</span>
<span id="cb359-28"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-29"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-29" aria-hidden="true" tabindex="-1"></a><span class="co">/*Output the estimated mean Y value when smoke intensity is unchanged from baseline to 1982 */</span></span>
<span id="cb359-30"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-30" aria-hidden="true" tabindex="-1"></a><span class="kw">lincom</span> _b[<span class="dt">_cons</span>]</span>
<span id="cb359-31"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-32"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-32" aria-hidden="true" tabindex="-1"></a><span class="co">/*Output the estimated mean Y value when smoke intensity increases by 20 from baseline to 1982*/</span></span>
<span id="cb359-33"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb359-33" aria-hidden="true" tabindex="-1"></a><span class="kw">lincom</span> _b[<span class="dt">_cons</span>] + 20*_b[smkintensity82_71 ] +400*_b[c.smkintensity82_71#c.smkintensity82_71]</span></code></pre></div>
<pre><code>(404 observations deleted)

      Source |       SS           df       MS      Number of obs   =     1,162
-------------+----------------------------------   F(18, 1143)     =      5.39
       Model |  9956.95654        18  553.164252   Prob &gt; F        =    0.0000
    Residual |   117260.18     1,143  102.589834   R-squared       =    0.0783
-------------+----------------------------------   Adj R-squared   =    0.0638
       Total |  127217.137     1,161  109.575484   Root MSE        =    10.129

-------------------------------------------------------------------------------
smkintensi~71 | Coefficient  Std. err.      t    P&gt;|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
          sex |   1.087021   .7425694     1.46   0.144    -.3699308    2.543973
         race |   .2319789   .8434739     0.28   0.783    -1.422952     1.88691
          age |  -.8099902   .2555388    -3.17   0.002    -1.311368   -.3086124
              |
  c.age#c.age |   .0066545   .0026849     2.48   0.013     .0013865    .0119224
              |
    education |
           1  |   1.508097   1.184063     1.27   0.203    -.8150843    3.831278
           2  |    2.02692   1.133772     1.79   0.074    -.1975876    4.251428
           3  |   2.240314   1.022556     2.19   0.029     .2340167    4.246611
           4  |   2.528767    1.44702     1.75   0.081    -.3103458     5.36788
              |
smokeintens~y |  -.3589684   .2246653    -1.60   0.110     -.799771    .0818342
              |
           c. |
smokeintens~y#|
           c. |
smokeintens~y |   .0019582   .0085753     0.23   0.819    -.0148668    .0187832
              |
     smokeyrs |   .3857088   .1416765     2.72   0.007     .1077336    .6636841
              |
   c.smokeyrs#|
   c.smokeyrs |  -.0054871   .0023837    -2.30   0.022    -.0101641   -.0008101
              |
     exercise |
           0  |   1.996904   .9080421     2.20   0.028      .215288    3.778521
           1  |    .988812   .6929239     1.43   0.154    -.3707334    2.348357
              |
       active |
           0  |   .8451341   1.098573     0.77   0.442    -1.310312    3.000581
           1  |    .800114    1.08438     0.74   0.461    -1.327485    2.927712
              |
         wt71 |  -.0656882    .136955    -0.48   0.632    -.3343996    .2030232
              |
c.wt71#c.wt71 |   .0005711    .000877     0.65   0.515    -.0011496    .0022918
              |
        _cons |   16.86761   7.109189     2.37   0.018      2.91909    30.81614
-------------------------------------------------------------------------------

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        sw_a |      1,162    .9968057    .3222937   .1938336   5.102339

(sum of wgt is 1,158.28818286955)

Linear regression                               Number of obs     =      1,162
                                                F(2, 1161)        =      12.75
                                                Prob &gt; F          =     0.0000
                                                R-squared         =     0.0233
                                                Root MSE          =     7.7864

                                (Std. err. adjusted for 1,162 clusters in seqn)
-------------------------------------------------------------------------------
              |               Robust
      wt82_71 | Coefficient  std. err.      t    P&gt;|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
smkintensi~71 |  -.1089889   .0315762    -3.45   0.001    -.1709417   -.0470361
              |
           c. |
smkintensi~71#|
           c. |
smkintensi~71 |   .0026949   .0024203     1.11   0.266    -.0020537    .0074436
              |
        _cons |   2.004525    .295502     6.78   0.000     1.424747    2.584302
-------------------------------------------------------------------------------


 ( 1)  _cons = 0

------------------------------------------------------------------------------
     wt82_71 | Coefficient  Std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.004525    .295502     6.78   0.000     1.424747    2.584302
------------------------------------------------------------------------------


 ( 1)  20*smkintensity82_71 + 400*c.smkintensity82_71#c.smkintensity82_71 +
       _cons = 0

------------------------------------------------------------------------------
     wt82_71 | Coefficient  Std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .9027234   1.310533     0.69   0.491    -1.668554    3.474001
------------------------------------------------------------------------------</code></pre>
</div>
<div id="program-12.5-1" class="section level2 hasAnchor">
<h2>Program 12.5<a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.5-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating the parameters of a marginal structural logistic model</li>
<li>Data from NHEFS</li>
<li>Section 12.4</li>
</ul>
<div class="sourceCode" id="cb361"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb361-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs, <span class="kw">clear</span></span>
<span id="cb361-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*Provisionally ignore subjects with missing values for follow-up weight*/</span></span>
<span id="cb361-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-4" aria-hidden="true" tabindex="-1"></a><span class="co">/*Sample size after exclusion: N = 1566*/</span></span>
<span id="cb361-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-5" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">if</span> wt82==.</span>
<span id="cb361-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-7"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-7" aria-hidden="true" tabindex="-1"></a><span class="co">/*Estimate the stabilized weights for quitting smoking as in PROGRAM 12.3*/</span></span>
<span id="cb361-8"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-8" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a logistic model for the denominator of the IP weights and predict the conditional probability of smoking*/</span> </span>
<span id="cb361-9"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-9" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb361-10"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-10" aria-hidden="true" tabindex="-1"></a>c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71  </span>
<span id="cb361-11"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-11" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pd_qsmk, pr</span>
<span id="cb361-12"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-12" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit a logistic model for the numerator of ip weights and predict Pr(A=1) */</span> </span>
<span id="cb361-13"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-13" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk </span>
<span id="cb361-14"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-14" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pn_qsmk, pr</span>
<span id="cb361-15"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-15" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate stabilized weights as f(A)/f(A|L)*/</span></span>
<span id="cb361-16"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-16" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> sw_a=.</span>
<span id="cb361-17"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-17" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=pn_qsmk/pd_qsmk <span class="kw">if</span> qsmk==1</span>
<span id="cb361-18"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-18" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=(1-pn_qsmk)/(1-pd_qsmk) <span class="kw">if</span> qsmk==0</span>
<span id="cb361-19"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-19" aria-hidden="true" tabindex="-1"></a><span class="kw">summarize</span> sw_a</span>
<span id="cb361-20"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-21"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-21" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit marginal structural model in the pseudopopulation*/</span></span>
<span id="cb361-22"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-22" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span><span class="al">NOTE</span><span class="co">: Stata has two commands for logistic regression, logit and logistic*/</span></span>
<span id="cb361-23"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-23" aria-hidden="true" tabindex="-1"></a><span class="co">/*Using logistic allows us to output the odds ratios directly*/</span></span>
<span id="cb361-24"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-24" aria-hidden="true" tabindex="-1"></a><span class="co">/*We can also output odds ratios from the logit command using the or option (default logit output is regression coefficients*/</span></span>
<span id="cb361-25"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb361-25" aria-hidden="true" tabindex="-1"></a><span class="kw">logistic</span> death qsmk [<span class="kw">pweight</span>=sw_a], <span class="kw">cluster</span>(seqn) </span></code></pre></div>
<pre><code>(63 observations deleted)


Iteration 0:   log likelihood = -893.02712  
Iteration 1:   log likelihood = -839.70016  
Iteration 2:   log likelihood = -838.45045  
Iteration 3:   log likelihood = -838.44842  
Iteration 4:   log likelihood = -838.44842  

Logistic regression                                     Number of obs =  1,566
                                                        LR chi2(18)   = 109.16
                                                        Prob &gt; chi2   = 0.0000
Log likelihood = -838.44842                             Pseudo R2     = 0.0611

-------------------------------------------------------------------------------
         qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
          sex |  -.5274782   .1540497    -3.42   0.001      -.82941   -.2255463
         race |  -.8392636   .2100668    -4.00   0.000    -1.250987   -.4275404
          age |   .1212052   .0512663     2.36   0.018     .0207251    .2216853
              |
  c.age#c.age |  -.0008246   .0005361    -1.54   0.124    -.0018753    .0002262
              |
    education |
           1  |  -.4759606   .2262238    -2.10   0.035    -.9193511   -.0325701
           2  |  -.5047361    .217597    -2.32   0.020    -.9312184   -.0782538
           3  |  -.3895288   .1914353    -2.03   0.042    -.7647351   -.0143226
           4  |  -.4123596   .2772868    -1.49   0.137    -.9558318    .1311126
              |
smokeintens~y |  -.0772704   .0152499    -5.07   0.000    -.1071596   -.0473812
              |
           c. |
smokeintens~y#|
           c. |
smokeintens~y |   .0010451   .0002866     3.65   0.000     .0004835    .0016068
              |
     smokeyrs |  -.0735966   .0277775    -2.65   0.008    -.1280395   -.0191538
              |
   c.smokeyrs#|
   c.smokeyrs |   .0008441   .0004632     1.82   0.068    -.0000637    .0017519
              |
     exercise |
           0  |   -.395704   .1872401    -2.11   0.035    -.7626878   -.0287201
           1  |  -.0408635   .1382674    -0.30   0.768    -.3118627    .2301357
              |
       active |
           0  |   -.176784   .2149721    -0.82   0.411    -.5981215    .2445535
           1  |  -.1448395   .2111472    -0.69   0.493    -.5586806    .2690015
              |
         wt71 |  -.0152357   .0263161    -0.58   0.563    -.0668144     .036343
              |
c.wt71#c.wt71 |   .0001352   .0001632     0.83   0.407    -.0001846     .000455
              |
        _cons |   -1.19407   1.398493    -0.85   0.393    -3.935066    1.546925
-------------------------------------------------------------------------------



Iteration 0:   log likelihood = -893.02712  
Iteration 1:   log likelihood = -893.02712  

Logistic regression                                    Number of obs =   1,566
                                                       LR chi2(0)    =   -0.00
                                                       Prob &gt; chi2   =       .
Log likelihood = -893.02712                            Pseudo R2     = -0.0000

------------------------------------------------------------------------------
        qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       _cons |  -1.059822   .0578034   -18.33   0.000    -1.173114    -.946529
------------------------------------------------------------------------------


(1,566 missing values generated)

(403 real changes made)

(1,163 real changes made)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        sw_a |      1,566    .9988444    .2882233   .3312489   4.297662


Logistic regression                                     Number of obs =  1,566
                                                        Wald chi2(1)  =   0.04
                                                        Prob &gt; chi2   = 0.8482
Log pseudolikelihood = -749.11596                       Pseudo R2     = 0.0000

                               (Std. err. adjusted for 1,566 clusters in seqn)
------------------------------------------------------------------------------
             |               Robust
       death | Odds ratio   std. err.      z    P&gt;|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        qsmk |   1.030578   .1621842     0.19   0.848     .7570517    1.402931
       _cons |   .2252711   .0177882   -18.88   0.000     .1929707    .2629781
------------------------------------------------------------------------------
Note: _cons estimates baseline odds.</code></pre>
</div>
<div id="program-12.6-1" class="section level2 hasAnchor">
<h2>Program 12.6<a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.6-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Assessing effect modification by sex using a marginal structural mean model</li>
<li>Data from NHEFS</li>
<li>Section 12.5</li>
</ul>
<div class="sourceCode" id="cb363"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb363-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs, <span class="kw">clear</span></span>
<span id="cb363-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-3" aria-hidden="true" tabindex="-1"></a>* <span class="kw">drop</span> pd_qsmk pn_qsmk sw_a</span>
<span id="cb363-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-5" aria-hidden="true" tabindex="-1"></a><span class="co">/*Check distribution of sex*/</span></span>
<span id="cb363-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-6" aria-hidden="true" tabindex="-1"></a><span class="kw">tab</span> sex</span>
<span id="cb363-7"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-8"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-8" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit logistc model for the denominator of IP weights, as in PROGRAM 12.3 */</span></span>
<span id="cb363-9"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-9" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb363-10"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-10" aria-hidden="true" tabindex="-1"></a>c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71 </span>
<span id="cb363-11"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-11" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pd_qsmk, pr</span>
<span id="cb363-12"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-13"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-13" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit logistic model for the numerator of IP weights, no including sex */</span></span>
<span id="cb363-14"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-14" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk sex</span>
<span id="cb363-15"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-15" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pn_qsmk, pr</span>
<span id="cb363-16"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-17"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-17" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate IP weights as before*/</span></span>
<span id="cb363-18"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-18" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> sw_a=.</span>
<span id="cb363-19"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-19" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=pn_qsmk/pd_qsmk <span class="kw">if</span> qsmk==1</span>
<span id="cb363-20"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-20" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=(1-pn_qsmk)/(1-pd_qsmk) <span class="kw">if</span> qsmk==0</span>
<span id="cb363-21"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-22"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-22" aria-hidden="true" tabindex="-1"></a><span class="kw">summarize</span> sw_a</span>
<span id="cb363-23"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-24"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-24" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit marginal structural model in the pseudopopulation, including interaction term between quitting smoking and sex*/</span></span>
<span id="cb363-25"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb363-25" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> wt82_71 qsmk##sex [pw=sw_a], <span class="kw">cluster</span>(seqn)</span></code></pre></div>
<pre><code>        sex |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        799       49.05       49.05
          1 |        830       50.95      100.00
------------+-----------------------------------
      Total |      1,629      100.00


Iteration 0:   log likelihood = -938.14308  
Iteration 1:   log likelihood = -884.53806  
Iteration 2:   log likelihood = -883.35064  
Iteration 3:   log likelihood = -883.34876  
Iteration 4:   log likelihood = -883.34876  

Logistic regression                                     Number of obs =  1,629
                                                        LR chi2(18)   = 109.59
                                                        Prob &gt; chi2   = 0.0000
Log likelihood = -883.34876                             Pseudo R2     = 0.0584

-------------------------------------------------------------------------------
         qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
          sex |  -.5075218   .1482316    -3.42   0.001    -.7980505   -.2169932
         race |  -.8502312   .2058722    -4.13   0.000    -1.253733   -.4467292
          age |   .1030132   .0488996     2.11   0.035     .0071718    .1988547
              |
  c.age#c.age |  -.0006052   .0005074    -1.19   0.233    -.0015998    .0003893
              |
    education |
           1  |  -.3796632   .2203948    -1.72   0.085     -.811629    .0523026
           2  |  -.4779835   .2141771    -2.23   0.026    -.8977629   -.0582041
           3  |  -.3639645   .1885776    -1.93   0.054    -.7335698    .0056409
           4  |  -.4221892   .2717235    -1.55   0.120    -.9547574     .110379
              |
smokeintens~y |  -.0651561   .0147589    -4.41   0.000    -.0940831   -.0362292
              |
           c. |
smokeintens~y#|
           c. |
smokeintens~y |   .0008461   .0002758     3.07   0.002     .0003054    .0013867
              |
     smokeyrs |  -.0733708   .0269958    -2.72   0.007    -.1262816     -.02046
              |
   c.smokeyrs#|
   c.smokeyrs |   .0008384   .0004435     1.89   0.059    -.0000307    .0017076
              |
     exercise |
           0  |  -.3550517   .1799293    -1.97   0.048    -.7077067   -.0023967
           1  |    -.06364   .1351256    -0.47   0.638    -.3284812    .2012013
              |
       active |
           0  |  -.0683123   .2087269    -0.33   0.743    -.4774095    .3407849
           1  |   -.057437   .2039967    -0.28   0.778    -.4572632    .3423892
              |
         wt71 |  -.0128478   .0222829    -0.58   0.564    -.0565214    .0308258
              |
c.wt71#c.wt71 |   .0001209   .0001352     0.89   0.371     -.000144    .0003859
              |
        _cons |  -1.185875   1.263142    -0.94   0.348    -3.661588    1.289838
-------------------------------------------------------------------------------



Iteration 0:   log likelihood = -938.14308  
Iteration 1:   log likelihood = -933.49896  
Iteration 2:   log likelihood = -933.49126  
Iteration 3:   log likelihood = -933.49126  

Logistic regression                                     Number of obs =  1,629
                                                        LR chi2(1)    =   9.30
                                                        Prob &gt; chi2   = 0.0023
Log likelihood = -933.49126                             Pseudo R2     = 0.0050

------------------------------------------------------------------------------
        qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         sex |  -.3441893   .1131341    -3.04   0.002     -.565928   -.1224506
       _cons |  -.8634417   .0774517   -11.15   0.000    -1.015244   -.7116391
------------------------------------------------------------------------------


(1,629 missing values generated)

(428 real changes made)

(1,201 real changes made)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        sw_a |      1,629    .9991318    .2636164   .2901148   3.683352

(sum of wgt is 1,562.01032829285)

Linear regression                               Number of obs     =      1,566
                                                F(3, 1565)        =      16.31
                                                Prob &gt; F          =     0.0000
                                                R-squared         =     0.0379
                                                Root MSE          =     7.8024

                               (Std. err. adjusted for 1,566 clusters in seqn)
------------------------------------------------------------------------------
             |               Robust
     wt82_71 | Coefficient  std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
      1.qsmk |    3.60623   .6576053     5.48   0.000      2.31635     4.89611
       1.sex |  -.0040025   .4496206    -0.01   0.993    -.8859246    .8779197
             |
    qsmk#sex |
        1 1  |   -.161224   1.036143    -0.16   0.876      -2.1936    1.871152
             |
       _cons |   1.759045   .3102511     5.67   0.000     1.150494    2.367597
------------------------------------------------------------------------------</code></pre>
</div>
<div id="program-12.7-1" class="section level2 hasAnchor">
<h2>Program 12.7<a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.7-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating IP weights to adjust for selection bias due to censoring</li>
<li>Data from NHEFS</li>
<li>Section 12.6</li>
</ul>
<div class="sourceCode" id="cb365"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb365-1"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs, <span class="kw">clear</span></span>
<span id="cb365-2"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-3"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*Analysis including all individuals regardless of missing wt82 status: N=1629*/</span></span>
<span id="cb365-4"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-4" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate censoring indicator: C = 1 if wt82 missing*/</span></span>
<span id="cb365-5"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-5" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="kw">byte</span> cens = (wt82 == .)</span>
<span id="cb365-6"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-7"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-7" aria-hidden="true" tabindex="-1"></a><span class="co">/*Check distribution of censoring by quitting smoking and baseline weight*/</span></span>
<span id="cb365-8"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-8" aria-hidden="true" tabindex="-1"></a><span class="kw">tab</span> cens qsmk, column</span>
<span id="cb365-9"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-9" aria-hidden="true" tabindex="-1"></a><span class="kw">bys</span> cens: <span class="kw">summarize</span> wt71</span>
<span id="cb365-10"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-11"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-11" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit logistic regression model for the  denominator of IP weight for A*/</span></span>
<span id="cb365-12"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-12" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb365-13"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-13" aria-hidden="true" tabindex="-1"></a>c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71 </span>
<span id="cb365-14"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-14" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pd_qsmk, pr</span>
<span id="cb365-15"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-16"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-16" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit logistic regression model for the  numerator of IP weights for A*/</span></span>
<span id="cb365-17"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-17" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> qsmk</span>
<span id="cb365-18"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-18" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pn_qsmk, pr</span>
<span id="cb365-19"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-20"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-20" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit logistic regression model for the  denominator of IP weights for C, including quitting smoking*/</span></span>
<span id="cb365-21"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-21" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> cens qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb365-22"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-22" aria-hidden="true" tabindex="-1"></a>c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71 </span>
<span id="cb365-23"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-23" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pd_cens, pr</span>
<span id="cb365-24"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-25"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-25" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit logistic regression model for the  numerator of IP weights for C, including quitting smoking */</span></span>
<span id="cb365-26"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-26" aria-hidden="true" tabindex="-1"></a><span class="kw">logit</span> cens qsmk</span>
<span id="cb365-27"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-27" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> pn_cens, pr</span>
<span id="cb365-28"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-29"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-29" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate the stabilized weights for A (sw_a)*/</span></span>
<span id="cb365-30"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-30" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> sw_a=.</span>
<span id="cb365-31"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-31" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=pn_qsmk/pd_qsmk <span class="kw">if</span> qsmk==1</span>
<span id="cb365-32"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-32" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_a=(1-pn_qsmk)/(1-pd_qsmk) <span class="kw">if</span> qsmk==0</span>
<span id="cb365-33"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-34"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-34" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate the stabilized weights for C (sw_c)*/</span></span>
<span id="cb365-35"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-35" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span><span class="al">NOTE</span><span class="co">: the conditional probability estimates generated by our logistic models for C represent the conditional probability of being censored (C=1)*/</span></span>
<span id="cb365-36"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-36" aria-hidden="true" tabindex="-1"></a><span class="co">/*We want weights for the conditional probability of bing uncensored, Pr(C=0|A,L)*/</span></span>
<span id="cb365-37"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-37" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> sw_c=.</span>
<span id="cb365-38"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-38" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sw_c=(1-pn_cens)/(1-pd_cens) <span class="kw">if</span> cens==0</span>
<span id="cb365-39"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-40"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-40" aria-hidden="true" tabindex="-1"></a><span class="co">/*Generate the final stabilized weights and check distribution*/</span></span>
<span id="cb365-41"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-41" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="kw">sw</span>=sw_a*sw_c</span>
<span id="cb365-42"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-42" aria-hidden="true" tabindex="-1"></a><span class="kw">summarize</span> <span class="kw">sw</span></span>
<span id="cb365-43"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-44"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-44" aria-hidden="true" tabindex="-1"></a><span class="co">/*Fit marginal structural model in the pseudopopulation*/</span></span>
<span id="cb365-45"><a href="ip-weighting-and-marginal-structural-models-stata.html#cb365-45" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> wt82_71 qsmk [pw=<span class="kw">sw</span>], <span class="kw">cluster</span>(seqn)</span></code></pre></div>
<pre><code>| Key               |
|-------------------|
|     frequency     |
| column percentage |
+-------------------+

           | quit smoking between
           |   baseline and 1982
      cens |         0          1 |     Total
-----------+----------------------+----------
         0 |     1,163        403 |     1,566 
           |     96.84      94.16 |     96.13 
-----------+----------------------+----------
         1 |        38         25 |        63 
           |      3.16       5.84 |      3.87 
-----------+----------------------+----------
     Total |     1,201        428 |     1,629 
           |    100.00     100.00 |    100.00 


--------------------------------------------------------------------------------
-&gt; cens = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        wt71 |      1,566    70.83092     15.3149      39.58     151.73

--------------------------------------------------------------------------------
-&gt; cens = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        wt71 |         63    76.55079     23.3326      36.17     169.19



Iteration 0:   log likelihood = -938.14308  
Iteration 1:   log likelihood = -884.53806  
Iteration 2:   log likelihood = -883.35064  
Iteration 3:   log likelihood = -883.34876  
Iteration 4:   log likelihood = -883.34876  

Logistic regression                                     Number of obs =  1,629
                                                        LR chi2(18)   = 109.59
                                                        Prob &gt; chi2   = 0.0000
Log likelihood = -883.34876                             Pseudo R2     = 0.0584

-------------------------------------------------------------------------------
         qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
          sex |  -.5075218   .1482316    -3.42   0.001    -.7980505   -.2169932
         race |  -.8502312   .2058722    -4.13   0.000    -1.253733   -.4467292
          age |   .1030132   .0488996     2.11   0.035     .0071718    .1988547
              |
  c.age#c.age |  -.0006052   .0005074    -1.19   0.233    -.0015998    .0003893
              |
    education |
           1  |  -.3796632   .2203948    -1.72   0.085     -.811629    .0523026
           2  |  -.4779835   .2141771    -2.23   0.026    -.8977629   -.0582041
           3  |  -.3639645   .1885776    -1.93   0.054    -.7335698    .0056409
           4  |  -.4221892   .2717235    -1.55   0.120    -.9547574     .110379
              |
smokeintens~y |  -.0651561   .0147589    -4.41   0.000    -.0940831   -.0362292
              |
           c. |
smokeintens~y#|
           c. |
smokeintens~y |   .0008461   .0002758     3.07   0.002     .0003054    .0013867
              |
     smokeyrs |  -.0733708   .0269958    -2.72   0.007    -.1262816     -.02046
              |
   c.smokeyrs#|
   c.smokeyrs |   .0008384   .0004435     1.89   0.059    -.0000307    .0017076
              |
     exercise |
           0  |  -.3550517   .1799293    -1.97   0.048    -.7077067   -.0023967
           1  |    -.06364   .1351256    -0.47   0.638    -.3284812    .2012013
              |
       active |
           0  |  -.0683123   .2087269    -0.33   0.743    -.4774095    .3407849
           1  |   -.057437   .2039967    -0.28   0.778    -.4572632    .3423892
              |
         wt71 |  -.0128478   .0222829    -0.58   0.564    -.0565214    .0308258
              |
c.wt71#c.wt71 |   .0001209   .0001352     0.89   0.371     -.000144    .0003859
              |
        _cons |  -1.185875   1.263142    -0.94   0.348    -3.661588    1.289838
-------------------------------------------------------------------------------



Iteration 0:   log likelihood = -938.14308  
Iteration 1:   log likelihood = -938.14308  

Logistic regression                                     Number of obs =  1,629
                                                        LR chi2(0)    =   0.00
                                                        Prob &gt; chi2   =      .
Log likelihood = -938.14308                             Pseudo R2     = 0.0000

------------------------------------------------------------------------------
        qsmk | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       _cons |  -1.031787   .0562947   -18.33   0.000    -1.142122   -.9214511
------------------------------------------------------------------------------



Iteration 0:   log likelihood = -266.67873  
Iteration 1:   log likelihood = -238.48654  
Iteration 2:   log likelihood = -232.82848  
Iteration 3:   log likelihood = -232.68043  
Iteration 4:   log likelihood = -232.67999  
Iteration 5:   log likelihood = -232.67999  

Logistic regression                                     Number of obs =  1,629
                                                        LR chi2(19)   =  68.00
                                                        Prob &gt; chi2   = 0.0000
Log likelihood = -232.67999                             Pseudo R2     = 0.1275

-------------------------------------------------------------------------------
         cens | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
         qsmk |   .5168674   .2877162     1.80   0.072    -.0470459    1.080781
          sex |   .0573131   .3302775     0.17   0.862     -.590019    .7046452
         race |  -.0122715   .4524888    -0.03   0.978    -.8991332    .8745902
          age |  -.2697293   .1174647    -2.30   0.022    -.4999559   -.0395027
              |
  c.age#c.age |   .0028837   .0011135     2.59   0.010     .0007012    .0050661
              |
    education |
           1  |   .3823818   .5601808     0.68   0.495    -.7155523    1.480316
           2  |  -.0584066   .5749586    -0.10   0.919    -1.185305    1.068491
           3  |   .2176937   .5225008     0.42   0.677    -.8063891    1.241776
           4  |   .5208288   .6678735     0.78   0.435    -.7881792    1.829837
              |
smokeintens~y |   .0157119   .0347319     0.45   0.651    -.0523614    .0837851
              |
           c. |
smokeintens~y#|
           c. |
smokeintens~y |  -.0001133   .0006058    -0.19   0.852    -.0013007    .0010742
              |
     smokeyrs |   .0785973   .0749576     1.05   0.294    -.0683169    .2255116
              |
   c.smokeyrs#|
   c.smokeyrs |  -.0005569   .0010318    -0.54   0.589    -.0025791    .0014653
              |
     exercise |
           0  |    .583989   .3723133     1.57   0.117    -.1457317     1.31371
           1  |  -.3874824   .3439133    -1.13   0.260     -1.06154    .2865754
              |
       active |
           0  |  -.7065829   .3964577    -1.78   0.075    -1.483626    .0704599
           1  |  -.9540614   .3893181    -2.45   0.014    -1.717111   -.1910119
              |
         wt71 |  -.0878871   .0400115    -2.20   0.028    -.1663082   -.0094659
              |
c.wt71#c.wt71 |   .0006351   .0002257     2.81   0.005     .0001927    .0010775
              |
        _cons |   3.754678   2.651222     1.42   0.157    -1.441622    8.950978
-------------------------------------------------------------------------------



Iteration 0:   log likelihood = -266.67873  
Iteration 1:   log likelihood = -264.00252  
Iteration 2:   log likelihood = -263.88028  
Iteration 3:   log likelihood = -263.88009  
Iteration 4:   log likelihood = -263.88009  

Logistic regression                                     Number of obs =  1,629
                                                        LR chi2(1)    =   5.60
                                                        Prob &gt; chi2   = 0.0180
Log likelihood = -263.88009                             Pseudo R2     = 0.0105

------------------------------------------------------------------------------
        cens | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        qsmk |   .6411113   .2639262     2.43   0.015     .1238255    1.158397
       _cons |  -3.421172   .1648503   -20.75   0.000    -3.744273   -3.098071
------------------------------------------------------------------------------


(1,629 missing values generated)

(428 real changes made)

(1,201 real changes made)

(1,629 missing values generated)

(1,566 real changes made)

(63 missing values generated)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          sw |      1,566    .9962351    .2819583   .3546469   4.093113

(sum of wgt is 1,560.10419079661)

Linear regression                               Number of obs     =      1,566
                                                F(1, 1565)        =      44.19
                                                Prob &gt; F          =     0.0000
                                                R-squared         =     0.0363
                                                Root MSE          =     7.8652

                               (Std. err. adjusted for 1,566 clusters in seqn)
------------------------------------------------------------------------------
             |               Robust
     wt82_71 | Coefficient  std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        qsmk |   3.496493   .5259796     6.65   0.000     2.464794    4.528192
       _cons |    1.66199   .2328986     7.14   0.000     1.205164    2.118816
------------------------------------------------------------------------------</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="why-model-stata.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="standardization-and-the-parametric-g-formula-stata.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/remlapmot/cibookex-r/edit/master/12-ipw-msm-stata.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/remlapmot/cibookex-r/blob/master/12-ipw-msm-stata.Rmd",
"text": null
},
"download": ["cibookex-r.pdf", "cibookex-r.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
