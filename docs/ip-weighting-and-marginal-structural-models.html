<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>12. IP Weighting and Marginal Structural Models | Causal Inference: What If. R and Stata code for Exercises</title>
  <meta name="description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="12. IP Weighting and Marginal Structural Models | Causal Inference: What If. R and Stata code for Exercises" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="12. IP Weighting and Marginal Structural Models | Causal Inference: What If. R and Stata code for Exercises" />
  
  <meta name="twitter:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

<meta name="author" content="Book by M. A. Hern치n and J. M. Robins" />
<meta name="author" content="R code by Joy Shi and Sean McGrath" />
<meta name="author" content="Stata code by Eleanor Murray and Roger Logan" />
<meta name="author" content="R Markdown code by Tom Palmer" />


<meta name="date" content="2024-06-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="why-model.html"/>
<link rel="next" href="standardization-and-the-parametric-g-formula.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Table of Contents</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-code"><i class="fa fa-check"></i>Downloading the code</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#installing-dependency-packages"><i class="fa fa-check"></i>Installing dependency packages</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-datasets"><i class="fa fa-check"></i>Downloading the datasets</a></li>
</ul></li>
<li class="part"><span><b>R code</b></span></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html"><i class="fa fa-check"></i>11. Why model?</a>
<ul>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.2"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.3"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.2"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.3"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.4"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.5"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.6"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.7"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.2"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.3"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.4"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.2"><i class="fa fa-check"></i>Program 14.2</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-one-possible-value-of-psi"><i class="fa fa-check"></i>G-estimation: Checking one possible value of psi</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-multiple-possible-values-of-psi"><i class="fa fa-check"></i>G-estimation: Checking multiple possible values of psi</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.3"><i class="fa fa-check"></i>Program 14.3</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-linear-mean-models"><i class="fa fa-check"></i>G-estimation: Closed form estimator linear mean models</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-for-2-parameter-model"><i class="fa fa-check"></i>G-estimation: Closed form estimator for 2-parameter model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.2"><i class="fa fa-check"></i>Program 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.3"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.4"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html"><i class="fa fa-check"></i>16. Instrumental variables estimation</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.2"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.3"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.4"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.5"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html"><i class="fa fa-check"></i>17. Causal survival analysis</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.2"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.3"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.4"><i class="fa fa-check"></i>Program 17.4</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.5"><i class="fa fa-check"></i>Program 17.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-r.html"><a href="session-information-r.html"><i class="fa fa-check"></i>Session information: R</a></li>
<li class="part"><span><b>Stata code</b></span></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html"><i class="fa fa-check"></i>11. Why model: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.1-1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.2-1"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.3-1"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.1-1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.2-1"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.3-1"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.4-1"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.5-1"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.6-1"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.7-1"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.1-1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.2-1"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.3-1"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.4-1"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.1-1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.2-1"><i class="fa fa-check"></i>Program 14.2</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.3-1"><i class="fa fa-check"></i>Program 14.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.1-1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#prorgam-15.2"><i class="fa fa-check"></i>Prorgam 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.3-1"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.4-1"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html"><i class="fa fa-check"></i>16. Instrumental variables estimation: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.1-1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.2-1"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.3-1"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.4-1"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.5-1"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html"><i class="fa fa-check"></i>17. Causal survival analysis: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.1-1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.2-1"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.3-1"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.4-1"><i class="fa fa-check"></i>Program 17.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-stata.html"><a href="session-information-stata.html"><i class="fa fa-check"></i>Session information: Stata</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Causal Inference: What If. R and Stata code for Exercises</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ip-weighting-and-marginal-structural-models" class="section level1 unnumbered hasAnchor">
<h1>12. IP Weighting and Marginal Structural Models<a href="ip-weighting-and-marginal-structural-models.html#ip-weighting-and-marginal-structural-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="program-12.1" class="section level2 hasAnchor">
<h2>Program 12.1<a href="ip-weighting-and-marginal-structural-models.html#program-12.1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Descriptive statistics from NHEFS data (Table 12.1)</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="ip-weighting-and-marginal-structural-models.html#cb18-1" tabindex="-1"></a><span class="fu">library</span>(here)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="ip-weighting-and-marginal-structural-models.html#cb19-1" tabindex="-1"></a><span class="co"># install.packages(&quot;readxl&quot;) # install package if required</span></span>
<span id="cb19-2"><a href="ip-weighting-and-marginal-structural-models.html#cb19-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb19-3"><a href="ip-weighting-and-marginal-structural-models.html#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="ip-weighting-and-marginal-structural-models.html#cb19-4" tabindex="-1"></a>nhefs <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;NHEFS.xls&quot;</span>))</span>
<span id="cb19-5"><a href="ip-weighting-and-marginal-structural-models.html#cb19-5" tabindex="-1"></a>nhefs<span class="sc">$</span>cens <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(nhefs<span class="sc">$</span>wt82), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb19-6"><a href="ip-weighting-and-marginal-structural-models.html#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="ip-weighting-and-marginal-structural-models.html#cb19-7" tabindex="-1"></a><span class="co"># provisionally ignore subjects with missing values for weight in 1982</span></span>
<span id="cb19-8"><a href="ip-weighting-and-marginal-structural-models.html#cb19-8" tabindex="-1"></a>nhefs.nmv <span class="ot">&lt;-</span></span>
<span id="cb19-9"><a href="ip-weighting-and-marginal-structural-models.html#cb19-9" tabindex="-1"></a>  nhefs[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(nhefs<span class="sc">$</span>wt82)),]</span>
<span id="cb19-10"><a href="ip-weighting-and-marginal-structural-models.html#cb19-10" tabindex="-1"></a></span>
<span id="cb19-11"><a href="ip-weighting-and-marginal-structural-models.html#cb19-11" tabindex="-1"></a><span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk, <span class="at">data =</span> nhefs.nmv)</span>
<span id="cb19-12"><a href="ip-weighting-and-marginal-structural-models.html#cb19-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-13"><a href="ip-weighting-and-marginal-structural-models.html#cb19-13" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb19-14"><a href="ip-weighting-and-marginal-structural-models.html#cb19-14" tabindex="-1"></a><span class="co">#&gt; lm(formula = wt82_71 ~ qsmk, data = nhefs.nmv)</span></span>
<span id="cb19-15"><a href="ip-weighting-and-marginal-structural-models.html#cb19-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-16"><a href="ip-weighting-and-marginal-structural-models.html#cb19-16" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb19-17"><a href="ip-weighting-and-marginal-structural-models.html#cb19-17" tabindex="-1"></a><span class="co">#&gt; (Intercept)         qsmk  </span></span>
<span id="cb19-18"><a href="ip-weighting-and-marginal-structural-models.html#cb19-18" tabindex="-1"></a><span class="co">#&gt;       1.984        2.541</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="ip-weighting-and-marginal-structural-models.html#cb20-1" tabindex="-1"></a><span class="co"># Smoking cessation</span></span>
<span id="cb20-2"><a href="ip-weighting-and-marginal-structural-models.html#cb20-2" tabindex="-1"></a><span class="fu">predict</span>(<span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk, <span class="at">data =</span> nhefs.nmv), <span class="fu">data.frame</span>(<span class="at">qsmk =</span> <span class="dv">1</span>))</span>
<span id="cb20-3"><a href="ip-weighting-and-marginal-structural-models.html#cb20-3" tabindex="-1"></a><span class="co">#&gt;        1 </span></span>
<span id="cb20-4"><a href="ip-weighting-and-marginal-structural-models.html#cb20-4" tabindex="-1"></a><span class="co">#&gt; 4.525079</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="ip-weighting-and-marginal-structural-models.html#cb21-1" tabindex="-1"></a><span class="co"># No smoking cessation</span></span>
<span id="cb21-2"><a href="ip-weighting-and-marginal-structural-models.html#cb21-2" tabindex="-1"></a><span class="fu">predict</span>(<span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk, <span class="at">data =</span> nhefs.nmv), <span class="fu">data.frame</span>(<span class="at">qsmk =</span> <span class="dv">0</span>))</span>
<span id="cb21-3"><a href="ip-weighting-and-marginal-structural-models.html#cb21-3" tabindex="-1"></a><span class="co">#&gt;        1 </span></span>
<span id="cb21-4"><a href="ip-weighting-and-marginal-structural-models.html#cb21-4" tabindex="-1"></a><span class="co">#&gt; 1.984498</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="ip-weighting-and-marginal-structural-models.html#cb22-1" tabindex="-1"></a></span>
<span id="cb22-2"><a href="ip-weighting-and-marginal-structural-models.html#cb22-2" tabindex="-1"></a><span class="co"># Table</span></span>
<span id="cb22-3"><a href="ip-weighting-and-marginal-structural-models.html#cb22-3" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>age)</span>
<span id="cb22-4"><a href="ip-weighting-and-marginal-structural-models.html#cb22-4" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb22-5"><a href="ip-weighting-and-marginal-structural-models.html#cb22-5" tabindex="-1"></a><span class="co">#&gt;   25.00   33.00   42.00   42.79   51.00   72.00</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="ip-weighting-and-marginal-structural-models.html#cb23-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>wt71)</span>
<span id="cb23-2"><a href="ip-weighting-and-marginal-structural-models.html#cb23-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb23-3"><a href="ip-weighting-and-marginal-structural-models.html#cb23-3" tabindex="-1"></a><span class="co">#&gt;   40.82   59.19   68.49   70.30   79.38  151.73</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="ip-weighting-and-marginal-structural-models.html#cb24-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>smokeintensity)</span>
<span id="cb24-2"><a href="ip-weighting-and-marginal-structural-models.html#cb24-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb24-3"><a href="ip-weighting-and-marginal-structural-models.html#cb24-3" tabindex="-1"></a><span class="co">#&gt;    1.00   15.00   20.00   21.19   30.00   60.00</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="ip-weighting-and-marginal-structural-models.html#cb25-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>smokeyrs)</span>
<span id="cb25-2"><a href="ip-weighting-and-marginal-structural-models.html#cb25-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb25-3"><a href="ip-weighting-and-marginal-structural-models.html#cb25-3" tabindex="-1"></a><span class="co">#&gt;    1.00   15.00   23.00   24.09   32.00   64.00</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="ip-weighting-and-marginal-structural-models.html#cb26-1" tabindex="-1"></a></span>
<span id="cb26-2"><a href="ip-weighting-and-marginal-structural-models.html#cb26-2" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>age)</span>
<span id="cb26-3"><a href="ip-weighting-and-marginal-structural-models.html#cb26-3" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb26-4"><a href="ip-weighting-and-marginal-structural-models.html#cb26-4" tabindex="-1"></a><span class="co">#&gt;   25.00   35.00   46.00   46.17   56.00   74.00</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="ip-weighting-and-marginal-structural-models.html#cb27-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>wt71)</span>
<span id="cb27-2"><a href="ip-weighting-and-marginal-structural-models.html#cb27-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb27-3"><a href="ip-weighting-and-marginal-structural-models.html#cb27-3" tabindex="-1"></a><span class="co">#&gt;   39.58   60.67   71.21   72.35   81.08  136.98</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="ip-weighting-and-marginal-structural-models.html#cb28-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>smokeintensity)</span>
<span id="cb28-2"><a href="ip-weighting-and-marginal-structural-models.html#cb28-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb28-3"><a href="ip-weighting-and-marginal-structural-models.html#cb28-3" tabindex="-1"></a><span class="co">#&gt;     1.0    10.0    20.0    18.6    25.0    80.0</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="ip-weighting-and-marginal-structural-models.html#cb29-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>smokeyrs)</span>
<span id="cb29-2"><a href="ip-weighting-and-marginal-structural-models.html#cb29-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb29-3"><a href="ip-weighting-and-marginal-structural-models.html#cb29-3" tabindex="-1"></a><span class="co">#&gt;    1.00   15.00   26.00   26.03   35.00   60.00</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="ip-weighting-and-marginal-structural-models.html#cb30-1" tabindex="-1"></a></span>
<span id="cb30-2"><a href="ip-weighting-and-marginal-structural-models.html#cb30-2" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>sex)</span>
<span id="cb30-3"><a href="ip-weighting-and-marginal-structural-models.html#cb30-3" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb30-4"><a href="ip-weighting-and-marginal-structural-models.html#cb30-4" tabindex="-1"></a><span class="co">#&gt;       0   1</span></span>
<span id="cb30-5"><a href="ip-weighting-and-marginal-structural-models.html#cb30-5" tabindex="-1"></a><span class="co">#&gt;   0 542 621</span></span>
<span id="cb30-6"><a href="ip-weighting-and-marginal-structural-models.html#cb30-6" tabindex="-1"></a><span class="co">#&gt;   1 220 183</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="ip-weighting-and-marginal-structural-models.html#cb31-1" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>sex), <span class="dv">1</span>)</span>
<span id="cb31-2"><a href="ip-weighting-and-marginal-structural-models.html#cb31-2" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb31-3"><a href="ip-weighting-and-marginal-structural-models.html#cb31-3" tabindex="-1"></a><span class="co">#&gt;             0         1</span></span>
<span id="cb31-4"><a href="ip-weighting-and-marginal-structural-models.html#cb31-4" tabindex="-1"></a><span class="co">#&gt;   0 0.4660361 0.5339639</span></span>
<span id="cb31-5"><a href="ip-weighting-and-marginal-structural-models.html#cb31-5" tabindex="-1"></a><span class="co">#&gt;   1 0.5459057 0.4540943</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="ip-weighting-and-marginal-structural-models.html#cb32-1" tabindex="-1"></a></span>
<span id="cb32-2"><a href="ip-weighting-and-marginal-structural-models.html#cb32-2" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>race)</span>
<span id="cb32-3"><a href="ip-weighting-and-marginal-structural-models.html#cb32-3" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb32-4"><a href="ip-weighting-and-marginal-structural-models.html#cb32-4" tabindex="-1"></a><span class="co">#&gt;       0   1</span></span>
<span id="cb32-5"><a href="ip-weighting-and-marginal-structural-models.html#cb32-5" tabindex="-1"></a><span class="co">#&gt;   0 993 170</span></span>
<span id="cb32-6"><a href="ip-weighting-and-marginal-structural-models.html#cb32-6" tabindex="-1"></a><span class="co">#&gt;   1 367  36</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="ip-weighting-and-marginal-structural-models.html#cb33-1" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>race), <span class="dv">1</span>)</span>
<span id="cb33-2"><a href="ip-weighting-and-marginal-structural-models.html#cb33-2" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb33-3"><a href="ip-weighting-and-marginal-structural-models.html#cb33-3" tabindex="-1"></a><span class="co">#&gt;              0          1</span></span>
<span id="cb33-4"><a href="ip-weighting-and-marginal-structural-models.html#cb33-4" tabindex="-1"></a><span class="co">#&gt;   0 0.85382631 0.14617369</span></span>
<span id="cb33-5"><a href="ip-weighting-and-marginal-structural-models.html#cb33-5" tabindex="-1"></a><span class="co">#&gt;   1 0.91066998 0.08933002</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="ip-weighting-and-marginal-structural-models.html#cb34-1" tabindex="-1"></a></span>
<span id="cb34-2"><a href="ip-weighting-and-marginal-structural-models.html#cb34-2" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>education)</span>
<span id="cb34-3"><a href="ip-weighting-and-marginal-structural-models.html#cb34-3" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb34-4"><a href="ip-weighting-and-marginal-structural-models.html#cb34-4" tabindex="-1"></a><span class="co">#&gt;       1   2   3   4   5</span></span>
<span id="cb34-5"><a href="ip-weighting-and-marginal-structural-models.html#cb34-5" tabindex="-1"></a><span class="co">#&gt;   0 210 266 480  92 115</span></span>
<span id="cb34-6"><a href="ip-weighting-and-marginal-structural-models.html#cb34-6" tabindex="-1"></a><span class="co">#&gt;   1  81  74 157  29  62</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="ip-weighting-and-marginal-structural-models.html#cb35-1" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>education), <span class="dv">1</span>)</span>
<span id="cb35-2"><a href="ip-weighting-and-marginal-structural-models.html#cb35-2" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb35-3"><a href="ip-weighting-and-marginal-structural-models.html#cb35-3" tabindex="-1"></a><span class="co">#&gt;              1          2          3          4          5</span></span>
<span id="cb35-4"><a href="ip-weighting-and-marginal-structural-models.html#cb35-4" tabindex="-1"></a><span class="co">#&gt;   0 0.18056750 0.22871883 0.41272571 0.07910576 0.09888220</span></span>
<span id="cb35-5"><a href="ip-weighting-and-marginal-structural-models.html#cb35-5" tabindex="-1"></a><span class="co">#&gt;   1 0.20099256 0.18362283 0.38957816 0.07196030 0.15384615</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="ip-weighting-and-marginal-structural-models.html#cb36-1" tabindex="-1"></a></span>
<span id="cb36-2"><a href="ip-weighting-and-marginal-structural-models.html#cb36-2" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>exercise)</span>
<span id="cb36-3"><a href="ip-weighting-and-marginal-structural-models.html#cb36-3" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb36-4"><a href="ip-weighting-and-marginal-structural-models.html#cb36-4" tabindex="-1"></a><span class="co">#&gt;       0   1   2</span></span>
<span id="cb36-5"><a href="ip-weighting-and-marginal-structural-models.html#cb36-5" tabindex="-1"></a><span class="co">#&gt;   0 237 485 441</span></span>
<span id="cb36-6"><a href="ip-weighting-and-marginal-structural-models.html#cb36-6" tabindex="-1"></a><span class="co">#&gt;   1  63 176 164</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="ip-weighting-and-marginal-structural-models.html#cb37-1" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>exercise), <span class="dv">1</span>)</span>
<span id="cb37-2"><a href="ip-weighting-and-marginal-structural-models.html#cb37-2" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb37-3"><a href="ip-weighting-and-marginal-structural-models.html#cb37-3" tabindex="-1"></a><span class="co">#&gt;             0         1         2</span></span>
<span id="cb37-4"><a href="ip-weighting-and-marginal-structural-models.html#cb37-4" tabindex="-1"></a><span class="co">#&gt;   0 0.2037833 0.4170249 0.3791917</span></span>
<span id="cb37-5"><a href="ip-weighting-and-marginal-structural-models.html#cb37-5" tabindex="-1"></a><span class="co">#&gt;   1 0.1563275 0.4367246 0.4069479</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="ip-weighting-and-marginal-structural-models.html#cb38-1" tabindex="-1"></a></span>
<span id="cb38-2"><a href="ip-weighting-and-marginal-structural-models.html#cb38-2" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>active)</span>
<span id="cb38-3"><a href="ip-weighting-and-marginal-structural-models.html#cb38-3" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb38-4"><a href="ip-weighting-and-marginal-structural-models.html#cb38-4" tabindex="-1"></a><span class="co">#&gt;       0   1   2</span></span>
<span id="cb38-5"><a href="ip-weighting-and-marginal-structural-models.html#cb38-5" tabindex="-1"></a><span class="co">#&gt;   0 532 527 104</span></span>
<span id="cb38-6"><a href="ip-weighting-and-marginal-structural-models.html#cb38-6" tabindex="-1"></a><span class="co">#&gt;   1 170 188  45</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="ip-weighting-and-marginal-structural-models.html#cb39-1" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>active), <span class="dv">1</span>)</span>
<span id="cb39-2"><a href="ip-weighting-and-marginal-structural-models.html#cb39-2" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb39-3"><a href="ip-weighting-and-marginal-structural-models.html#cb39-3" tabindex="-1"></a><span class="co">#&gt;             0         1         2</span></span>
<span id="cb39-4"><a href="ip-weighting-and-marginal-structural-models.html#cb39-4" tabindex="-1"></a><span class="co">#&gt;   0 0.4574377 0.4531384 0.0894239</span></span>
<span id="cb39-5"><a href="ip-weighting-and-marginal-structural-models.html#cb39-5" tabindex="-1"></a><span class="co">#&gt;   1 0.4218362 0.4665012 0.1116625</span></span></code></pre></div>
</div>
<div id="program-12.2" class="section level2 hasAnchor">
<h2>Program 12.2<a href="ip-weighting-and-marginal-structural-models.html#program-12.2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating IP weights</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="ip-weighting-and-marginal-structural-models.html#cb40-1" tabindex="-1"></a><span class="co"># Estimation of ip weights via a logistic model</span></span>
<span id="cb40-2"><a href="ip-weighting-and-marginal-structural-models.html#cb40-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb40-3"><a href="ip-weighting-and-marginal-structural-models.html#cb40-3" tabindex="-1"></a>  qsmk <span class="sc">~</span> sex <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb40-4"><a href="ip-weighting-and-marginal-structural-models.html#cb40-4" tabindex="-1"></a>    <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb40-5"><a href="ip-weighting-and-marginal-structural-models.html#cb40-5" tabindex="-1"></a>    <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb40-6"><a href="ip-weighting-and-marginal-structural-models.html#cb40-6" tabindex="-1"></a>    <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb40-7"><a href="ip-weighting-and-marginal-structural-models.html#cb40-7" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb40-8"><a href="ip-weighting-and-marginal-structural-models.html#cb40-8" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv</span>
<span id="cb40-9"><a href="ip-weighting-and-marginal-structural-models.html#cb40-9" tabindex="-1"></a>)</span>
<span id="cb40-10"><a href="ip-weighting-and-marginal-structural-models.html#cb40-10" tabindex="-1"></a><span class="fu">summary</span>(fit)</span>
<span id="cb40-11"><a href="ip-weighting-and-marginal-structural-models.html#cb40-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-12"><a href="ip-weighting-and-marginal-structural-models.html#cb40-12" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb40-13"><a href="ip-weighting-and-marginal-structural-models.html#cb40-13" tabindex="-1"></a><span class="co">#&gt; glm(formula = qsmk ~ sex + race + age + I(age^2) + as.factor(education) + </span></span>
<span id="cb40-14"><a href="ip-weighting-and-marginal-structural-models.html#cb40-14" tabindex="-1"></a><span class="co">#&gt;     smokeintensity + I(smokeintensity^2) + smokeyrs + I(smokeyrs^2) + </span></span>
<span id="cb40-15"><a href="ip-weighting-and-marginal-structural-models.html#cb40-15" tabindex="-1"></a><span class="co">#&gt;     as.factor(exercise) + as.factor(active) + wt71 + I(wt71^2), </span></span>
<span id="cb40-16"><a href="ip-weighting-and-marginal-structural-models.html#cb40-16" tabindex="-1"></a><span class="co">#&gt;     family = binomial(), data = nhefs.nmv)</span></span>
<span id="cb40-17"><a href="ip-weighting-and-marginal-structural-models.html#cb40-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-18"><a href="ip-weighting-and-marginal-structural-models.html#cb40-18" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb40-19"><a href="ip-weighting-and-marginal-structural-models.html#cb40-19" tabindex="-1"></a><span class="co">#&gt;                         Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb40-20"><a href="ip-weighting-and-marginal-structural-models.html#cb40-20" tabindex="-1"></a><span class="co">#&gt; (Intercept)           -2.2425191  1.3808360  -1.624 0.104369    </span></span>
<span id="cb40-21"><a href="ip-weighting-and-marginal-structural-models.html#cb40-21" tabindex="-1"></a><span class="co">#&gt; sex                   -0.5274782  0.1540496  -3.424 0.000617 ***</span></span>
<span id="cb40-22"><a href="ip-weighting-and-marginal-structural-models.html#cb40-22" tabindex="-1"></a><span class="co">#&gt; race                  -0.8392636  0.2100665  -3.995 6.46e-05 ***</span></span>
<span id="cb40-23"><a href="ip-weighting-and-marginal-structural-models.html#cb40-23" tabindex="-1"></a><span class="co">#&gt; age                    0.1212052  0.0512663   2.364 0.018068 *  </span></span>
<span id="cb40-24"><a href="ip-weighting-and-marginal-structural-models.html#cb40-24" tabindex="-1"></a><span class="co">#&gt; I(age^2)              -0.0008246  0.0005361  -1.538 0.124039    </span></span>
<span id="cb40-25"><a href="ip-weighting-and-marginal-structural-models.html#cb40-25" tabindex="-1"></a><span class="co">#&gt; as.factor(education)2 -0.0287755  0.1983506  -0.145 0.884653    </span></span>
<span id="cb40-26"><a href="ip-weighting-and-marginal-structural-models.html#cb40-26" tabindex="-1"></a><span class="co">#&gt; as.factor(education)3  0.0864318  0.1780850   0.485 0.627435    </span></span>
<span id="cb40-27"><a href="ip-weighting-and-marginal-structural-models.html#cb40-27" tabindex="-1"></a><span class="co">#&gt; as.factor(education)4  0.0636010  0.2732108   0.233 0.815924    </span></span>
<span id="cb40-28"><a href="ip-weighting-and-marginal-structural-models.html#cb40-28" tabindex="-1"></a><span class="co">#&gt; as.factor(education)5  0.4759606  0.2262237   2.104 0.035384 *  </span></span>
<span id="cb40-29"><a href="ip-weighting-and-marginal-structural-models.html#cb40-29" tabindex="-1"></a><span class="co">#&gt; smokeintensity        -0.0772704  0.0152499  -5.067 4.04e-07 ***</span></span>
<span id="cb40-30"><a href="ip-weighting-and-marginal-structural-models.html#cb40-30" tabindex="-1"></a><span class="co">#&gt; I(smokeintensity^2)    0.0010451  0.0002866   3.647 0.000265 ***</span></span>
<span id="cb40-31"><a href="ip-weighting-and-marginal-structural-models.html#cb40-31" tabindex="-1"></a><span class="co">#&gt; smokeyrs              -0.0735966  0.0277775  -2.650 0.008061 ** </span></span>
<span id="cb40-32"><a href="ip-weighting-and-marginal-structural-models.html#cb40-32" tabindex="-1"></a><span class="co">#&gt; I(smokeyrs^2)          0.0008441  0.0004632   1.822 0.068398 .  </span></span>
<span id="cb40-33"><a href="ip-weighting-and-marginal-structural-models.html#cb40-33" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)1   0.3548405  0.1801351   1.970 0.048855 *  </span></span>
<span id="cb40-34"><a href="ip-weighting-and-marginal-structural-models.html#cb40-34" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)2   0.3957040  0.1872400   2.113 0.034571 *  </span></span>
<span id="cb40-35"><a href="ip-weighting-and-marginal-structural-models.html#cb40-35" tabindex="-1"></a><span class="co">#&gt; as.factor(active)1     0.0319445  0.1329372   0.240 0.810100    </span></span>
<span id="cb40-36"><a href="ip-weighting-and-marginal-structural-models.html#cb40-36" tabindex="-1"></a><span class="co">#&gt; as.factor(active)2     0.1767840  0.2149720   0.822 0.410873    </span></span>
<span id="cb40-37"><a href="ip-weighting-and-marginal-structural-models.html#cb40-37" tabindex="-1"></a><span class="co">#&gt; wt71                  -0.0152357  0.0263161  -0.579 0.562625    </span></span>
<span id="cb40-38"><a href="ip-weighting-and-marginal-structural-models.html#cb40-38" tabindex="-1"></a><span class="co">#&gt; I(wt71^2)              0.0001352  0.0001632   0.829 0.407370    </span></span>
<span id="cb40-39"><a href="ip-weighting-and-marginal-structural-models.html#cb40-39" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb40-40"><a href="ip-weighting-and-marginal-structural-models.html#cb40-40" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb40-41"><a href="ip-weighting-and-marginal-structural-models.html#cb40-41" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-42"><a href="ip-weighting-and-marginal-structural-models.html#cb40-42" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb40-43"><a href="ip-weighting-and-marginal-structural-models.html#cb40-43" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-44"><a href="ip-weighting-and-marginal-structural-models.html#cb40-44" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 1786.1  on 1565  degrees of freedom</span></span>
<span id="cb40-45"><a href="ip-weighting-and-marginal-structural-models.html#cb40-45" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 1676.9  on 1547  degrees of freedom</span></span>
<span id="cb40-46"><a href="ip-weighting-and-marginal-structural-models.html#cb40-46" tabindex="-1"></a><span class="co">#&gt; AIC: 1714.9</span></span>
<span id="cb40-47"><a href="ip-weighting-and-marginal-structural-models.html#cb40-47" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-48"><a href="ip-weighting-and-marginal-structural-models.html#cb40-48" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="ip-weighting-and-marginal-structural-models.html#cb41-1" tabindex="-1"></a></span>
<span id="cb41-2"><a href="ip-weighting-and-marginal-structural-models.html#cb41-2" tabindex="-1"></a>p.qsmk.obs <span class="ot">&lt;-</span></span>
<span id="cb41-3"><a href="ip-weighting-and-marginal-structural-models.html#cb41-3" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb41-4"><a href="ip-weighting-and-marginal-structural-models.html#cb41-4" tabindex="-1"></a>         <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>),</span>
<span id="cb41-5"><a href="ip-weighting-and-marginal-structural-models.html#cb41-5" tabindex="-1"></a>         <span class="fu">predict</span>(fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb41-6"><a href="ip-weighting-and-marginal-structural-models.html#cb41-6" tabindex="-1"></a></span>
<span id="cb41-7"><a href="ip-weighting-and-marginal-structural-models.html#cb41-7" tabindex="-1"></a>nhefs.nmv<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> p.qsmk.obs</span>
<span id="cb41-8"><a href="ip-weighting-and-marginal-structural-models.html#cb41-8" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv<span class="sc">$</span>w)</span>
<span id="cb41-9"><a href="ip-weighting-and-marginal-structural-models.html#cb41-9" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb41-10"><a href="ip-weighting-and-marginal-structural-models.html#cb41-10" tabindex="-1"></a><span class="co">#&gt;   1.054   1.230   1.373   1.996   1.990  16.700</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="ip-weighting-and-marginal-structural-models.html#cb42-1" tabindex="-1"></a><span class="fu">sd</span>(nhefs.nmv<span class="sc">$</span>w)</span>
<span id="cb42-2"><a href="ip-weighting-and-marginal-structural-models.html#cb42-2" tabindex="-1"></a><span class="co">#&gt; [1] 1.474787</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="ip-weighting-and-marginal-structural-models.html#cb43-1" tabindex="-1"></a></span>
<span id="cb43-2"><a href="ip-weighting-and-marginal-structural-models.html#cb43-2" tabindex="-1"></a><span class="co"># install.packages(&quot;geepack&quot;) # install package if required</span></span>
<span id="cb43-3"><a href="ip-weighting-and-marginal-structural-models.html#cb43-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;geepack&quot;</span>)</span>
<span id="cb43-4"><a href="ip-weighting-and-marginal-structural-models.html#cb43-4" tabindex="-1"></a>msm.w <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb43-5"><a href="ip-weighting-and-marginal-structural-models.html#cb43-5" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> qsmk,</span>
<span id="cb43-6"><a href="ip-weighting-and-marginal-structural-models.html#cb43-6" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb43-7"><a href="ip-weighting-and-marginal-structural-models.html#cb43-7" tabindex="-1"></a>  <span class="at">weights =</span> w,</span>
<span id="cb43-8"><a href="ip-weighting-and-marginal-structural-models.html#cb43-8" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb43-9"><a href="ip-weighting-and-marginal-structural-models.html#cb43-9" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb43-10"><a href="ip-weighting-and-marginal-structural-models.html#cb43-10" tabindex="-1"></a>)</span>
<span id="cb43-11"><a href="ip-weighting-and-marginal-structural-models.html#cb43-11" tabindex="-1"></a><span class="fu">summary</span>(msm.w)</span>
<span id="cb43-12"><a href="ip-weighting-and-marginal-structural-models.html#cb43-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb43-13"><a href="ip-weighting-and-marginal-structural-models.html#cb43-13" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb43-14"><a href="ip-weighting-and-marginal-structural-models.html#cb43-14" tabindex="-1"></a><span class="co">#&gt; geeglm(formula = wt82_71 ~ qsmk, data = nhefs.nmv, weights = w, </span></span>
<span id="cb43-15"><a href="ip-weighting-and-marginal-structural-models.html#cb43-15" tabindex="-1"></a><span class="co">#&gt;     id = seqn, corstr = &quot;independence&quot;)</span></span>
<span id="cb43-16"><a href="ip-weighting-and-marginal-structural-models.html#cb43-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb43-17"><a href="ip-weighting-and-marginal-structural-models.html#cb43-17" tabindex="-1"></a><span class="co">#&gt;  Coefficients:</span></span>
<span id="cb43-18"><a href="ip-weighting-and-marginal-structural-models.html#cb43-18" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err  Wald Pr(&gt;|W|)    </span></span>
<span id="cb43-19"><a href="ip-weighting-and-marginal-structural-models.html#cb43-19" tabindex="-1"></a><span class="co">#&gt; (Intercept)   1.7800  0.2247 62.73 2.33e-15 ***</span></span>
<span id="cb43-20"><a href="ip-weighting-and-marginal-structural-models.html#cb43-20" tabindex="-1"></a><span class="co">#&gt; qsmk          3.4405  0.5255 42.87 5.86e-11 ***</span></span>
<span id="cb43-21"><a href="ip-weighting-and-marginal-structural-models.html#cb43-21" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb43-22"><a href="ip-weighting-and-marginal-structural-models.html#cb43-22" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb43-23"><a href="ip-weighting-and-marginal-structural-models.html#cb43-23" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb43-24"><a href="ip-weighting-and-marginal-structural-models.html#cb43-24" tabindex="-1"></a><span class="co">#&gt; Correlation structure = independence </span></span>
<span id="cb43-25"><a href="ip-weighting-and-marginal-structural-models.html#cb43-25" tabindex="-1"></a><span class="co">#&gt; Estimated Scale Parameters:</span></span>
<span id="cb43-26"><a href="ip-weighting-and-marginal-structural-models.html#cb43-26" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb43-27"><a href="ip-weighting-and-marginal-structural-models.html#cb43-27" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err</span></span>
<span id="cb43-28"><a href="ip-weighting-and-marginal-structural-models.html#cb43-28" tabindex="-1"></a><span class="co">#&gt; (Intercept)    65.06   4.221</span></span>
<span id="cb43-29"><a href="ip-weighting-and-marginal-structural-models.html#cb43-29" tabindex="-1"></a><span class="co">#&gt; Number of clusters:   1566  Maximum cluster size: 1</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="ip-weighting-and-marginal-structural-models.html#cb44-1" tabindex="-1"></a></span>
<span id="cb44-2"><a href="ip-weighting-and-marginal-structural-models.html#cb44-2" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.w)</span>
<span id="cb44-3"><a href="ip-weighting-and-marginal-structural-models.html#cb44-3" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.w))[, <span class="dv">2</span>]</span>
<span id="cb44-4"><a href="ip-weighting-and-marginal-structural-models.html#cb44-4" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb44-5"><a href="ip-weighting-and-marginal-structural-models.html#cb44-5" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb44-6"><a href="ip-weighting-and-marginal-structural-models.html#cb44-6" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span>
<span id="cb44-7"><a href="ip-weighting-and-marginal-structural-models.html#cb44-7" tabindex="-1"></a><span class="co">#&gt;              beta   lcl  ucl</span></span>
<span id="cb44-8"><a href="ip-weighting-and-marginal-structural-models.html#cb44-8" tabindex="-1"></a><span class="co">#&gt; (Intercept) 1.780 1.340 2.22</span></span>
<span id="cb44-9"><a href="ip-weighting-and-marginal-structural-models.html#cb44-9" tabindex="-1"></a><span class="co">#&gt; qsmk        3.441 2.411 4.47</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="ip-weighting-and-marginal-structural-models.html#cb45-1" tabindex="-1"></a></span>
<span id="cb45-2"><a href="ip-weighting-and-marginal-structural-models.html#cb45-2" tabindex="-1"></a><span class="co"># no association between sex and qsmk in pseudo-population</span></span>
<span id="cb45-3"><a href="ip-weighting-and-marginal-structural-models.html#cb45-3" tabindex="-1"></a><span class="fu">xtabs</span>(nhefs.nmv<span class="sc">$</span>w <span class="sc">~</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">+</span> nhefs.nmv<span class="sc">$</span>qsmk)</span>
<span id="cb45-4"><a href="ip-weighting-and-marginal-structural-models.html#cb45-4" tabindex="-1"></a><span class="co">#&gt;              nhefs.nmv$qsmk</span></span>
<span id="cb45-5"><a href="ip-weighting-and-marginal-structural-models.html#cb45-5" tabindex="-1"></a><span class="co">#&gt; nhefs.nmv$sex     0     1</span></span>
<span id="cb45-6"><a href="ip-weighting-and-marginal-structural-models.html#cb45-6" tabindex="-1"></a><span class="co">#&gt;             0 763.6 763.6</span></span>
<span id="cb45-7"><a href="ip-weighting-and-marginal-structural-models.html#cb45-7" tabindex="-1"></a><span class="co">#&gt;             1 801.7 797.2</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="ip-weighting-and-marginal-structural-models.html#cb46-1" tabindex="-1"></a></span>
<span id="cb46-2"><a href="ip-weighting-and-marginal-structural-models.html#cb46-2" tabindex="-1"></a><span class="co"># &quot;check&quot; for positivity (White women)</span></span>
<span id="cb46-3"><a href="ip-weighting-and-marginal-structural-models.html#cb46-3" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>age[nhefs.nmv<span class="sc">$</span>race <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb46-4"><a href="ip-weighting-and-marginal-structural-models.html#cb46-4" tabindex="-1"></a>      nhefs.nmv<span class="sc">$</span>qsmk[nhefs.nmv<span class="sc">$</span>race <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb46-5"><a href="ip-weighting-and-marginal-structural-models.html#cb46-5" tabindex="-1"></a><span class="co">#&gt;     </span></span>
<span id="cb46-6"><a href="ip-weighting-and-marginal-structural-models.html#cb46-6" tabindex="-1"></a><span class="co">#&gt;       0  1</span></span>
<span id="cb46-7"><a href="ip-weighting-and-marginal-structural-models.html#cb46-7" tabindex="-1"></a><span class="co">#&gt;   25 24  3</span></span>
<span id="cb46-8"><a href="ip-weighting-and-marginal-structural-models.html#cb46-8" tabindex="-1"></a><span class="co">#&gt;   26 14  5</span></span>
<span id="cb46-9"><a href="ip-weighting-and-marginal-structural-models.html#cb46-9" tabindex="-1"></a><span class="co">#&gt;   27 18  2</span></span>
<span id="cb46-10"><a href="ip-weighting-and-marginal-structural-models.html#cb46-10" tabindex="-1"></a><span class="co">#&gt;   28 20  5</span></span>
<span id="cb46-11"><a href="ip-weighting-and-marginal-structural-models.html#cb46-11" tabindex="-1"></a><span class="co">#&gt;   29 15  4</span></span>
<span id="cb46-12"><a href="ip-weighting-and-marginal-structural-models.html#cb46-12" tabindex="-1"></a><span class="co">#&gt;   30 14  5</span></span>
<span id="cb46-13"><a href="ip-weighting-and-marginal-structural-models.html#cb46-13" tabindex="-1"></a><span class="co">#&gt;   31 11  5</span></span>
<span id="cb46-14"><a href="ip-weighting-and-marginal-structural-models.html#cb46-14" tabindex="-1"></a><span class="co">#&gt;   32 14  7</span></span>
<span id="cb46-15"><a href="ip-weighting-and-marginal-structural-models.html#cb46-15" tabindex="-1"></a><span class="co">#&gt;   33 12  3</span></span>
<span id="cb46-16"><a href="ip-weighting-and-marginal-structural-models.html#cb46-16" tabindex="-1"></a><span class="co">#&gt;   34 22  5</span></span>
<span id="cb46-17"><a href="ip-weighting-and-marginal-structural-models.html#cb46-17" tabindex="-1"></a><span class="co">#&gt;   35 16  5</span></span>
<span id="cb46-18"><a href="ip-weighting-and-marginal-structural-models.html#cb46-18" tabindex="-1"></a><span class="co">#&gt;   36 13  3</span></span>
<span id="cb46-19"><a href="ip-weighting-and-marginal-structural-models.html#cb46-19" tabindex="-1"></a><span class="co">#&gt;   37 14  1</span></span>
<span id="cb46-20"><a href="ip-weighting-and-marginal-structural-models.html#cb46-20" tabindex="-1"></a><span class="co">#&gt;   38  6  2</span></span>
<span id="cb46-21"><a href="ip-weighting-and-marginal-structural-models.html#cb46-21" tabindex="-1"></a><span class="co">#&gt;   39 19  4</span></span>
<span id="cb46-22"><a href="ip-weighting-and-marginal-structural-models.html#cb46-22" tabindex="-1"></a><span class="co">#&gt;   40 10  4</span></span>
<span id="cb46-23"><a href="ip-weighting-and-marginal-structural-models.html#cb46-23" tabindex="-1"></a><span class="co">#&gt;   41 13  3</span></span>
<span id="cb46-24"><a href="ip-weighting-and-marginal-structural-models.html#cb46-24" tabindex="-1"></a><span class="co">#&gt;   42 16  3</span></span>
<span id="cb46-25"><a href="ip-weighting-and-marginal-structural-models.html#cb46-25" tabindex="-1"></a><span class="co">#&gt;   43 14  3</span></span>
<span id="cb46-26"><a href="ip-weighting-and-marginal-structural-models.html#cb46-26" tabindex="-1"></a><span class="co">#&gt;   44  9  4</span></span>
<span id="cb46-27"><a href="ip-weighting-and-marginal-structural-models.html#cb46-27" tabindex="-1"></a><span class="co">#&gt;   45 12  5</span></span>
<span id="cb46-28"><a href="ip-weighting-and-marginal-structural-models.html#cb46-28" tabindex="-1"></a><span class="co">#&gt;   46 19  4</span></span>
<span id="cb46-29"><a href="ip-weighting-and-marginal-structural-models.html#cb46-29" tabindex="-1"></a><span class="co">#&gt;   47 19  4</span></span>
<span id="cb46-30"><a href="ip-weighting-and-marginal-structural-models.html#cb46-30" tabindex="-1"></a><span class="co">#&gt;   48 19  4</span></span>
<span id="cb46-31"><a href="ip-weighting-and-marginal-structural-models.html#cb46-31" tabindex="-1"></a><span class="co">#&gt;   49 11  3</span></span>
<span id="cb46-32"><a href="ip-weighting-and-marginal-structural-models.html#cb46-32" tabindex="-1"></a><span class="co">#&gt;   50 18  4</span></span>
<span id="cb46-33"><a href="ip-weighting-and-marginal-structural-models.html#cb46-33" tabindex="-1"></a><span class="co">#&gt;   51  9  3</span></span>
<span id="cb46-34"><a href="ip-weighting-and-marginal-structural-models.html#cb46-34" tabindex="-1"></a><span class="co">#&gt;   52 11  3</span></span>
<span id="cb46-35"><a href="ip-weighting-and-marginal-structural-models.html#cb46-35" tabindex="-1"></a><span class="co">#&gt;   53 11  4</span></span>
<span id="cb46-36"><a href="ip-weighting-and-marginal-structural-models.html#cb46-36" tabindex="-1"></a><span class="co">#&gt;   54 17  9</span></span>
<span id="cb46-37"><a href="ip-weighting-and-marginal-structural-models.html#cb46-37" tabindex="-1"></a><span class="co">#&gt;   55  9  4</span></span>
<span id="cb46-38"><a href="ip-weighting-and-marginal-structural-models.html#cb46-38" tabindex="-1"></a><span class="co">#&gt;   56  8  7</span></span>
<span id="cb46-39"><a href="ip-weighting-and-marginal-structural-models.html#cb46-39" tabindex="-1"></a><span class="co">#&gt;   57  9  2</span></span>
<span id="cb46-40"><a href="ip-weighting-and-marginal-structural-models.html#cb46-40" tabindex="-1"></a><span class="co">#&gt;   58  8  4</span></span>
<span id="cb46-41"><a href="ip-weighting-and-marginal-structural-models.html#cb46-41" tabindex="-1"></a><span class="co">#&gt;   59  5  4</span></span>
<span id="cb46-42"><a href="ip-weighting-and-marginal-structural-models.html#cb46-42" tabindex="-1"></a><span class="co">#&gt;   60  5  4</span></span>
<span id="cb46-43"><a href="ip-weighting-and-marginal-structural-models.html#cb46-43" tabindex="-1"></a><span class="co">#&gt;   61  5  2</span></span>
<span id="cb46-44"><a href="ip-weighting-and-marginal-structural-models.html#cb46-44" tabindex="-1"></a><span class="co">#&gt;   62  6  5</span></span>
<span id="cb46-45"><a href="ip-weighting-and-marginal-structural-models.html#cb46-45" tabindex="-1"></a><span class="co">#&gt;   63  3  3</span></span>
<span id="cb46-46"><a href="ip-weighting-and-marginal-structural-models.html#cb46-46" tabindex="-1"></a><span class="co">#&gt;   64  7  1</span></span>
<span id="cb46-47"><a href="ip-weighting-and-marginal-structural-models.html#cb46-47" tabindex="-1"></a><span class="co">#&gt;   65  3  2</span></span>
<span id="cb46-48"><a href="ip-weighting-and-marginal-structural-models.html#cb46-48" tabindex="-1"></a><span class="co">#&gt;   66  4  0</span></span>
<span id="cb46-49"><a href="ip-weighting-and-marginal-structural-models.html#cb46-49" tabindex="-1"></a><span class="co">#&gt;   67  2  0</span></span>
<span id="cb46-50"><a href="ip-weighting-and-marginal-structural-models.html#cb46-50" tabindex="-1"></a><span class="co">#&gt;   69  6  2</span></span>
<span id="cb46-51"><a href="ip-weighting-and-marginal-structural-models.html#cb46-51" tabindex="-1"></a><span class="co">#&gt;   70  2  1</span></span>
<span id="cb46-52"><a href="ip-weighting-and-marginal-structural-models.html#cb46-52" tabindex="-1"></a><span class="co">#&gt;   71  0  1</span></span>
<span id="cb46-53"><a href="ip-weighting-and-marginal-structural-models.html#cb46-53" tabindex="-1"></a><span class="co">#&gt;   72  2  2</span></span>
<span id="cb46-54"><a href="ip-weighting-and-marginal-structural-models.html#cb46-54" tabindex="-1"></a><span class="co">#&gt;   74  0  1</span></span></code></pre></div>
</div>
<div id="program-12.3" class="section level2 hasAnchor">
<h2>Program 12.3<a href="ip-weighting-and-marginal-structural-models.html#program-12.3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating stabilized IP weights</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="ip-weighting-and-marginal-structural-models.html#cb47-1" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights</span></span>
<span id="cb47-2"><a href="ip-weighting-and-marginal-structural-models.html#cb47-2" tabindex="-1"></a>denom.fit <span class="ot">&lt;-</span></span>
<span id="cb47-3"><a href="ip-weighting-and-marginal-structural-models.html#cb47-3" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb47-4"><a href="ip-weighting-and-marginal-structural-models.html#cb47-4" tabindex="-1"></a>    qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb47-5"><a href="ip-weighting-and-marginal-structural-models.html#cb47-5" tabindex="-1"></a>      <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb47-6"><a href="ip-weighting-and-marginal-structural-models.html#cb47-6" tabindex="-1"></a>      <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb47-7"><a href="ip-weighting-and-marginal-structural-models.html#cb47-7" tabindex="-1"></a>      <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb47-8"><a href="ip-weighting-and-marginal-structural-models.html#cb47-8" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb47-9"><a href="ip-weighting-and-marginal-structural-models.html#cb47-9" tabindex="-1"></a>    <span class="at">data =</span> nhefs.nmv</span>
<span id="cb47-10"><a href="ip-weighting-and-marginal-structural-models.html#cb47-10" tabindex="-1"></a>  )</span>
<span id="cb47-11"><a href="ip-weighting-and-marginal-structural-models.html#cb47-11" tabindex="-1"></a><span class="fu">summary</span>(denom.fit)</span>
<span id="cb47-12"><a href="ip-weighting-and-marginal-structural-models.html#cb47-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb47-13"><a href="ip-weighting-and-marginal-structural-models.html#cb47-13" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb47-14"><a href="ip-weighting-and-marginal-structural-models.html#cb47-14" tabindex="-1"></a><span class="co">#&gt; glm(formula = qsmk ~ as.factor(sex) + as.factor(race) + age + </span></span>
<span id="cb47-15"><a href="ip-weighting-and-marginal-structural-models.html#cb47-15" tabindex="-1"></a><span class="co">#&gt;     I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + </span></span>
<span id="cb47-16"><a href="ip-weighting-and-marginal-structural-models.html#cb47-16" tabindex="-1"></a><span class="co">#&gt;     smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + </span></span>
<span id="cb47-17"><a href="ip-weighting-and-marginal-structural-models.html#cb47-17" tabindex="-1"></a><span class="co">#&gt;     wt71 + I(wt71^2), family = binomial(), data = nhefs.nmv)</span></span>
<span id="cb47-18"><a href="ip-weighting-and-marginal-structural-models.html#cb47-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb47-19"><a href="ip-weighting-and-marginal-structural-models.html#cb47-19" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb47-20"><a href="ip-weighting-and-marginal-structural-models.html#cb47-20" tabindex="-1"></a><span class="co">#&gt;                        Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb47-21"><a href="ip-weighting-and-marginal-structural-models.html#cb47-21" tabindex="-1"></a><span class="co">#&gt; (Intercept)           -2.242519   1.380836   -1.62  0.10437    </span></span>
<span id="cb47-22"><a href="ip-weighting-and-marginal-structural-models.html#cb47-22" tabindex="-1"></a><span class="co">#&gt; as.factor(sex)1       -0.527478   0.154050   -3.42  0.00062 ***</span></span>
<span id="cb47-23"><a href="ip-weighting-and-marginal-structural-models.html#cb47-23" tabindex="-1"></a><span class="co">#&gt; as.factor(race)1      -0.839264   0.210067   -4.00  6.5e-05 ***</span></span>
<span id="cb47-24"><a href="ip-weighting-and-marginal-structural-models.html#cb47-24" tabindex="-1"></a><span class="co">#&gt; age                    0.121205   0.051266    2.36  0.01807 *  </span></span>
<span id="cb47-25"><a href="ip-weighting-and-marginal-structural-models.html#cb47-25" tabindex="-1"></a><span class="co">#&gt; I(age^2)              -0.000825   0.000536   -1.54  0.12404    </span></span>
<span id="cb47-26"><a href="ip-weighting-and-marginal-structural-models.html#cb47-26" tabindex="-1"></a><span class="co">#&gt; as.factor(education)2 -0.028776   0.198351   -0.15  0.88465    </span></span>
<span id="cb47-27"><a href="ip-weighting-and-marginal-structural-models.html#cb47-27" tabindex="-1"></a><span class="co">#&gt; as.factor(education)3  0.086432   0.178085    0.49  0.62744    </span></span>
<span id="cb47-28"><a href="ip-weighting-and-marginal-structural-models.html#cb47-28" tabindex="-1"></a><span class="co">#&gt; as.factor(education)4  0.063601   0.273211    0.23  0.81592    </span></span>
<span id="cb47-29"><a href="ip-weighting-and-marginal-structural-models.html#cb47-29" tabindex="-1"></a><span class="co">#&gt; as.factor(education)5  0.475961   0.226224    2.10  0.03538 *  </span></span>
<span id="cb47-30"><a href="ip-weighting-and-marginal-structural-models.html#cb47-30" tabindex="-1"></a><span class="co">#&gt; smokeintensity        -0.077270   0.015250   -5.07  4.0e-07 ***</span></span>
<span id="cb47-31"><a href="ip-weighting-and-marginal-structural-models.html#cb47-31" tabindex="-1"></a><span class="co">#&gt; I(smokeintensity^2)    0.001045   0.000287    3.65  0.00027 ***</span></span>
<span id="cb47-32"><a href="ip-weighting-and-marginal-structural-models.html#cb47-32" tabindex="-1"></a><span class="co">#&gt; smokeyrs              -0.073597   0.027777   -2.65  0.00806 ** </span></span>
<span id="cb47-33"><a href="ip-weighting-and-marginal-structural-models.html#cb47-33" tabindex="-1"></a><span class="co">#&gt; I(smokeyrs^2)          0.000844   0.000463    1.82  0.06840 .  </span></span>
<span id="cb47-34"><a href="ip-weighting-and-marginal-structural-models.html#cb47-34" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)1   0.354841   0.180135    1.97  0.04885 *  </span></span>
<span id="cb47-35"><a href="ip-weighting-and-marginal-structural-models.html#cb47-35" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)2   0.395704   0.187240    2.11  0.03457 *  </span></span>
<span id="cb47-36"><a href="ip-weighting-and-marginal-structural-models.html#cb47-36" tabindex="-1"></a><span class="co">#&gt; as.factor(active)1     0.031944   0.132937    0.24  0.81010    </span></span>
<span id="cb47-37"><a href="ip-weighting-and-marginal-structural-models.html#cb47-37" tabindex="-1"></a><span class="co">#&gt; as.factor(active)2     0.176784   0.214972    0.82  0.41087    </span></span>
<span id="cb47-38"><a href="ip-weighting-and-marginal-structural-models.html#cb47-38" tabindex="-1"></a><span class="co">#&gt; wt71                  -0.015236   0.026316   -0.58  0.56262    </span></span>
<span id="cb47-39"><a href="ip-weighting-and-marginal-structural-models.html#cb47-39" tabindex="-1"></a><span class="co">#&gt; I(wt71^2)              0.000135   0.000163    0.83  0.40737    </span></span>
<span id="cb47-40"><a href="ip-weighting-and-marginal-structural-models.html#cb47-40" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb47-41"><a href="ip-weighting-and-marginal-structural-models.html#cb47-41" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb47-42"><a href="ip-weighting-and-marginal-structural-models.html#cb47-42" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb47-43"><a href="ip-weighting-and-marginal-structural-models.html#cb47-43" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb47-44"><a href="ip-weighting-and-marginal-structural-models.html#cb47-44" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb47-45"><a href="ip-weighting-and-marginal-structural-models.html#cb47-45" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 1786.1  on 1565  degrees of freedom</span></span>
<span id="cb47-46"><a href="ip-weighting-and-marginal-structural-models.html#cb47-46" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 1676.9  on 1547  degrees of freedom</span></span>
<span id="cb47-47"><a href="ip-weighting-and-marginal-structural-models.html#cb47-47" tabindex="-1"></a><span class="co">#&gt; AIC: 1715</span></span>
<span id="cb47-48"><a href="ip-weighting-and-marginal-structural-models.html#cb47-48" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb47-49"><a href="ip-weighting-and-marginal-structural-models.html#cb47-49" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="ip-weighting-and-marginal-structural-models.html#cb48-1" tabindex="-1"></a></span>
<span id="cb48-2"><a href="ip-weighting-and-marginal-structural-models.html#cb48-2" tabindex="-1"></a>pd.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(denom.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb48-3"><a href="ip-weighting-and-marginal-structural-models.html#cb48-3" tabindex="-1"></a></span>
<span id="cb48-4"><a href="ip-weighting-and-marginal-structural-models.html#cb48-4" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights</span></span>
<span id="cb48-5"><a href="ip-weighting-and-marginal-structural-models.html#cb48-5" tabindex="-1"></a>numer.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs.nmv)</span>
<span id="cb48-6"><a href="ip-weighting-and-marginal-structural-models.html#cb48-6" tabindex="-1"></a><span class="fu">summary</span>(numer.fit)</span>
<span id="cb48-7"><a href="ip-weighting-and-marginal-structural-models.html#cb48-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb48-8"><a href="ip-weighting-and-marginal-structural-models.html#cb48-8" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb48-9"><a href="ip-weighting-and-marginal-structural-models.html#cb48-9" tabindex="-1"></a><span class="co">#&gt; glm(formula = qsmk ~ 1, family = binomial(), data = nhefs.nmv)</span></span>
<span id="cb48-10"><a href="ip-weighting-and-marginal-structural-models.html#cb48-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb48-11"><a href="ip-weighting-and-marginal-structural-models.html#cb48-11" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb48-12"><a href="ip-weighting-and-marginal-structural-models.html#cb48-12" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb48-13"><a href="ip-weighting-and-marginal-structural-models.html#cb48-13" tabindex="-1"></a><span class="co">#&gt; (Intercept)  -1.0598     0.0578   -18.3   &lt;2e-16 ***</span></span>
<span id="cb48-14"><a href="ip-weighting-and-marginal-structural-models.html#cb48-14" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb48-15"><a href="ip-weighting-and-marginal-structural-models.html#cb48-15" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb48-16"><a href="ip-weighting-and-marginal-structural-models.html#cb48-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb48-17"><a href="ip-weighting-and-marginal-structural-models.html#cb48-17" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb48-18"><a href="ip-weighting-and-marginal-structural-models.html#cb48-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb48-19"><a href="ip-weighting-and-marginal-structural-models.html#cb48-19" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 1786.1  on 1565  degrees of freedom</span></span>
<span id="cb48-20"><a href="ip-weighting-and-marginal-structural-models.html#cb48-20" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 1786.1  on 1565  degrees of freedom</span></span>
<span id="cb48-21"><a href="ip-weighting-and-marginal-structural-models.html#cb48-21" tabindex="-1"></a><span class="co">#&gt; AIC: 1788</span></span>
<span id="cb48-22"><a href="ip-weighting-and-marginal-structural-models.html#cb48-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb48-23"><a href="ip-weighting-and-marginal-structural-models.html#cb48-23" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="ip-weighting-and-marginal-structural-models.html#cb49-1" tabindex="-1"></a></span>
<span id="cb49-2"><a href="ip-weighting-and-marginal-structural-models.html#cb49-2" tabindex="-1"></a>pn.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(numer.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb49-3"><a href="ip-weighting-and-marginal-structural-models.html#cb49-3" tabindex="-1"></a></span>
<span id="cb49-4"><a href="ip-weighting-and-marginal-structural-models.html#cb49-4" tabindex="-1"></a>nhefs.nmv<span class="sc">$</span>sw <span class="ot">&lt;-</span></span>
<span id="cb49-5"><a href="ip-weighting-and-marginal-structural-models.html#cb49-5" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>, ((<span class="dv">1</span> <span class="sc">-</span> pn.qsmk) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pd.qsmk)),</span>
<span id="cb49-6"><a href="ip-weighting-and-marginal-structural-models.html#cb49-6" tabindex="-1"></a>         (pn.qsmk <span class="sc">/</span> pd.qsmk))</span>
<span id="cb49-7"><a href="ip-weighting-and-marginal-structural-models.html#cb49-7" tabindex="-1"></a></span>
<span id="cb49-8"><a href="ip-weighting-and-marginal-structural-models.html#cb49-8" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv<span class="sc">$</span>sw)</span>
<span id="cb49-9"><a href="ip-weighting-and-marginal-structural-models.html#cb49-9" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb49-10"><a href="ip-weighting-and-marginal-structural-models.html#cb49-10" tabindex="-1"></a><span class="co">#&gt;   0.331   0.867   0.950   0.999   1.079   4.298</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="ip-weighting-and-marginal-structural-models.html#cb50-1" tabindex="-1"></a></span>
<span id="cb50-2"><a href="ip-weighting-and-marginal-structural-models.html#cb50-2" tabindex="-1"></a></span>
<span id="cb50-3"><a href="ip-weighting-and-marginal-structural-models.html#cb50-3" tabindex="-1"></a>msm.sw <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb50-4"><a href="ip-weighting-and-marginal-structural-models.html#cb50-4" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> qsmk,</span>
<span id="cb50-5"><a href="ip-weighting-and-marginal-structural-models.html#cb50-5" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb50-6"><a href="ip-weighting-and-marginal-structural-models.html#cb50-6" tabindex="-1"></a>  <span class="at">weights =</span> sw,</span>
<span id="cb50-7"><a href="ip-weighting-and-marginal-structural-models.html#cb50-7" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb50-8"><a href="ip-weighting-and-marginal-structural-models.html#cb50-8" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb50-9"><a href="ip-weighting-and-marginal-structural-models.html#cb50-9" tabindex="-1"></a>)</span>
<span id="cb50-10"><a href="ip-weighting-and-marginal-structural-models.html#cb50-10" tabindex="-1"></a><span class="fu">summary</span>(msm.sw)</span>
<span id="cb50-11"><a href="ip-weighting-and-marginal-structural-models.html#cb50-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb50-12"><a href="ip-weighting-and-marginal-structural-models.html#cb50-12" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb50-13"><a href="ip-weighting-and-marginal-structural-models.html#cb50-13" tabindex="-1"></a><span class="co">#&gt; geeglm(formula = wt82_71 ~ qsmk, data = nhefs.nmv, weights = sw, </span></span>
<span id="cb50-14"><a href="ip-weighting-and-marginal-structural-models.html#cb50-14" tabindex="-1"></a><span class="co">#&gt;     id = seqn, corstr = &quot;independence&quot;)</span></span>
<span id="cb50-15"><a href="ip-weighting-and-marginal-structural-models.html#cb50-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb50-16"><a href="ip-weighting-and-marginal-structural-models.html#cb50-16" tabindex="-1"></a><span class="co">#&gt;  Coefficients:</span></span>
<span id="cb50-17"><a href="ip-weighting-and-marginal-structural-models.html#cb50-17" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err Wald Pr(&gt;|W|)    </span></span>
<span id="cb50-18"><a href="ip-weighting-and-marginal-structural-models.html#cb50-18" tabindex="-1"></a><span class="co">#&gt; (Intercept)    1.780   0.225 62.7  2.3e-15 ***</span></span>
<span id="cb50-19"><a href="ip-weighting-and-marginal-structural-models.html#cb50-19" tabindex="-1"></a><span class="co">#&gt; qsmk           3.441   0.525 42.9  5.9e-11 ***</span></span>
<span id="cb50-20"><a href="ip-weighting-and-marginal-structural-models.html#cb50-20" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb50-21"><a href="ip-weighting-and-marginal-structural-models.html#cb50-21" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb50-22"><a href="ip-weighting-and-marginal-structural-models.html#cb50-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb50-23"><a href="ip-weighting-and-marginal-structural-models.html#cb50-23" tabindex="-1"></a><span class="co">#&gt; Correlation structure = independence </span></span>
<span id="cb50-24"><a href="ip-weighting-and-marginal-structural-models.html#cb50-24" tabindex="-1"></a><span class="co">#&gt; Estimated Scale Parameters:</span></span>
<span id="cb50-25"><a href="ip-weighting-and-marginal-structural-models.html#cb50-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb50-26"><a href="ip-weighting-and-marginal-structural-models.html#cb50-26" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err</span></span>
<span id="cb50-27"><a href="ip-weighting-and-marginal-structural-models.html#cb50-27" tabindex="-1"></a><span class="co">#&gt; (Intercept)     60.7    3.71</span></span>
<span id="cb50-28"><a href="ip-weighting-and-marginal-structural-models.html#cb50-28" tabindex="-1"></a><span class="co">#&gt; Number of clusters:   1566  Maximum cluster size: 1</span></span></code></pre></div>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="ip-weighting-and-marginal-structural-models.html#cb51-1" tabindex="-1"></a></span>
<span id="cb51-2"><a href="ip-weighting-and-marginal-structural-models.html#cb51-2" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.sw)</span>
<span id="cb51-3"><a href="ip-weighting-and-marginal-structural-models.html#cb51-3" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.sw))[, <span class="dv">2</span>]</span>
<span id="cb51-4"><a href="ip-weighting-and-marginal-structural-models.html#cb51-4" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb51-5"><a href="ip-weighting-and-marginal-structural-models.html#cb51-5" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb51-6"><a href="ip-weighting-and-marginal-structural-models.html#cb51-6" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span>
<span id="cb51-7"><a href="ip-weighting-and-marginal-structural-models.html#cb51-7" tabindex="-1"></a><span class="co">#&gt;             beta  lcl  ucl</span></span>
<span id="cb51-8"><a href="ip-weighting-and-marginal-structural-models.html#cb51-8" tabindex="-1"></a><span class="co">#&gt; (Intercept) 1.78 1.34 2.22</span></span>
<span id="cb51-9"><a href="ip-weighting-and-marginal-structural-models.html#cb51-9" tabindex="-1"></a><span class="co">#&gt; qsmk        3.44 2.41 4.47</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="ip-weighting-and-marginal-structural-models.html#cb52-1" tabindex="-1"></a></span>
<span id="cb52-2"><a href="ip-weighting-and-marginal-structural-models.html#cb52-2" tabindex="-1"></a><span class="co"># no association between sex and qsmk in pseudo-population</span></span>
<span id="cb52-3"><a href="ip-weighting-and-marginal-structural-models.html#cb52-3" tabindex="-1"></a><span class="fu">xtabs</span>(nhefs.nmv<span class="sc">$</span>sw <span class="sc">~</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">+</span> nhefs.nmv<span class="sc">$</span>qsmk)</span>
<span id="cb52-4"><a href="ip-weighting-and-marginal-structural-models.html#cb52-4" tabindex="-1"></a><span class="co">#&gt;              nhefs.nmv$qsmk</span></span>
<span id="cb52-5"><a href="ip-weighting-and-marginal-structural-models.html#cb52-5" tabindex="-1"></a><span class="co">#&gt; nhefs.nmv$sex   0   1</span></span>
<span id="cb52-6"><a href="ip-weighting-and-marginal-structural-models.html#cb52-6" tabindex="-1"></a><span class="co">#&gt;             0 567 197</span></span>
<span id="cb52-7"><a href="ip-weighting-and-marginal-structural-models.html#cb52-7" tabindex="-1"></a><span class="co">#&gt;             1 595 205</span></span></code></pre></div>
</div>
<div id="program-12.4" class="section level2 hasAnchor">
<h2>Program 12.4<a href="ip-weighting-and-marginal-structural-models.html#program-12.4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating the parameters of a marginal structural mean model with a continuous treatment Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="ip-weighting-and-marginal-structural-models.html#cb53-1" tabindex="-1"></a><span class="co"># Analysis restricted to subjects reporting &lt;=25 cig/day at baseline</span></span>
<span id="cb53-2"><a href="ip-weighting-and-marginal-structural-models.html#cb53-2" tabindex="-1"></a>nhefs.nmv.s <span class="ot">&lt;-</span> <span class="fu">subset</span>(nhefs.nmv, smokeintensity <span class="sc">&lt;=</span> <span class="dv">25</span>)</span>
<span id="cb53-3"><a href="ip-weighting-and-marginal-structural-models.html#cb53-3" tabindex="-1"></a></span>
<span id="cb53-4"><a href="ip-weighting-and-marginal-structural-models.html#cb53-4" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights</span></span>
<span id="cb53-5"><a href="ip-weighting-and-marginal-structural-models.html#cb53-5" tabindex="-1"></a>den.fit.obj <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb53-6"><a href="ip-weighting-and-marginal-structural-models.html#cb53-6" tabindex="-1"></a>  smkintensity82_71 <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span></span>
<span id="cb53-7"><a href="ip-weighting-and-marginal-structural-models.html#cb53-7" tabindex="-1"></a>    <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb53-8"><a href="ip-weighting-and-marginal-structural-models.html#cb53-8" tabindex="-1"></a>    <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span> <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb53-9"><a href="ip-weighting-and-marginal-structural-models.html#cb53-9" tabindex="-1"></a>    smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span></span>
<span id="cb53-10"><a href="ip-weighting-and-marginal-structural-models.html#cb53-10" tabindex="-1"></a>    <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb53-11"><a href="ip-weighting-and-marginal-structural-models.html#cb53-11" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv.s</span>
<span id="cb53-12"><a href="ip-weighting-and-marginal-structural-models.html#cb53-12" tabindex="-1"></a>)</span>
<span id="cb53-13"><a href="ip-weighting-and-marginal-structural-models.html#cb53-13" tabindex="-1"></a>p.den <span class="ot">&lt;-</span> <span class="fu">predict</span>(den.fit.obj, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-14"><a href="ip-weighting-and-marginal-structural-models.html#cb53-14" tabindex="-1"></a>dens.den <span class="ot">&lt;-</span></span>
<span id="cb53-15"><a href="ip-weighting-and-marginal-structural-models.html#cb53-15" tabindex="-1"></a>  <span class="fu">dnorm</span>(nhefs.nmv.s<span class="sc">$</span>smkintensity82_71,</span>
<span id="cb53-16"><a href="ip-weighting-and-marginal-structural-models.html#cb53-16" tabindex="-1"></a>        p.den,</span>
<span id="cb53-17"><a href="ip-weighting-and-marginal-structural-models.html#cb53-17" tabindex="-1"></a>        <span class="fu">summary</span>(den.fit.obj)<span class="sc">$</span>sigma)</span>
<span id="cb53-18"><a href="ip-weighting-and-marginal-structural-models.html#cb53-18" tabindex="-1"></a></span>
<span id="cb53-19"><a href="ip-weighting-and-marginal-structural-models.html#cb53-19" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights</span></span>
<span id="cb53-20"><a href="ip-weighting-and-marginal-structural-models.html#cb53-20" tabindex="-1"></a>num.fit.obj <span class="ot">&lt;-</span> <span class="fu">lm</span>(smkintensity82_71 <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> nhefs.nmv.s)</span>
<span id="cb53-21"><a href="ip-weighting-and-marginal-structural-models.html#cb53-21" tabindex="-1"></a>p.num <span class="ot">&lt;-</span> <span class="fu">predict</span>(num.fit.obj, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-22"><a href="ip-weighting-and-marginal-structural-models.html#cb53-22" tabindex="-1"></a>dens.num <span class="ot">&lt;-</span></span>
<span id="cb53-23"><a href="ip-weighting-and-marginal-structural-models.html#cb53-23" tabindex="-1"></a>  <span class="fu">dnorm</span>(nhefs.nmv.s<span class="sc">$</span>smkintensity82_71,</span>
<span id="cb53-24"><a href="ip-weighting-and-marginal-structural-models.html#cb53-24" tabindex="-1"></a>        p.num,</span>
<span id="cb53-25"><a href="ip-weighting-and-marginal-structural-models.html#cb53-25" tabindex="-1"></a>        <span class="fu">summary</span>(num.fit.obj)<span class="sc">$</span>sigma)</span>
<span id="cb53-26"><a href="ip-weighting-and-marginal-structural-models.html#cb53-26" tabindex="-1"></a></span>
<span id="cb53-27"><a href="ip-weighting-and-marginal-structural-models.html#cb53-27" tabindex="-1"></a>nhefs.nmv.s<span class="sc">$</span>sw.a <span class="ot">&lt;-</span> dens.num <span class="sc">/</span> dens.den</span>
<span id="cb53-28"><a href="ip-weighting-and-marginal-structural-models.html#cb53-28" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv.s<span class="sc">$</span>sw.a)</span>
<span id="cb53-29"><a href="ip-weighting-and-marginal-structural-models.html#cb53-29" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb53-30"><a href="ip-weighting-and-marginal-structural-models.html#cb53-30" tabindex="-1"></a><span class="co">#&gt;    0.19    0.89    0.97    1.00    1.05    5.10</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="ip-weighting-and-marginal-structural-models.html#cb54-1" tabindex="-1"></a></span>
<span id="cb54-2"><a href="ip-weighting-and-marginal-structural-models.html#cb54-2" tabindex="-1"></a>msm.sw.cont <span class="ot">&lt;-</span></span>
<span id="cb54-3"><a href="ip-weighting-and-marginal-structural-models.html#cb54-3" tabindex="-1"></a>  <span class="fu">geeglm</span>(</span>
<span id="cb54-4"><a href="ip-weighting-and-marginal-structural-models.html#cb54-4" tabindex="-1"></a>    wt82_71 <span class="sc">~</span> smkintensity82_71 <span class="sc">+</span> <span class="fu">I</span>(smkintensity82_71 <span class="sc">*</span> smkintensity82_71),</span>
<span id="cb54-5"><a href="ip-weighting-and-marginal-structural-models.html#cb54-5" tabindex="-1"></a>    <span class="at">data =</span> nhefs.nmv.s,</span>
<span id="cb54-6"><a href="ip-weighting-and-marginal-structural-models.html#cb54-6" tabindex="-1"></a>    <span class="at">weights =</span> sw.a,</span>
<span id="cb54-7"><a href="ip-weighting-and-marginal-structural-models.html#cb54-7" tabindex="-1"></a>    <span class="at">id =</span> seqn,</span>
<span id="cb54-8"><a href="ip-weighting-and-marginal-structural-models.html#cb54-8" tabindex="-1"></a>    <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb54-9"><a href="ip-weighting-and-marginal-structural-models.html#cb54-9" tabindex="-1"></a>  )</span>
<span id="cb54-10"><a href="ip-weighting-and-marginal-structural-models.html#cb54-10" tabindex="-1"></a><span class="fu">summary</span>(msm.sw.cont)</span>
<span id="cb54-11"><a href="ip-weighting-and-marginal-structural-models.html#cb54-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb54-12"><a href="ip-weighting-and-marginal-structural-models.html#cb54-12" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb54-13"><a href="ip-weighting-and-marginal-structural-models.html#cb54-13" tabindex="-1"></a><span class="co">#&gt; geeglm(formula = wt82_71 ~ smkintensity82_71 + I(smkintensity82_71 * </span></span>
<span id="cb54-14"><a href="ip-weighting-and-marginal-structural-models.html#cb54-14" tabindex="-1"></a><span class="co">#&gt;     smkintensity82_71), data = nhefs.nmv.s, weights = sw.a, id = seqn, </span></span>
<span id="cb54-15"><a href="ip-weighting-and-marginal-structural-models.html#cb54-15" tabindex="-1"></a><span class="co">#&gt;     corstr = &quot;independence&quot;)</span></span>
<span id="cb54-16"><a href="ip-weighting-and-marginal-structural-models.html#cb54-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb54-17"><a href="ip-weighting-and-marginal-structural-models.html#cb54-17" tabindex="-1"></a><span class="co">#&gt;  Coefficients:</span></span>
<span id="cb54-18"><a href="ip-weighting-and-marginal-structural-models.html#cb54-18" tabindex="-1"></a><span class="co">#&gt;                                          Estimate  Std.err  Wald Pr(&gt;|W|)    </span></span>
<span id="cb54-19"><a href="ip-weighting-and-marginal-structural-models.html#cb54-19" tabindex="-1"></a><span class="co">#&gt; (Intercept)                               2.00452  0.29512 46.13  1.1e-11 ***</span></span>
<span id="cb54-20"><a href="ip-weighting-and-marginal-structural-models.html#cb54-20" tabindex="-1"></a><span class="co">#&gt; smkintensity82_71                        -0.10899  0.03154 11.94  0.00055 ***</span></span>
<span id="cb54-21"><a href="ip-weighting-and-marginal-structural-models.html#cb54-21" tabindex="-1"></a><span class="co">#&gt; I(smkintensity82_71 * smkintensity82_71)  0.00269  0.00242  1.24  0.26489    </span></span>
<span id="cb54-22"><a href="ip-weighting-and-marginal-structural-models.html#cb54-22" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb54-23"><a href="ip-weighting-and-marginal-structural-models.html#cb54-23" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb54-24"><a href="ip-weighting-and-marginal-structural-models.html#cb54-24" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb54-25"><a href="ip-weighting-and-marginal-structural-models.html#cb54-25" tabindex="-1"></a><span class="co">#&gt; Correlation structure = independence </span></span>
<span id="cb54-26"><a href="ip-weighting-and-marginal-structural-models.html#cb54-26" tabindex="-1"></a><span class="co">#&gt; Estimated Scale Parameters:</span></span>
<span id="cb54-27"><a href="ip-weighting-and-marginal-structural-models.html#cb54-27" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb54-28"><a href="ip-weighting-and-marginal-structural-models.html#cb54-28" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err</span></span>
<span id="cb54-29"><a href="ip-weighting-and-marginal-structural-models.html#cb54-29" tabindex="-1"></a><span class="co">#&gt; (Intercept)     60.5     4.5</span></span>
<span id="cb54-30"><a href="ip-weighting-and-marginal-structural-models.html#cb54-30" tabindex="-1"></a><span class="co">#&gt; Number of clusters:   1162  Maximum cluster size: 1</span></span></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="ip-weighting-and-marginal-structural-models.html#cb55-1" tabindex="-1"></a></span>
<span id="cb55-2"><a href="ip-weighting-and-marginal-structural-models.html#cb55-2" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.sw.cont)</span>
<span id="cb55-3"><a href="ip-weighting-and-marginal-structural-models.html#cb55-3" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.sw.cont))[, <span class="dv">2</span>]</span>
<span id="cb55-4"><a href="ip-weighting-and-marginal-structural-models.html#cb55-4" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb55-5"><a href="ip-weighting-and-marginal-structural-models.html#cb55-5" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb55-6"><a href="ip-weighting-and-marginal-structural-models.html#cb55-6" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span>
<span id="cb55-7"><a href="ip-weighting-and-marginal-structural-models.html#cb55-7" tabindex="-1"></a><span class="co">#&gt;                                              beta      lcl      ucl</span></span>
<span id="cb55-8"><a href="ip-weighting-and-marginal-structural-models.html#cb55-8" tabindex="-1"></a><span class="co">#&gt; (Intercept)                               2.00452  1.42610  2.58295</span></span>
<span id="cb55-9"><a href="ip-weighting-and-marginal-structural-models.html#cb55-9" tabindex="-1"></a><span class="co">#&gt; smkintensity82_71                        -0.10899 -0.17080 -0.04718</span></span>
<span id="cb55-10"><a href="ip-weighting-and-marginal-structural-models.html#cb55-10" tabindex="-1"></a><span class="co">#&gt; I(smkintensity82_71 * smkintensity82_71)  0.00269 -0.00204  0.00743</span></span></code></pre></div>
</div>
<div id="program-12.5" class="section level2 hasAnchor">
<h2>Program 12.5<a href="ip-weighting-and-marginal-structural-models.html#program-12.5" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating the parameters of a marginal structural logistic model</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="ip-weighting-and-marginal-structural-models.html#cb56-1" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>death)</span>
<span id="cb56-2"><a href="ip-weighting-and-marginal-structural-models.html#cb56-2" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb56-3"><a href="ip-weighting-and-marginal-structural-models.html#cb56-3" tabindex="-1"></a><span class="co">#&gt;       0   1</span></span>
<span id="cb56-4"><a href="ip-weighting-and-marginal-structural-models.html#cb56-4" tabindex="-1"></a><span class="co">#&gt;   0 963 200</span></span>
<span id="cb56-5"><a href="ip-weighting-and-marginal-structural-models.html#cb56-5" tabindex="-1"></a><span class="co">#&gt;   1 312  91</span></span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="ip-weighting-and-marginal-structural-models.html#cb57-1" tabindex="-1"></a></span>
<span id="cb57-2"><a href="ip-weighting-and-marginal-structural-models.html#cb57-2" tabindex="-1"></a><span class="co"># First, estimation of stabilized weights sw (same as in Program 12.3)</span></span>
<span id="cb57-3"><a href="ip-weighting-and-marginal-structural-models.html#cb57-3" tabindex="-1"></a><span class="co"># Second, fit logistic model below</span></span>
<span id="cb57-4"><a href="ip-weighting-and-marginal-structural-models.html#cb57-4" tabindex="-1"></a>msm.logistic <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb57-5"><a href="ip-weighting-and-marginal-structural-models.html#cb57-5" tabindex="-1"></a>  death <span class="sc">~</span> qsmk,</span>
<span id="cb57-6"><a href="ip-weighting-and-marginal-structural-models.html#cb57-6" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb57-7"><a href="ip-weighting-and-marginal-structural-models.html#cb57-7" tabindex="-1"></a>  <span class="at">weights =</span> sw,</span>
<span id="cb57-8"><a href="ip-weighting-and-marginal-structural-models.html#cb57-8" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb57-9"><a href="ip-weighting-and-marginal-structural-models.html#cb57-9" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb57-10"><a href="ip-weighting-and-marginal-structural-models.html#cb57-10" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb57-11"><a href="ip-weighting-and-marginal-structural-models.html#cb57-11" tabindex="-1"></a>)</span>
<span id="cb57-12"><a href="ip-weighting-and-marginal-structural-models.html#cb57-12" tabindex="-1"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="ip-weighting-and-marginal-structural-models.html#cb58-1" tabindex="-1"></a><span class="fu">summary</span>(msm.logistic)</span>
<span id="cb58-2"><a href="ip-weighting-and-marginal-structural-models.html#cb58-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb58-3"><a href="ip-weighting-and-marginal-structural-models.html#cb58-3" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb58-4"><a href="ip-weighting-and-marginal-structural-models.html#cb58-4" tabindex="-1"></a><span class="co">#&gt; geeglm(formula = death ~ qsmk, family = binomial(), data = nhefs.nmv, </span></span>
<span id="cb58-5"><a href="ip-weighting-and-marginal-structural-models.html#cb58-5" tabindex="-1"></a><span class="co">#&gt;     weights = sw, id = seqn, corstr = &quot;independence&quot;)</span></span>
<span id="cb58-6"><a href="ip-weighting-and-marginal-structural-models.html#cb58-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb58-7"><a href="ip-weighting-and-marginal-structural-models.html#cb58-7" tabindex="-1"></a><span class="co">#&gt;  Coefficients:</span></span>
<span id="cb58-8"><a href="ip-weighting-and-marginal-structural-models.html#cb58-8" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err   Wald Pr(&gt;|W|)    </span></span>
<span id="cb58-9"><a href="ip-weighting-and-marginal-structural-models.html#cb58-9" tabindex="-1"></a><span class="co">#&gt; (Intercept)  -1.4905  0.0789 356.50   &lt;2e-16 ***</span></span>
<span id="cb58-10"><a href="ip-weighting-and-marginal-structural-models.html#cb58-10" tabindex="-1"></a><span class="co">#&gt; qsmk          0.0301  0.1573   0.04     0.85    </span></span>
<span id="cb58-11"><a href="ip-weighting-and-marginal-structural-models.html#cb58-11" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb58-12"><a href="ip-weighting-and-marginal-structural-models.html#cb58-12" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb58-13"><a href="ip-weighting-and-marginal-structural-models.html#cb58-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb58-14"><a href="ip-weighting-and-marginal-structural-models.html#cb58-14" tabindex="-1"></a><span class="co">#&gt; Correlation structure = independence </span></span>
<span id="cb58-15"><a href="ip-weighting-and-marginal-structural-models.html#cb58-15" tabindex="-1"></a><span class="co">#&gt; Estimated Scale Parameters:</span></span>
<span id="cb58-16"><a href="ip-weighting-and-marginal-structural-models.html#cb58-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb58-17"><a href="ip-weighting-and-marginal-structural-models.html#cb58-17" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err</span></span>
<span id="cb58-18"><a href="ip-weighting-and-marginal-structural-models.html#cb58-18" tabindex="-1"></a><span class="co">#&gt; (Intercept)        1  0.0678</span></span>
<span id="cb58-19"><a href="ip-weighting-and-marginal-structural-models.html#cb58-19" tabindex="-1"></a><span class="co">#&gt; Number of clusters:   1566  Maximum cluster size: 1</span></span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="ip-weighting-and-marginal-structural-models.html#cb59-1" tabindex="-1"></a></span>
<span id="cb59-2"><a href="ip-weighting-and-marginal-structural-models.html#cb59-2" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.logistic)</span>
<span id="cb59-3"><a href="ip-weighting-and-marginal-structural-models.html#cb59-3" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.logistic))[, <span class="dv">2</span>]</span>
<span id="cb59-4"><a href="ip-weighting-and-marginal-structural-models.html#cb59-4" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb59-5"><a href="ip-weighting-and-marginal-structural-models.html#cb59-5" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb59-6"><a href="ip-weighting-and-marginal-structural-models.html#cb59-6" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span>
<span id="cb59-7"><a href="ip-weighting-and-marginal-structural-models.html#cb59-7" tabindex="-1"></a><span class="co">#&gt;                beta    lcl    ucl</span></span>
<span id="cb59-8"><a href="ip-weighting-and-marginal-structural-models.html#cb59-8" tabindex="-1"></a><span class="co">#&gt; (Intercept) -1.4905 -1.645 -1.336</span></span>
<span id="cb59-9"><a href="ip-weighting-and-marginal-structural-models.html#cb59-9" tabindex="-1"></a><span class="co">#&gt; qsmk         0.0301 -0.278  0.338</span></span></code></pre></div>
</div>
<div id="program-12.6" class="section level2 hasAnchor">
<h2>Program 12.6<a href="ip-weighting-and-marginal-structural-models.html#program-12.6" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Assessing effect modification by sex using a marginal structural mean model</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="ip-weighting-and-marginal-structural-models.html#cb60-1" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>sex)</span>
<span id="cb60-2"><a href="ip-weighting-and-marginal-structural-models.html#cb60-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb60-3"><a href="ip-weighting-and-marginal-structural-models.html#cb60-3" tabindex="-1"></a><span class="co">#&gt;   0   1 </span></span>
<span id="cb60-4"><a href="ip-weighting-and-marginal-structural-models.html#cb60-4" tabindex="-1"></a><span class="co">#&gt; 762 804</span></span></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="ip-weighting-and-marginal-structural-models.html#cb61-1" tabindex="-1"></a></span>
<span id="cb61-2"><a href="ip-weighting-and-marginal-structural-models.html#cb61-2" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights</span></span>
<span id="cb61-3"><a href="ip-weighting-and-marginal-structural-models.html#cb61-3" tabindex="-1"></a>denom.fit <span class="ot">&lt;-</span></span>
<span id="cb61-4"><a href="ip-weighting-and-marginal-structural-models.html#cb61-4" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb61-5"><a href="ip-weighting-and-marginal-structural-models.html#cb61-5" tabindex="-1"></a>    qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb61-6"><a href="ip-weighting-and-marginal-structural-models.html#cb61-6" tabindex="-1"></a>      <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb61-7"><a href="ip-weighting-and-marginal-structural-models.html#cb61-7" tabindex="-1"></a>      <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb61-8"><a href="ip-weighting-and-marginal-structural-models.html#cb61-8" tabindex="-1"></a>      <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb61-9"><a href="ip-weighting-and-marginal-structural-models.html#cb61-9" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb61-10"><a href="ip-weighting-and-marginal-structural-models.html#cb61-10" tabindex="-1"></a>    <span class="at">data =</span> nhefs.nmv</span>
<span id="cb61-11"><a href="ip-weighting-and-marginal-structural-models.html#cb61-11" tabindex="-1"></a>  )</span>
<span id="cb61-12"><a href="ip-weighting-and-marginal-structural-models.html#cb61-12" tabindex="-1"></a><span class="fu">summary</span>(denom.fit)</span>
<span id="cb61-13"><a href="ip-weighting-and-marginal-structural-models.html#cb61-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb61-14"><a href="ip-weighting-and-marginal-structural-models.html#cb61-14" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb61-15"><a href="ip-weighting-and-marginal-structural-models.html#cb61-15" tabindex="-1"></a><span class="co">#&gt; glm(formula = qsmk ~ as.factor(sex) + as.factor(race) + age + </span></span>
<span id="cb61-16"><a href="ip-weighting-and-marginal-structural-models.html#cb61-16" tabindex="-1"></a><span class="co">#&gt;     I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + </span></span>
<span id="cb61-17"><a href="ip-weighting-and-marginal-structural-models.html#cb61-17" tabindex="-1"></a><span class="co">#&gt;     smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + </span></span>
<span id="cb61-18"><a href="ip-weighting-and-marginal-structural-models.html#cb61-18" tabindex="-1"></a><span class="co">#&gt;     wt71 + I(wt71^2), family = binomial(), data = nhefs.nmv)</span></span>
<span id="cb61-19"><a href="ip-weighting-and-marginal-structural-models.html#cb61-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb61-20"><a href="ip-weighting-and-marginal-structural-models.html#cb61-20" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb61-21"><a href="ip-weighting-and-marginal-structural-models.html#cb61-21" tabindex="-1"></a><span class="co">#&gt;                        Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb61-22"><a href="ip-weighting-and-marginal-structural-models.html#cb61-22" tabindex="-1"></a><span class="co">#&gt; (Intercept)           -2.242519   1.380836   -1.62  0.10437    </span></span>
<span id="cb61-23"><a href="ip-weighting-and-marginal-structural-models.html#cb61-23" tabindex="-1"></a><span class="co">#&gt; as.factor(sex)1       -0.527478   0.154050   -3.42  0.00062 ***</span></span>
<span id="cb61-24"><a href="ip-weighting-and-marginal-structural-models.html#cb61-24" tabindex="-1"></a><span class="co">#&gt; as.factor(race)1      -0.839264   0.210067   -4.00  6.5e-05 ***</span></span>
<span id="cb61-25"><a href="ip-weighting-and-marginal-structural-models.html#cb61-25" tabindex="-1"></a><span class="co">#&gt; age                    0.121205   0.051266    2.36  0.01807 *  </span></span>
<span id="cb61-26"><a href="ip-weighting-and-marginal-structural-models.html#cb61-26" tabindex="-1"></a><span class="co">#&gt; I(age^2)              -0.000825   0.000536   -1.54  0.12404    </span></span>
<span id="cb61-27"><a href="ip-weighting-and-marginal-structural-models.html#cb61-27" tabindex="-1"></a><span class="co">#&gt; as.factor(education)2 -0.028776   0.198351   -0.15  0.88465    </span></span>
<span id="cb61-28"><a href="ip-weighting-and-marginal-structural-models.html#cb61-28" tabindex="-1"></a><span class="co">#&gt; as.factor(education)3  0.086432   0.178085    0.49  0.62744    </span></span>
<span id="cb61-29"><a href="ip-weighting-and-marginal-structural-models.html#cb61-29" tabindex="-1"></a><span class="co">#&gt; as.factor(education)4  0.063601   0.273211    0.23  0.81592    </span></span>
<span id="cb61-30"><a href="ip-weighting-and-marginal-structural-models.html#cb61-30" tabindex="-1"></a><span class="co">#&gt; as.factor(education)5  0.475961   0.226224    2.10  0.03538 *  </span></span>
<span id="cb61-31"><a href="ip-weighting-and-marginal-structural-models.html#cb61-31" tabindex="-1"></a><span class="co">#&gt; smokeintensity        -0.077270   0.015250   -5.07  4.0e-07 ***</span></span>
<span id="cb61-32"><a href="ip-weighting-and-marginal-structural-models.html#cb61-32" tabindex="-1"></a><span class="co">#&gt; I(smokeintensity^2)    0.001045   0.000287    3.65  0.00027 ***</span></span>
<span id="cb61-33"><a href="ip-weighting-and-marginal-structural-models.html#cb61-33" tabindex="-1"></a><span class="co">#&gt; smokeyrs              -0.073597   0.027777   -2.65  0.00806 ** </span></span>
<span id="cb61-34"><a href="ip-weighting-and-marginal-structural-models.html#cb61-34" tabindex="-1"></a><span class="co">#&gt; I(smokeyrs^2)          0.000844   0.000463    1.82  0.06840 .  </span></span>
<span id="cb61-35"><a href="ip-weighting-and-marginal-structural-models.html#cb61-35" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)1   0.354841   0.180135    1.97  0.04885 *  </span></span>
<span id="cb61-36"><a href="ip-weighting-and-marginal-structural-models.html#cb61-36" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)2   0.395704   0.187240    2.11  0.03457 *  </span></span>
<span id="cb61-37"><a href="ip-weighting-and-marginal-structural-models.html#cb61-37" tabindex="-1"></a><span class="co">#&gt; as.factor(active)1     0.031944   0.132937    0.24  0.81010    </span></span>
<span id="cb61-38"><a href="ip-weighting-and-marginal-structural-models.html#cb61-38" tabindex="-1"></a><span class="co">#&gt; as.factor(active)2     0.176784   0.214972    0.82  0.41087    </span></span>
<span id="cb61-39"><a href="ip-weighting-and-marginal-structural-models.html#cb61-39" tabindex="-1"></a><span class="co">#&gt; wt71                  -0.015236   0.026316   -0.58  0.56262    </span></span>
<span id="cb61-40"><a href="ip-weighting-and-marginal-structural-models.html#cb61-40" tabindex="-1"></a><span class="co">#&gt; I(wt71^2)              0.000135   0.000163    0.83  0.40737    </span></span>
<span id="cb61-41"><a href="ip-weighting-and-marginal-structural-models.html#cb61-41" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb61-42"><a href="ip-weighting-and-marginal-structural-models.html#cb61-42" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb61-43"><a href="ip-weighting-and-marginal-structural-models.html#cb61-43" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb61-44"><a href="ip-weighting-and-marginal-structural-models.html#cb61-44" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb61-45"><a href="ip-weighting-and-marginal-structural-models.html#cb61-45" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb61-46"><a href="ip-weighting-and-marginal-structural-models.html#cb61-46" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 1786.1  on 1565  degrees of freedom</span></span>
<span id="cb61-47"><a href="ip-weighting-and-marginal-structural-models.html#cb61-47" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 1676.9  on 1547  degrees of freedom</span></span>
<span id="cb61-48"><a href="ip-weighting-and-marginal-structural-models.html#cb61-48" tabindex="-1"></a><span class="co">#&gt; AIC: 1715</span></span>
<span id="cb61-49"><a href="ip-weighting-and-marginal-structural-models.html#cb61-49" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb61-50"><a href="ip-weighting-and-marginal-structural-models.html#cb61-50" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span></code></pre></div>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="ip-weighting-and-marginal-structural-models.html#cb62-1" tabindex="-1"></a></span>
<span id="cb62-2"><a href="ip-weighting-and-marginal-structural-models.html#cb62-2" tabindex="-1"></a>pd.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(denom.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb62-3"><a href="ip-weighting-and-marginal-structural-models.html#cb62-3" tabindex="-1"></a></span>
<span id="cb62-4"><a href="ip-weighting-and-marginal-structural-models.html#cb62-4" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights</span></span>
<span id="cb62-5"><a href="ip-weighting-and-marginal-structural-models.html#cb62-5" tabindex="-1"></a>numer.fit <span class="ot">&lt;-</span></span>
<span id="cb62-6"><a href="ip-weighting-and-marginal-structural-models.html#cb62-6" tabindex="-1"></a>  <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex), <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs.nmv)</span>
<span id="cb62-7"><a href="ip-weighting-and-marginal-structural-models.html#cb62-7" tabindex="-1"></a><span class="fu">summary</span>(numer.fit)</span>
<span id="cb62-8"><a href="ip-weighting-and-marginal-structural-models.html#cb62-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb62-9"><a href="ip-weighting-and-marginal-structural-models.html#cb62-9" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb62-10"><a href="ip-weighting-and-marginal-structural-models.html#cb62-10" tabindex="-1"></a><span class="co">#&gt; glm(formula = qsmk ~ as.factor(sex), family = binomial(), data = nhefs.nmv)</span></span>
<span id="cb62-11"><a href="ip-weighting-and-marginal-structural-models.html#cb62-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb62-12"><a href="ip-weighting-and-marginal-structural-models.html#cb62-12" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb62-13"><a href="ip-weighting-and-marginal-structural-models.html#cb62-13" tabindex="-1"></a><span class="co">#&gt;                 Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb62-14"><a href="ip-weighting-and-marginal-structural-models.html#cb62-14" tabindex="-1"></a><span class="co">#&gt; (Intercept)      -0.9016     0.0799  -11.28   &lt;2e-16 ***</span></span>
<span id="cb62-15"><a href="ip-weighting-and-marginal-structural-models.html#cb62-15" tabindex="-1"></a><span class="co">#&gt; as.factor(sex)1  -0.3202     0.1160   -2.76   0.0058 ** </span></span>
<span id="cb62-16"><a href="ip-weighting-and-marginal-structural-models.html#cb62-16" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb62-17"><a href="ip-weighting-and-marginal-structural-models.html#cb62-17" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb62-18"><a href="ip-weighting-and-marginal-structural-models.html#cb62-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb62-19"><a href="ip-weighting-and-marginal-structural-models.html#cb62-19" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb62-20"><a href="ip-weighting-and-marginal-structural-models.html#cb62-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb62-21"><a href="ip-weighting-and-marginal-structural-models.html#cb62-21" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 1786.1  on 1565  degrees of freedom</span></span>
<span id="cb62-22"><a href="ip-weighting-and-marginal-structural-models.html#cb62-22" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 1778.4  on 1564  degrees of freedom</span></span>
<span id="cb62-23"><a href="ip-weighting-and-marginal-structural-models.html#cb62-23" tabindex="-1"></a><span class="co">#&gt; AIC: 1782</span></span>
<span id="cb62-24"><a href="ip-weighting-and-marginal-structural-models.html#cb62-24" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb62-25"><a href="ip-weighting-and-marginal-structural-models.html#cb62-25" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="ip-weighting-and-marginal-structural-models.html#cb63-1" tabindex="-1"></a>pn.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(numer.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb63-2"><a href="ip-weighting-and-marginal-structural-models.html#cb63-2" tabindex="-1"></a></span>
<span id="cb63-3"><a href="ip-weighting-and-marginal-structural-models.html#cb63-3" tabindex="-1"></a>nhefs.nmv<span class="sc">$</span>sw.a <span class="ot">&lt;-</span></span>
<span id="cb63-4"><a href="ip-weighting-and-marginal-structural-models.html#cb63-4" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>, ((<span class="dv">1</span> <span class="sc">-</span> pn.qsmk) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pd.qsmk)),</span>
<span id="cb63-5"><a href="ip-weighting-and-marginal-structural-models.html#cb63-5" tabindex="-1"></a>         (pn.qsmk <span class="sc">/</span> pd.qsmk))</span>
<span id="cb63-6"><a href="ip-weighting-and-marginal-structural-models.html#cb63-6" tabindex="-1"></a></span>
<span id="cb63-7"><a href="ip-weighting-and-marginal-structural-models.html#cb63-7" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv<span class="sc">$</span>sw.a)</span>
<span id="cb63-8"><a href="ip-weighting-and-marginal-structural-models.html#cb63-8" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb63-9"><a href="ip-weighting-and-marginal-structural-models.html#cb63-9" tabindex="-1"></a><span class="co">#&gt;    0.29    0.88    0.96    1.00    1.08    3.80</span></span></code></pre></div>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="ip-weighting-and-marginal-structural-models.html#cb64-1" tabindex="-1"></a><span class="fu">sd</span>(nhefs.nmv<span class="sc">$</span>sw.a)</span>
<span id="cb64-2"><a href="ip-weighting-and-marginal-structural-models.html#cb64-2" tabindex="-1"></a><span class="co">#&gt; [1] 0.271</span></span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="ip-weighting-and-marginal-structural-models.html#cb65-1" tabindex="-1"></a></span>
<span id="cb65-2"><a href="ip-weighting-and-marginal-structural-models.html#cb65-2" tabindex="-1"></a><span class="co"># Estimating parameters of a marginal structural mean model</span></span>
<span id="cb65-3"><a href="ip-weighting-and-marginal-structural-models.html#cb65-3" tabindex="-1"></a>msm.emm <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb65-4"><a href="ip-weighting-and-marginal-structural-models.html#cb65-4" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> <span class="fu">as.factor</span>(qsmk) <span class="sc">+</span> <span class="fu">as.factor</span>(sex)</span>
<span id="cb65-5"><a href="ip-weighting-and-marginal-structural-models.html#cb65-5" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">as.factor</span>(qsmk)<span class="sc">:</span><span class="fu">as.factor</span>(sex),</span>
<span id="cb65-6"><a href="ip-weighting-and-marginal-structural-models.html#cb65-6" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb65-7"><a href="ip-weighting-and-marginal-structural-models.html#cb65-7" tabindex="-1"></a>  <span class="at">weights =</span> sw.a,</span>
<span id="cb65-8"><a href="ip-weighting-and-marginal-structural-models.html#cb65-8" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb65-9"><a href="ip-weighting-and-marginal-structural-models.html#cb65-9" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb65-10"><a href="ip-weighting-and-marginal-structural-models.html#cb65-10" tabindex="-1"></a>)</span>
<span id="cb65-11"><a href="ip-weighting-and-marginal-structural-models.html#cb65-11" tabindex="-1"></a><span class="fu">summary</span>(msm.emm)</span>
<span id="cb65-12"><a href="ip-weighting-and-marginal-structural-models.html#cb65-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb65-13"><a href="ip-weighting-and-marginal-structural-models.html#cb65-13" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb65-14"><a href="ip-weighting-and-marginal-structural-models.html#cb65-14" tabindex="-1"></a><span class="co">#&gt; geeglm(formula = wt82_71 ~ as.factor(qsmk) + as.factor(sex) + </span></span>
<span id="cb65-15"><a href="ip-weighting-and-marginal-structural-models.html#cb65-15" tabindex="-1"></a><span class="co">#&gt;     as.factor(qsmk):as.factor(sex), data = nhefs.nmv, weights = sw.a, </span></span>
<span id="cb65-16"><a href="ip-weighting-and-marginal-structural-models.html#cb65-16" tabindex="-1"></a><span class="co">#&gt;     id = seqn, corstr = &quot;independence&quot;)</span></span>
<span id="cb65-17"><a href="ip-weighting-and-marginal-structural-models.html#cb65-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb65-18"><a href="ip-weighting-and-marginal-structural-models.html#cb65-18" tabindex="-1"></a><span class="co">#&gt;  Coefficients:</span></span>
<span id="cb65-19"><a href="ip-weighting-and-marginal-structural-models.html#cb65-19" tabindex="-1"></a><span class="co">#&gt;                                  Estimate  Std.err  Wald Pr(&gt;|W|)    </span></span>
<span id="cb65-20"><a href="ip-weighting-and-marginal-structural-models.html#cb65-20" tabindex="-1"></a><span class="co">#&gt; (Intercept)                       1.78445  0.30984 33.17  8.5e-09 ***</span></span>
<span id="cb65-21"><a href="ip-weighting-and-marginal-structural-models.html#cb65-21" tabindex="-1"></a><span class="co">#&gt; as.factor(qsmk)1                  3.52198  0.65707 28.73  8.3e-08 ***</span></span>
<span id="cb65-22"><a href="ip-weighting-and-marginal-structural-models.html#cb65-22" tabindex="-1"></a><span class="co">#&gt; as.factor(sex)1                  -0.00872  0.44882  0.00     0.98    </span></span>
<span id="cb65-23"><a href="ip-weighting-and-marginal-structural-models.html#cb65-23" tabindex="-1"></a><span class="co">#&gt; as.factor(qsmk)1:as.factor(sex)1 -0.15948  1.04608  0.02     0.88    </span></span>
<span id="cb65-24"><a href="ip-weighting-and-marginal-structural-models.html#cb65-24" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb65-25"><a href="ip-weighting-and-marginal-structural-models.html#cb65-25" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb65-26"><a href="ip-weighting-and-marginal-structural-models.html#cb65-26" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb65-27"><a href="ip-weighting-and-marginal-structural-models.html#cb65-27" tabindex="-1"></a><span class="co">#&gt; Correlation structure = independence </span></span>
<span id="cb65-28"><a href="ip-weighting-and-marginal-structural-models.html#cb65-28" tabindex="-1"></a><span class="co">#&gt; Estimated Scale Parameters:</span></span>
<span id="cb65-29"><a href="ip-weighting-and-marginal-structural-models.html#cb65-29" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb65-30"><a href="ip-weighting-and-marginal-structural-models.html#cb65-30" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err</span></span>
<span id="cb65-31"><a href="ip-weighting-and-marginal-structural-models.html#cb65-31" tabindex="-1"></a><span class="co">#&gt; (Intercept)     60.8    3.71</span></span>
<span id="cb65-32"><a href="ip-weighting-and-marginal-structural-models.html#cb65-32" tabindex="-1"></a><span class="co">#&gt; Number of clusters:   1566  Maximum cluster size: 1</span></span></code></pre></div>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="ip-weighting-and-marginal-structural-models.html#cb66-1" tabindex="-1"></a></span>
<span id="cb66-2"><a href="ip-weighting-and-marginal-structural-models.html#cb66-2" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.emm)</span>
<span id="cb66-3"><a href="ip-weighting-and-marginal-structural-models.html#cb66-3" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.emm))[, <span class="dv">2</span>]</span>
<span id="cb66-4"><a href="ip-weighting-and-marginal-structural-models.html#cb66-4" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb66-5"><a href="ip-weighting-and-marginal-structural-models.html#cb66-5" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb66-6"><a href="ip-weighting-and-marginal-structural-models.html#cb66-6" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span>
<span id="cb66-7"><a href="ip-weighting-and-marginal-structural-models.html#cb66-7" tabindex="-1"></a><span class="co">#&gt;                                      beta    lcl   ucl</span></span>
<span id="cb66-8"><a href="ip-weighting-and-marginal-structural-models.html#cb66-8" tabindex="-1"></a><span class="co">#&gt; (Intercept)                       1.78445  1.177 2.392</span></span>
<span id="cb66-9"><a href="ip-weighting-and-marginal-structural-models.html#cb66-9" tabindex="-1"></a><span class="co">#&gt; as.factor(qsmk)1                  3.52198  2.234 4.810</span></span>
<span id="cb66-10"><a href="ip-weighting-and-marginal-structural-models.html#cb66-10" tabindex="-1"></a><span class="co">#&gt; as.factor(sex)1                  -0.00872 -0.888 0.871</span></span>
<span id="cb66-11"><a href="ip-weighting-and-marginal-structural-models.html#cb66-11" tabindex="-1"></a><span class="co">#&gt; as.factor(qsmk)1:as.factor(sex)1 -0.15948 -2.210 1.891</span></span></code></pre></div>
</div>
<div id="program-12.7" class="section level2 hasAnchor">
<h2>Program 12.7<a href="ip-weighting-and-marginal-structural-models.html#program-12.7" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating IP weights to adjust for selection bias due to censoring</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="ip-weighting-and-marginal-structural-models.html#cb67-1" tabindex="-1"></a><span class="fu">table</span>(nhefs<span class="sc">$</span>qsmk, nhefs<span class="sc">$</span>cens)</span>
<span id="cb67-2"><a href="ip-weighting-and-marginal-structural-models.html#cb67-2" tabindex="-1"></a><span class="co">#&gt;    </span></span>
<span id="cb67-3"><a href="ip-weighting-and-marginal-structural-models.html#cb67-3" tabindex="-1"></a><span class="co">#&gt;        0    1</span></span>
<span id="cb67-4"><a href="ip-weighting-and-marginal-structural-models.html#cb67-4" tabindex="-1"></a><span class="co">#&gt;   0 1163   38</span></span>
<span id="cb67-5"><a href="ip-weighting-and-marginal-structural-models.html#cb67-5" tabindex="-1"></a><span class="co">#&gt;   1  403   25</span></span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="ip-weighting-and-marginal-structural-models.html#cb68-1" tabindex="-1"></a></span>
<span id="cb68-2"><a href="ip-weighting-and-marginal-structural-models.html#cb68-2" tabindex="-1"></a><span class="fu">summary</span>(nhefs[<span class="fu">which</span>(nhefs<span class="sc">$</span>cens <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>wt71)</span>
<span id="cb68-3"><a href="ip-weighting-and-marginal-structural-models.html#cb68-3" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb68-4"><a href="ip-weighting-and-marginal-structural-models.html#cb68-4" tabindex="-1"></a><span class="co">#&gt;    39.6    59.5    69.2    70.8    79.8   151.7</span></span></code></pre></div>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="ip-weighting-and-marginal-structural-models.html#cb69-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs[<span class="fu">which</span>(nhefs<span class="sc">$</span>cens <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>wt71)</span>
<span id="cb69-2"><a href="ip-weighting-and-marginal-structural-models.html#cb69-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb69-3"><a href="ip-weighting-and-marginal-structural-models.html#cb69-3" tabindex="-1"></a><span class="co">#&gt;    36.2    63.1    72.1    76.6    87.9   169.2</span></span></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="ip-weighting-and-marginal-structural-models.html#cb70-1" tabindex="-1"></a></span>
<span id="cb70-2"><a href="ip-weighting-and-marginal-structural-models.html#cb70-2" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights for A</span></span>
<span id="cb70-3"><a href="ip-weighting-and-marginal-structural-models.html#cb70-3" tabindex="-1"></a>denom.fit <span class="ot">&lt;-</span></span>
<span id="cb70-4"><a href="ip-weighting-and-marginal-structural-models.html#cb70-4" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb70-5"><a href="ip-weighting-and-marginal-structural-models.html#cb70-5" tabindex="-1"></a>    qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb70-6"><a href="ip-weighting-and-marginal-structural-models.html#cb70-6" tabindex="-1"></a>      <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb70-7"><a href="ip-weighting-and-marginal-structural-models.html#cb70-7" tabindex="-1"></a>      <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb70-8"><a href="ip-weighting-and-marginal-structural-models.html#cb70-8" tabindex="-1"></a>      <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb70-9"><a href="ip-weighting-and-marginal-structural-models.html#cb70-9" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb70-10"><a href="ip-weighting-and-marginal-structural-models.html#cb70-10" tabindex="-1"></a>    <span class="at">data =</span> nhefs</span>
<span id="cb70-11"><a href="ip-weighting-and-marginal-structural-models.html#cb70-11" tabindex="-1"></a>  )</span>
<span id="cb70-12"><a href="ip-weighting-and-marginal-structural-models.html#cb70-12" tabindex="-1"></a><span class="fu">summary</span>(denom.fit)</span>
<span id="cb70-13"><a href="ip-weighting-and-marginal-structural-models.html#cb70-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb70-14"><a href="ip-weighting-and-marginal-structural-models.html#cb70-14" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb70-15"><a href="ip-weighting-and-marginal-structural-models.html#cb70-15" tabindex="-1"></a><span class="co">#&gt; glm(formula = qsmk ~ as.factor(sex) + as.factor(race) + age + </span></span>
<span id="cb70-16"><a href="ip-weighting-and-marginal-structural-models.html#cb70-16" tabindex="-1"></a><span class="co">#&gt;     I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + </span></span>
<span id="cb70-17"><a href="ip-weighting-and-marginal-structural-models.html#cb70-17" tabindex="-1"></a><span class="co">#&gt;     smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + </span></span>
<span id="cb70-18"><a href="ip-weighting-and-marginal-structural-models.html#cb70-18" tabindex="-1"></a><span class="co">#&gt;     wt71 + I(wt71^2), family = binomial(), data = nhefs)</span></span>
<span id="cb70-19"><a href="ip-weighting-and-marginal-structural-models.html#cb70-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb70-20"><a href="ip-weighting-and-marginal-structural-models.html#cb70-20" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb70-21"><a href="ip-weighting-and-marginal-structural-models.html#cb70-21" tabindex="-1"></a><span class="co">#&gt;                        Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb70-22"><a href="ip-weighting-and-marginal-structural-models.html#cb70-22" tabindex="-1"></a><span class="co">#&gt; (Intercept)           -1.988902   1.241279   -1.60  0.10909    </span></span>
<span id="cb70-23"><a href="ip-weighting-and-marginal-structural-models.html#cb70-23" tabindex="-1"></a><span class="co">#&gt; as.factor(sex)1       -0.507522   0.148232   -3.42  0.00062 ***</span></span>
<span id="cb70-24"><a href="ip-weighting-and-marginal-structural-models.html#cb70-24" tabindex="-1"></a><span class="co">#&gt; as.factor(race)1      -0.850231   0.205872   -4.13  3.6e-05 ***</span></span>
<span id="cb70-25"><a href="ip-weighting-and-marginal-structural-models.html#cb70-25" tabindex="-1"></a><span class="co">#&gt; age                    0.103013   0.048900    2.11  0.03515 *  </span></span>
<span id="cb70-26"><a href="ip-weighting-and-marginal-structural-models.html#cb70-26" tabindex="-1"></a><span class="co">#&gt; I(age^2)              -0.000605   0.000507   -1.19  0.23297    </span></span>
<span id="cb70-27"><a href="ip-weighting-and-marginal-structural-models.html#cb70-27" tabindex="-1"></a><span class="co">#&gt; as.factor(education)2 -0.098320   0.190655   -0.52  0.60607    </span></span>
<span id="cb70-28"><a href="ip-weighting-and-marginal-structural-models.html#cb70-28" tabindex="-1"></a><span class="co">#&gt; as.factor(education)3  0.015699   0.170714    0.09  0.92673    </span></span>
<span id="cb70-29"><a href="ip-weighting-and-marginal-structural-models.html#cb70-29" tabindex="-1"></a><span class="co">#&gt; as.factor(education)4 -0.042526   0.264276   -0.16  0.87216    </span></span>
<span id="cb70-30"><a href="ip-weighting-and-marginal-structural-models.html#cb70-30" tabindex="-1"></a><span class="co">#&gt; as.factor(education)5  0.379663   0.220395    1.72  0.08495 .  </span></span>
<span id="cb70-31"><a href="ip-weighting-and-marginal-structural-models.html#cb70-31" tabindex="-1"></a><span class="co">#&gt; smokeintensity        -0.065156   0.014759   -4.41  1.0e-05 ***</span></span>
<span id="cb70-32"><a href="ip-weighting-and-marginal-structural-models.html#cb70-32" tabindex="-1"></a><span class="co">#&gt; I(smokeintensity^2)    0.000846   0.000276    3.07  0.00216 ** </span></span>
<span id="cb70-33"><a href="ip-weighting-and-marginal-structural-models.html#cb70-33" tabindex="-1"></a><span class="co">#&gt; smokeyrs              -0.073371   0.026996   -2.72  0.00657 ** </span></span>
<span id="cb70-34"><a href="ip-weighting-and-marginal-structural-models.html#cb70-34" tabindex="-1"></a><span class="co">#&gt; I(smokeyrs^2)          0.000838   0.000443    1.89  0.05867 .  </span></span>
<span id="cb70-35"><a href="ip-weighting-and-marginal-structural-models.html#cb70-35" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)1   0.291412   0.173554    1.68  0.09314 .  </span></span>
<span id="cb70-36"><a href="ip-weighting-and-marginal-structural-models.html#cb70-36" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)2   0.355052   0.179929    1.97  0.04846 *  </span></span>
<span id="cb70-37"><a href="ip-weighting-and-marginal-structural-models.html#cb70-37" tabindex="-1"></a><span class="co">#&gt; as.factor(active)1     0.010875   0.129832    0.08  0.93324    </span></span>
<span id="cb70-38"><a href="ip-weighting-and-marginal-structural-models.html#cb70-38" tabindex="-1"></a><span class="co">#&gt; as.factor(active)2     0.068312   0.208727    0.33  0.74346    </span></span>
<span id="cb70-39"><a href="ip-weighting-and-marginal-structural-models.html#cb70-39" tabindex="-1"></a><span class="co">#&gt; wt71                  -0.012848   0.022283   -0.58  0.56423    </span></span>
<span id="cb70-40"><a href="ip-weighting-and-marginal-structural-models.html#cb70-40" tabindex="-1"></a><span class="co">#&gt; I(wt71^2)              0.000121   0.000135    0.89  0.37096    </span></span>
<span id="cb70-41"><a href="ip-weighting-and-marginal-structural-models.html#cb70-41" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb70-42"><a href="ip-weighting-and-marginal-structural-models.html#cb70-42" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb70-43"><a href="ip-weighting-and-marginal-structural-models.html#cb70-43" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb70-44"><a href="ip-weighting-and-marginal-structural-models.html#cb70-44" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb70-45"><a href="ip-weighting-and-marginal-structural-models.html#cb70-45" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb70-46"><a href="ip-weighting-and-marginal-structural-models.html#cb70-46" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 1876.3  on 1628  degrees of freedom</span></span>
<span id="cb70-47"><a href="ip-weighting-and-marginal-structural-models.html#cb70-47" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 1766.7  on 1610  degrees of freedom</span></span>
<span id="cb70-48"><a href="ip-weighting-and-marginal-structural-models.html#cb70-48" tabindex="-1"></a><span class="co">#&gt; AIC: 1805</span></span>
<span id="cb70-49"><a href="ip-weighting-and-marginal-structural-models.html#cb70-49" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb70-50"><a href="ip-weighting-and-marginal-structural-models.html#cb70-50" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="ip-weighting-and-marginal-structural-models.html#cb71-1" tabindex="-1"></a></span>
<span id="cb71-2"><a href="ip-weighting-and-marginal-structural-models.html#cb71-2" tabindex="-1"></a>pd.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(denom.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb71-3"><a href="ip-weighting-and-marginal-structural-models.html#cb71-3" tabindex="-1"></a></span>
<span id="cb71-4"><a href="ip-weighting-and-marginal-structural-models.html#cb71-4" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights for A</span></span>
<span id="cb71-5"><a href="ip-weighting-and-marginal-structural-models.html#cb71-5" tabindex="-1"></a>numer.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs)</span>
<span id="cb71-6"><a href="ip-weighting-and-marginal-structural-models.html#cb71-6" tabindex="-1"></a><span class="fu">summary</span>(numer.fit)</span>
<span id="cb71-7"><a href="ip-weighting-and-marginal-structural-models.html#cb71-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb71-8"><a href="ip-weighting-and-marginal-structural-models.html#cb71-8" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb71-9"><a href="ip-weighting-and-marginal-structural-models.html#cb71-9" tabindex="-1"></a><span class="co">#&gt; glm(formula = qsmk ~ 1, family = binomial(), data = nhefs)</span></span>
<span id="cb71-10"><a href="ip-weighting-and-marginal-structural-models.html#cb71-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb71-11"><a href="ip-weighting-and-marginal-structural-models.html#cb71-11" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb71-12"><a href="ip-weighting-and-marginal-structural-models.html#cb71-12" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb71-13"><a href="ip-weighting-and-marginal-structural-models.html#cb71-13" tabindex="-1"></a><span class="co">#&gt; (Intercept)  -1.0318     0.0563   -18.3   &lt;2e-16 ***</span></span>
<span id="cb71-14"><a href="ip-weighting-and-marginal-structural-models.html#cb71-14" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb71-15"><a href="ip-weighting-and-marginal-structural-models.html#cb71-15" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb71-16"><a href="ip-weighting-and-marginal-structural-models.html#cb71-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb71-17"><a href="ip-weighting-and-marginal-structural-models.html#cb71-17" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb71-18"><a href="ip-weighting-and-marginal-structural-models.html#cb71-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb71-19"><a href="ip-weighting-and-marginal-structural-models.html#cb71-19" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 1876.3  on 1628  degrees of freedom</span></span>
<span id="cb71-20"><a href="ip-weighting-and-marginal-structural-models.html#cb71-20" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 1876.3  on 1628  degrees of freedom</span></span>
<span id="cb71-21"><a href="ip-weighting-and-marginal-structural-models.html#cb71-21" tabindex="-1"></a><span class="co">#&gt; AIC: 1878</span></span>
<span id="cb71-22"><a href="ip-weighting-and-marginal-structural-models.html#cb71-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb71-23"><a href="ip-weighting-and-marginal-structural-models.html#cb71-23" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span></code></pre></div>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="ip-weighting-and-marginal-structural-models.html#cb72-1" tabindex="-1"></a>pn.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(numer.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb72-2"><a href="ip-weighting-and-marginal-structural-models.html#cb72-2" tabindex="-1"></a></span>
<span id="cb72-3"><a href="ip-weighting-and-marginal-structural-models.html#cb72-3" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights for C</span></span>
<span id="cb72-4"><a href="ip-weighting-and-marginal-structural-models.html#cb72-4" tabindex="-1"></a>denom.cens <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb72-5"><a href="ip-weighting-and-marginal-structural-models.html#cb72-5" tabindex="-1"></a>  cens <span class="sc">~</span> <span class="fu">as.factor</span>(qsmk) <span class="sc">+</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span></span>
<span id="cb72-6"><a href="ip-weighting-and-marginal-structural-models.html#cb72-6" tabindex="-1"></a>    <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb72-7"><a href="ip-weighting-and-marginal-structural-models.html#cb72-7" tabindex="-1"></a>    <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb72-8"><a href="ip-weighting-and-marginal-structural-models.html#cb72-8" tabindex="-1"></a>    <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb72-9"><a href="ip-weighting-and-marginal-structural-models.html#cb72-9" tabindex="-1"></a>    <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb72-10"><a href="ip-weighting-and-marginal-structural-models.html#cb72-10" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb72-11"><a href="ip-weighting-and-marginal-structural-models.html#cb72-11" tabindex="-1"></a>  <span class="at">data =</span> nhefs</span>
<span id="cb72-12"><a href="ip-weighting-and-marginal-structural-models.html#cb72-12" tabindex="-1"></a>)</span>
<span id="cb72-13"><a href="ip-weighting-and-marginal-structural-models.html#cb72-13" tabindex="-1"></a><span class="fu">summary</span>(denom.cens)</span>
<span id="cb72-14"><a href="ip-weighting-and-marginal-structural-models.html#cb72-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb72-15"><a href="ip-weighting-and-marginal-structural-models.html#cb72-15" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb72-16"><a href="ip-weighting-and-marginal-structural-models.html#cb72-16" tabindex="-1"></a><span class="co">#&gt; glm(formula = cens ~ as.factor(qsmk) + as.factor(sex) + as.factor(race) + </span></span>
<span id="cb72-17"><a href="ip-weighting-and-marginal-structural-models.html#cb72-17" tabindex="-1"></a><span class="co">#&gt;     age + I(age^2) + as.factor(education) + smokeintensity + </span></span>
<span id="cb72-18"><a href="ip-weighting-and-marginal-structural-models.html#cb72-18" tabindex="-1"></a><span class="co">#&gt;     I(smokeintensity^2) + smokeyrs + I(smokeyrs^2) + as.factor(exercise) + </span></span>
<span id="cb72-19"><a href="ip-weighting-and-marginal-structural-models.html#cb72-19" tabindex="-1"></a><span class="co">#&gt;     as.factor(active) + wt71 + I(wt71^2), family = binomial(), </span></span>
<span id="cb72-20"><a href="ip-weighting-and-marginal-structural-models.html#cb72-20" tabindex="-1"></a><span class="co">#&gt;     data = nhefs)</span></span>
<span id="cb72-21"><a href="ip-weighting-and-marginal-structural-models.html#cb72-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb72-22"><a href="ip-weighting-and-marginal-structural-models.html#cb72-22" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb72-23"><a href="ip-weighting-and-marginal-structural-models.html#cb72-23" tabindex="-1"></a><span class="co">#&gt;                        Estimate Std. Error z value Pr(&gt;|z|)   </span></span>
<span id="cb72-24"><a href="ip-weighting-and-marginal-structural-models.html#cb72-24" tabindex="-1"></a><span class="co">#&gt; (Intercept)            4.014466   2.576106    1.56   0.1192   </span></span>
<span id="cb72-25"><a href="ip-weighting-and-marginal-structural-models.html#cb72-25" tabindex="-1"></a><span class="co">#&gt; as.factor(qsmk)1       0.516867   0.287716    1.80   0.0724 . </span></span>
<span id="cb72-26"><a href="ip-weighting-and-marginal-structural-models.html#cb72-26" tabindex="-1"></a><span class="co">#&gt; as.factor(sex)1        0.057313   0.330278    0.17   0.8622   </span></span>
<span id="cb72-27"><a href="ip-weighting-and-marginal-structural-models.html#cb72-27" tabindex="-1"></a><span class="co">#&gt; as.factor(race)1      -0.012271   0.452489   -0.03   0.9784   </span></span>
<span id="cb72-28"><a href="ip-weighting-and-marginal-structural-models.html#cb72-28" tabindex="-1"></a><span class="co">#&gt; age                   -0.269729   0.117465   -2.30   0.0217 * </span></span>
<span id="cb72-29"><a href="ip-weighting-and-marginal-structural-models.html#cb72-29" tabindex="-1"></a><span class="co">#&gt; I(age^2)               0.002884   0.001114    2.59   0.0096 **</span></span>
<span id="cb72-30"><a href="ip-weighting-and-marginal-structural-models.html#cb72-30" tabindex="-1"></a><span class="co">#&gt; as.factor(education)2 -0.440788   0.419399   -1.05   0.2933   </span></span>
<span id="cb72-31"><a href="ip-weighting-and-marginal-structural-models.html#cb72-31" tabindex="-1"></a><span class="co">#&gt; as.factor(education)3 -0.164688   0.370547   -0.44   0.6567   </span></span>
<span id="cb72-32"><a href="ip-weighting-and-marginal-structural-models.html#cb72-32" tabindex="-1"></a><span class="co">#&gt; as.factor(education)4  0.138447   0.569797    0.24   0.8080   </span></span>
<span id="cb72-33"><a href="ip-weighting-and-marginal-structural-models.html#cb72-33" tabindex="-1"></a><span class="co">#&gt; as.factor(education)5 -0.382382   0.560181   -0.68   0.4949   </span></span>
<span id="cb72-34"><a href="ip-weighting-and-marginal-structural-models.html#cb72-34" tabindex="-1"></a><span class="co">#&gt; smokeintensity         0.015712   0.034732    0.45   0.6510   </span></span>
<span id="cb72-35"><a href="ip-weighting-and-marginal-structural-models.html#cb72-35" tabindex="-1"></a><span class="co">#&gt; I(smokeintensity^2)   -0.000113   0.000606   -0.19   0.8517   </span></span>
<span id="cb72-36"><a href="ip-weighting-and-marginal-structural-models.html#cb72-36" tabindex="-1"></a><span class="co">#&gt; smokeyrs               0.078597   0.074958    1.05   0.2944   </span></span>
<span id="cb72-37"><a href="ip-weighting-and-marginal-structural-models.html#cb72-37" tabindex="-1"></a><span class="co">#&gt; I(smokeyrs^2)         -0.000557   0.001032   -0.54   0.5894   </span></span>
<span id="cb72-38"><a href="ip-weighting-and-marginal-structural-models.html#cb72-38" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)1  -0.971471   0.387810   -2.51   0.0122 * </span></span>
<span id="cb72-39"><a href="ip-weighting-and-marginal-structural-models.html#cb72-39" tabindex="-1"></a><span class="co">#&gt; as.factor(exercise)2  -0.583989   0.372313   -1.57   0.1168   </span></span>
<span id="cb72-40"><a href="ip-weighting-and-marginal-structural-models.html#cb72-40" tabindex="-1"></a><span class="co">#&gt; as.factor(active)1    -0.247479   0.325455   -0.76   0.4470   </span></span>
<span id="cb72-41"><a href="ip-weighting-and-marginal-structural-models.html#cb72-41" tabindex="-1"></a><span class="co">#&gt; as.factor(active)2     0.706583   0.396458    1.78   0.0747 . </span></span>
<span id="cb72-42"><a href="ip-weighting-and-marginal-structural-models.html#cb72-42" tabindex="-1"></a><span class="co">#&gt; wt71                  -0.087887   0.040012   -2.20   0.0281 * </span></span>
<span id="cb72-43"><a href="ip-weighting-and-marginal-structural-models.html#cb72-43" tabindex="-1"></a><span class="co">#&gt; I(wt71^2)              0.000635   0.000226    2.81   0.0049 **</span></span>
<span id="cb72-44"><a href="ip-weighting-and-marginal-structural-models.html#cb72-44" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb72-45"><a href="ip-weighting-and-marginal-structural-models.html#cb72-45" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb72-46"><a href="ip-weighting-and-marginal-structural-models.html#cb72-46" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb72-47"><a href="ip-weighting-and-marginal-structural-models.html#cb72-47" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb72-48"><a href="ip-weighting-and-marginal-structural-models.html#cb72-48" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb72-49"><a href="ip-weighting-and-marginal-structural-models.html#cb72-49" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 533.36  on 1628  degrees of freedom</span></span>
<span id="cb72-50"><a href="ip-weighting-and-marginal-structural-models.html#cb72-50" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 465.36  on 1609  degrees of freedom</span></span>
<span id="cb72-51"><a href="ip-weighting-and-marginal-structural-models.html#cb72-51" tabindex="-1"></a><span class="co">#&gt; AIC: 505.4</span></span>
<span id="cb72-52"><a href="ip-weighting-and-marginal-structural-models.html#cb72-52" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb72-53"><a href="ip-weighting-and-marginal-structural-models.html#cb72-53" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 7</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="ip-weighting-and-marginal-structural-models.html#cb73-1" tabindex="-1"></a></span>
<span id="cb73-2"><a href="ip-weighting-and-marginal-structural-models.html#cb73-2" tabindex="-1"></a>pd.cens <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(denom.cens, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb73-3"><a href="ip-weighting-and-marginal-structural-models.html#cb73-3" tabindex="-1"></a></span>
<span id="cb73-4"><a href="ip-weighting-and-marginal-structural-models.html#cb73-4" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights for C</span></span>
<span id="cb73-5"><a href="ip-weighting-and-marginal-structural-models.html#cb73-5" tabindex="-1"></a>numer.cens <span class="ot">&lt;-</span></span>
<span id="cb73-6"><a href="ip-weighting-and-marginal-structural-models.html#cb73-6" tabindex="-1"></a>  <span class="fu">glm</span>(cens <span class="sc">~</span> <span class="fu">as.factor</span>(qsmk), <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs)</span>
<span id="cb73-7"><a href="ip-weighting-and-marginal-structural-models.html#cb73-7" tabindex="-1"></a><span class="fu">summary</span>(numer.cens)</span>
<span id="cb73-8"><a href="ip-weighting-and-marginal-structural-models.html#cb73-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb73-9"><a href="ip-weighting-and-marginal-structural-models.html#cb73-9" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb73-10"><a href="ip-weighting-and-marginal-structural-models.html#cb73-10" tabindex="-1"></a><span class="co">#&gt; glm(formula = cens ~ as.factor(qsmk), family = binomial(), data = nhefs)</span></span>
<span id="cb73-11"><a href="ip-weighting-and-marginal-structural-models.html#cb73-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb73-12"><a href="ip-weighting-and-marginal-structural-models.html#cb73-12" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb73-13"><a href="ip-weighting-and-marginal-structural-models.html#cb73-13" tabindex="-1"></a><span class="co">#&gt;                  Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb73-14"><a href="ip-weighting-and-marginal-structural-models.html#cb73-14" tabindex="-1"></a><span class="co">#&gt; (Intercept)        -3.421      0.165  -20.75   &lt;2e-16 ***</span></span>
<span id="cb73-15"><a href="ip-weighting-and-marginal-structural-models.html#cb73-15" tabindex="-1"></a><span class="co">#&gt; as.factor(qsmk)1    0.641      0.264    2.43    0.015 *  </span></span>
<span id="cb73-16"><a href="ip-weighting-and-marginal-structural-models.html#cb73-16" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb73-17"><a href="ip-weighting-and-marginal-structural-models.html#cb73-17" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb73-18"><a href="ip-weighting-and-marginal-structural-models.html#cb73-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb73-19"><a href="ip-weighting-and-marginal-structural-models.html#cb73-19" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb73-20"><a href="ip-weighting-and-marginal-structural-models.html#cb73-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb73-21"><a href="ip-weighting-and-marginal-structural-models.html#cb73-21" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 533.36  on 1628  degrees of freedom</span></span>
<span id="cb73-22"><a href="ip-weighting-and-marginal-structural-models.html#cb73-22" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 527.76  on 1627  degrees of freedom</span></span>
<span id="cb73-23"><a href="ip-weighting-and-marginal-structural-models.html#cb73-23" tabindex="-1"></a><span class="co">#&gt; AIC: 531.8</span></span>
<span id="cb73-24"><a href="ip-weighting-and-marginal-structural-models.html#cb73-24" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb73-25"><a href="ip-weighting-and-marginal-structural-models.html#cb73-25" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 6</span></span></code></pre></div>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="ip-weighting-and-marginal-structural-models.html#cb74-1" tabindex="-1"></a>pn.cens <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(numer.cens, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb74-2"><a href="ip-weighting-and-marginal-structural-models.html#cb74-2" tabindex="-1"></a></span>
<span id="cb74-3"><a href="ip-weighting-and-marginal-structural-models.html#cb74-3" tabindex="-1"></a>nhefs<span class="sc">$</span>sw.a <span class="ot">&lt;-</span></span>
<span id="cb74-4"><a href="ip-weighting-and-marginal-structural-models.html#cb74-4" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>, ((<span class="dv">1</span> <span class="sc">-</span> pn.qsmk) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pd.qsmk)),</span>
<span id="cb74-5"><a href="ip-weighting-and-marginal-structural-models.html#cb74-5" tabindex="-1"></a>         (pn.qsmk <span class="sc">/</span> pd.qsmk))</span>
<span id="cb74-6"><a href="ip-weighting-and-marginal-structural-models.html#cb74-6" tabindex="-1"></a>nhefs<span class="sc">$</span>sw.c <span class="ot">&lt;-</span> pn.cens <span class="sc">/</span> pd.cens</span>
<span id="cb74-7"><a href="ip-weighting-and-marginal-structural-models.html#cb74-7" tabindex="-1"></a>nhefs<span class="sc">$</span>sw <span class="ot">&lt;-</span> nhefs<span class="sc">$</span>sw.c <span class="sc">*</span> nhefs<span class="sc">$</span>sw.a</span>
<span id="cb74-8"><a href="ip-weighting-and-marginal-structural-models.html#cb74-8" tabindex="-1"></a></span>
<span id="cb74-9"><a href="ip-weighting-and-marginal-structural-models.html#cb74-9" tabindex="-1"></a><span class="fu">summary</span>(nhefs<span class="sc">$</span>sw.a)</span>
<span id="cb74-10"><a href="ip-weighting-and-marginal-structural-models.html#cb74-10" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb74-11"><a href="ip-weighting-and-marginal-structural-models.html#cb74-11" tabindex="-1"></a><span class="co">#&gt;    0.33    0.86    0.95    1.00    1.08    4.21</span></span></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="ip-weighting-and-marginal-structural-models.html#cb75-1" tabindex="-1"></a><span class="fu">sd</span>(nhefs<span class="sc">$</span>sw.a)</span>
<span id="cb75-2"><a href="ip-weighting-and-marginal-structural-models.html#cb75-2" tabindex="-1"></a><span class="co">#&gt; [1] 0.284</span></span></code></pre></div>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="ip-weighting-and-marginal-structural-models.html#cb76-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs<span class="sc">$</span>sw.c)</span>
<span id="cb76-2"><a href="ip-weighting-and-marginal-structural-models.html#cb76-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb76-3"><a href="ip-weighting-and-marginal-structural-models.html#cb76-3" tabindex="-1"></a><span class="co">#&gt;    0.94    0.98    0.99    1.01    1.01    7.58</span></span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="ip-weighting-and-marginal-structural-models.html#cb77-1" tabindex="-1"></a><span class="fu">sd</span>(nhefs<span class="sc">$</span>sw.c)</span>
<span id="cb77-2"><a href="ip-weighting-and-marginal-structural-models.html#cb77-2" tabindex="-1"></a><span class="co">#&gt; [1] 0.178</span></span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="ip-weighting-and-marginal-structural-models.html#cb78-1" tabindex="-1"></a><span class="fu">summary</span>(nhefs<span class="sc">$</span>sw)</span>
<span id="cb78-2"><a href="ip-weighting-and-marginal-structural-models.html#cb78-2" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb78-3"><a href="ip-weighting-and-marginal-structural-models.html#cb78-3" tabindex="-1"></a><span class="co">#&gt;    0.35    0.86    0.94    1.01    1.08   12.86</span></span></code></pre></div>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="ip-weighting-and-marginal-structural-models.html#cb79-1" tabindex="-1"></a><span class="fu">sd</span>(nhefs<span class="sc">$</span>sw)</span>
<span id="cb79-2"><a href="ip-weighting-and-marginal-structural-models.html#cb79-2" tabindex="-1"></a><span class="co">#&gt; [1] 0.411</span></span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="ip-weighting-and-marginal-structural-models.html#cb80-1" tabindex="-1"></a></span>
<span id="cb80-2"><a href="ip-weighting-and-marginal-structural-models.html#cb80-2" tabindex="-1"></a>msm.sw <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb80-3"><a href="ip-weighting-and-marginal-structural-models.html#cb80-3" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> qsmk,</span>
<span id="cb80-4"><a href="ip-weighting-and-marginal-structural-models.html#cb80-4" tabindex="-1"></a>  <span class="at">data =</span> nhefs,</span>
<span id="cb80-5"><a href="ip-weighting-and-marginal-structural-models.html#cb80-5" tabindex="-1"></a>  <span class="at">weights =</span> sw,</span>
<span id="cb80-6"><a href="ip-weighting-and-marginal-structural-models.html#cb80-6" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb80-7"><a href="ip-weighting-and-marginal-structural-models.html#cb80-7" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb80-8"><a href="ip-weighting-and-marginal-structural-models.html#cb80-8" tabindex="-1"></a>)</span>
<span id="cb80-9"><a href="ip-weighting-and-marginal-structural-models.html#cb80-9" tabindex="-1"></a><span class="fu">summary</span>(msm.sw)</span>
<span id="cb80-10"><a href="ip-weighting-and-marginal-structural-models.html#cb80-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb80-11"><a href="ip-weighting-and-marginal-structural-models.html#cb80-11" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb80-12"><a href="ip-weighting-and-marginal-structural-models.html#cb80-12" tabindex="-1"></a><span class="co">#&gt; geeglm(formula = wt82_71 ~ qsmk, data = nhefs, weights = sw, </span></span>
<span id="cb80-13"><a href="ip-weighting-and-marginal-structural-models.html#cb80-13" tabindex="-1"></a><span class="co">#&gt;     id = seqn, corstr = &quot;independence&quot;)</span></span>
<span id="cb80-14"><a href="ip-weighting-and-marginal-structural-models.html#cb80-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb80-15"><a href="ip-weighting-and-marginal-structural-models.html#cb80-15" tabindex="-1"></a><span class="co">#&gt;  Coefficients:</span></span>
<span id="cb80-16"><a href="ip-weighting-and-marginal-structural-models.html#cb80-16" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err Wald Pr(&gt;|W|)    </span></span>
<span id="cb80-17"><a href="ip-weighting-and-marginal-structural-models.html#cb80-17" tabindex="-1"></a><span class="co">#&gt; (Intercept)    1.662   0.233 51.0  9.3e-13 ***</span></span>
<span id="cb80-18"><a href="ip-weighting-and-marginal-structural-models.html#cb80-18" tabindex="-1"></a><span class="co">#&gt; qsmk           3.496   0.526 44.2  2.9e-11 ***</span></span>
<span id="cb80-19"><a href="ip-weighting-and-marginal-structural-models.html#cb80-19" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb80-20"><a href="ip-weighting-and-marginal-structural-models.html#cb80-20" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb80-21"><a href="ip-weighting-and-marginal-structural-models.html#cb80-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb80-22"><a href="ip-weighting-and-marginal-structural-models.html#cb80-22" tabindex="-1"></a><span class="co">#&gt; Correlation structure = independence </span></span>
<span id="cb80-23"><a href="ip-weighting-and-marginal-structural-models.html#cb80-23" tabindex="-1"></a><span class="co">#&gt; Estimated Scale Parameters:</span></span>
<span id="cb80-24"><a href="ip-weighting-and-marginal-structural-models.html#cb80-24" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb80-25"><a href="ip-weighting-and-marginal-structural-models.html#cb80-25" tabindex="-1"></a><span class="co">#&gt;             Estimate Std.err</span></span>
<span id="cb80-26"><a href="ip-weighting-and-marginal-structural-models.html#cb80-26" tabindex="-1"></a><span class="co">#&gt; (Intercept)     61.8    3.83</span></span>
<span id="cb80-27"><a href="ip-weighting-and-marginal-structural-models.html#cb80-27" tabindex="-1"></a><span class="co">#&gt; Number of clusters:   1566  Maximum cluster size: 1</span></span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="ip-weighting-and-marginal-structural-models.html#cb81-1" tabindex="-1"></a></span>
<span id="cb81-2"><a href="ip-weighting-and-marginal-structural-models.html#cb81-2" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.sw)</span>
<span id="cb81-3"><a href="ip-weighting-and-marginal-structural-models.html#cb81-3" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.sw))[, <span class="dv">2</span>]</span>
<span id="cb81-4"><a href="ip-weighting-and-marginal-structural-models.html#cb81-4" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb81-5"><a href="ip-weighting-and-marginal-structural-models.html#cb81-5" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb81-6"><a href="ip-weighting-and-marginal-structural-models.html#cb81-6" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span>
<span id="cb81-7"><a href="ip-weighting-and-marginal-structural-models.html#cb81-7" tabindex="-1"></a><span class="co">#&gt;             beta  lcl  ucl</span></span>
<span id="cb81-8"><a href="ip-weighting-and-marginal-structural-models.html#cb81-8" tabindex="-1"></a><span class="co">#&gt; (Intercept) 1.66 1.21 2.12</span></span>
<span id="cb81-9"><a href="ip-weighting-and-marginal-structural-models.html#cb81-9" tabindex="-1"></a><span class="co">#&gt; qsmk        3.50 2.47 4.53</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="why-model.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="standardization-and-the-parametric-g-formula.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/remlapmot/cibookex-r/edit/master/12-ipw-msm-r.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/remlapmot/cibookex-r/blob/master/12-ipw-msm-r.Rmd",
"text": null
},
"download": ["cibookex-r.pdf", "cibookex-r.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
