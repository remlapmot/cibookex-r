<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>15. Outcome regression and propensity scores: Stata | Causal Inference: What If. R and Stata code for Exercises</title>
  <meta name="description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="15. Outcome regression and propensity scores: Stata | Causal Inference: What If. R and Stata code for Exercises" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="15. Outcome regression and propensity scores: Stata | Causal Inference: What If. R and Stata code for Exercises" />
  
  <meta name="twitter:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

<meta name="author" content="Book by M. A. Hern치n and J. M. Robins" />
<meta name="author" content="R code by Joy Shi and Sean McGrath" />
<meta name="author" content="Stata code by Eleanor Murray and Roger Logan" />
<meta name="author" content="R Markdown code by Tom Palmer" />


<meta name="date" content="2020-04-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="g-estimation-of-structural-nested-models-stata.html"/>
<link rel="next" href="instrumental-variables-estimation-stata.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Table of Contents</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#packages-to-install"><i class="fa fa-check"></i>Packages to install</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-datasets"><i class="fa fa-check"></i>Downloading the datasets</a></li>
</ul></li>
<li class="part"><span><b>R code</b></span></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html"><i class="fa fa-check"></i>11. Why model?</a><ul>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.2"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.3"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models</a><ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.2"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.3"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.4"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.5"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.6"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.7"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula</a><ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.2"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.3"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.4"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models</a><ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.2"><i class="fa fa-check"></i>Program 14.2</a><ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-one-possible-value-of-psi"><i class="fa fa-check"></i>G-estimation: Checking one possible value of psi</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-multiple-possible-values-of-psi"><i class="fa fa-check"></i>G-estimation: Checking multiple possible values of psi</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.3"><i class="fa fa-check"></i>Program 14.3</a><ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-linear-mean-models"><i class="fa fa-check"></i>G-estimation: Closed form estimator linear mean models</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-for-2-parameter-model"><i class="fa fa-check"></i>G-estimation: Closed form estimator for 2-parameter model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores</a><ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.2"><i class="fa fa-check"></i>Program 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.3"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.4"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html"><i class="fa fa-check"></i>16. Instrumental variables estimation</a><ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.2"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.3"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.4"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.5"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html"><i class="fa fa-check"></i>17. Causal survival analysis</a><ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.2"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.3"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.4"><i class="fa fa-check"></i>Program 17.4</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.5"><i class="fa fa-check"></i>Program 17.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-r.html"><a href="session-information-r.html"><i class="fa fa-check"></i>Session information: R</a></li>
<li class="part"><span><b>Stata code</b></span></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html"><i class="fa fa-check"></i>11. Why model: Stata</a><ul>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.1-1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.2-1"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.3-1"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models: Stata</a><ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.1-1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.2-1"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.3-1"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.4-1"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.5-1"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.6-1"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.7-1"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula: Stata</a><ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.1-1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.2-1"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.3-1"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.4-1"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models: Stata</a><ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.1-1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.2-1"><i class="fa fa-check"></i>Program 14.2</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.3-1"><i class="fa fa-check"></i>Program 14.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores: Stata</a><ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.1-1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#prorgam-15.2"><i class="fa fa-check"></i>Prorgam 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.3-1"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.4-1"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html"><i class="fa fa-check"></i>16. Instrumental variables estimation: Stata</a><ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.1-1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.2-1"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.3-1"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.4-1"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.5-1"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html"><i class="fa fa-check"></i>17. Causal survival analysis: Stata</a><ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.1-1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.2-1"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.3-1"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.4-1"><i class="fa fa-check"></i>Program 17.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-stata.html"><a href="session-information-stata.html"><i class="fa fa-check"></i>Session information: Stata</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Causal Inference: What If. R and Stata code for Exercises</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="outcome-regression-and-propensity-scores-stata" class="section level1 unnumbered">
<h1>15. Outcome regression and propensity scores: Stata</h1>
<div class="sourceCode" id="cb385"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb385-1"><a href="outcome-regression-and-propensity-scores-stata.html#cb385-1"></a><span class="kw">library</span>(Statamarkdown)</span></code></pre></div>
<pre><code>/***************************************************************
Stata code for Causal Inference: What If by Miguel Hernan &amp; Jamie Robins
Date: 10/10/2019
Author: Eleanor Murray 
For errors contact: ejmurray@bu.edu
***************************************************************/</code></pre>
<div id="program-15.1-1" class="section level2">
<h2>Program 15.1</h2>
<ul>
<li>Estimating the average causal effect within levels of confounders under the assumption of effect-measure modification by smoking intensity ONLY</li>
<li>Data from NHEFS</li>
<li>Section 15.1</li>
</ul>
<div class="sourceCode" id="cb387"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb387-1"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">clear</span></span>
<span id="cb387-2"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-2"></a></span>
<span id="cb387-3"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-3"></a><span class="co">/* Generate smoking intensity among smokers product term */</span></span>
<span id="cb387-4"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-4"></a><span class="kw">gen</span> qsmkintensity = qsmk*smokeintensity</span>
<span id="cb387-5"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-5"></a></span>
<span id="cb387-6"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-6"></a>* Regression <span class="kw">on</span> covariates, allowing <span class="kw">for</span> some effect modfication</span>
<span id="cb387-7"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-7"></a><span class="kw">regress</span> wt82_71 qsmk qsmkintensity <span class="co">///</span></span>
<span id="cb387-8"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-8"></a>  c.smokeintensity##c.smokeintensity sex race c.age##c.age <span class="co">///</span></span>
<span id="cb387-9"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-9"></a>  ib(<span class="fu">last</span>).education c.smokeyrs##c.smokeyrs <span class="co">///</span></span>
<span id="cb387-10"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-10"></a>  ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71 </span>
<span id="cb387-11"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-11"></a></span>
<span id="cb387-12"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-12"></a><span class="co">/* Display the estimated mean difference between quitting and </span></span>
<span id="cb387-13"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-13"></a><span class="co">  not quitting value when smoke intensity = 5 cigarettes/ day */</span></span>
<span id="cb387-14"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-14"></a><span class="kw">lincom</span> 1*_b[qsmk] + 5*1*_b[qsmkintensity] </span>
<span id="cb387-15"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-15"></a></span>
<span id="cb387-16"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-16"></a><span class="co">/* Display the estimated mean difference between quitting and </span></span>
<span id="cb387-17"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-17"></a><span class="co">  not quitting value when smoke intensity = 40 cigarettes/ day */</span></span>
<span id="cb387-18"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-18"></a><span class="kw">lincom</span> 1*_b[qsmk] + 40*1*_b[qsmkintensity]</span>
<span id="cb387-19"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-19"></a></span>
<span id="cb387-20"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-20"></a><span class="co">/* Regression on covariates, with no product terms */</span></span>
<span id="cb387-21"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-21"></a><span class="kw">regress</span> wt82_71 qsmk c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb387-22"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-22"></a>  sex race c.age##c.age <span class="co">///</span></span>
<span id="cb387-23"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-23"></a>  ib(<span class="fu">last</span>).education c.smokeyrs##c.smokeyrs <span class="co">///</span></span>
<span id="cb387-24"><a href="outcome-regression-and-propensity-scores-stata.html#cb387-24"></a>  ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active c.wt71##c.wt71 </span></code></pre></div>
<pre><code>      Source |       SS           df       MS      Number of obs   =     1,566
-------------+----------------------------------   F(20, 1545)     =     13.45
       Model |   14412.558        20    720.6279   Prob &gt; F        =    0.0000
    Residual |  82763.0286     1,545  53.5683033   R-squared       =    0.1483
-------------+----------------------------------   Adj R-squared   =    0.1373
       Total |  97175.5866     1,565  62.0930266   Root MSE        =     7.319

------------------------------------------------------------------------------
     wt82_71 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        qsmk |   2.559594   .8091486     3.16   0.002     .9724486     4.14674
qsmkintens~y |   .0466628   .0351448     1.33   0.184    -.0222737    .1155993
smokeinten~y |   .0491365   .0517254     0.95   0.342     -.052323    .1505959
             |
          c. |
smokeinten~y#|
          c. |
smokeinten~y |  -.0009907    .000938    -1.06   0.291    -.0028306    .0008493
             |
         sex |  -1.430272   .4689576    -3.05   0.002    -2.350132   -.5104111
        race |   .5601096   .5818888     0.96   0.336    -.5812656    1.701485
         age |   .3596353   .1633188     2.20   0.028     .0392854    .6799851
             |
 c.age#c.age |   -.006101   .0017261    -3.53   0.000    -.0094868   -.0027151
             |
   education |
          1  |    .194977   .7413692     0.26   0.793    -1.259219    1.649173
          2  |   .9854211   .7012116     1.41   0.160     -.390006    2.360848
          3  |   .7512894   .6339153     1.19   0.236    -.4921358    1.994715
          4  |   1.686547   .8716593     1.93   0.053    -.0232138    3.396307
             |
    smokeyrs |   .1343686   .0917122     1.47   0.143     -.045525    .3142621
             |
  c.smokeyrs#|
  c.smokeyrs |  -.0018664   .0015437    -1.21   0.227    -.0048944    .0011616
             |
    exercise |
          0  |  -.3539128   .5588587    -0.63   0.527    -1.450114    .7422889
          1  |  -.0579374   .4316468    -0.13   0.893     -.904613    .7887381
             |
      active |
          0  |   .2613779   .6845577     0.38   0.703    -1.081382    1.604138
          1  |  -.6861916   .6739131    -1.02   0.309    -2.008073    .6356894
             |
        wt71 |   .0455018   .0833709     0.55   0.585    -.1180303    .2090339
             |
      c.wt71#|
      c.wt71 |  -.0009653   .0005247    -1.84   0.066    -.0019945    .0000639
             |
       _cons |  -1.690608   4.388883    -0.39   0.700     -10.2994    6.918188
------------------------------------------------------------------------------


 ( 1)  qsmk + 5*qsmkintensity = 0

------------------------------------------------------------------------------
     wt82_71 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   2.792908   .6682596     4.18   0.000     1.482117      4.1037
------------------------------------------------------------------------------


 ( 1)  qsmk + 40*qsmkintensity = 0

------------------------------------------------------------------------------
     wt82_71 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   4.426108   .8477818     5.22   0.000     2.763183    6.089032
------------------------------------------------------------------------------

      Source |       SS           df       MS      Number of obs   =     1,566
-------------+----------------------------------   F(19, 1546)     =     14.06
       Model |  14318.1239        19   753.58547   Prob &gt; F        =    0.0000
    Residual |  82857.4627     1,546  53.5947365   R-squared       =    0.1473
-------------+----------------------------------   Adj R-squared   =    0.1369
       Total |  97175.5866     1,565  62.0930266   Root MSE        =    7.3208

------------------------------------------------------------------------------
     wt82_71 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        qsmk |   3.462622   .4384543     7.90   0.000     2.602594     4.32265
smokeinten~y |   .0651533   .0503115     1.29   0.196    -.0335327    .1638392
             |
          c. |
smokeinten~y#|
          c. |
smokeinten~y |  -.0010468   .0009373    -1.12   0.264    -.0028853    .0007918
             |
         sex |   -1.46505    .468341    -3.13   0.002      -2.3837   -.5463989
        race |   .5864117   .5816949     1.01   0.314    -.5545827    1.727406
         age |   .3626624   .1633431     2.22   0.027     .0422649    .6830599
             |
 c.age#c.age |  -.0061377   .0017263    -3.56   0.000    -.0095239   -.0027515
             |
   education |
          1  |   .1708264   .7413289     0.23   0.818     -1.28329    1.624943
          2  |   .9893527   .7013784     1.41   0.159    -.3864007    2.365106
          3  |   .7423268   .6340357     1.17   0.242     -.501334    1.985988
          4  |   1.679344   .8718575     1.93   0.054    -.0308044    3.389492
             |
    smokeyrs |   .1333931   .0917319     1.45   0.146    -.0465389    .3133252
             |
  c.smokeyrs#|
  c.smokeyrs |   -.001827   .0015438    -1.18   0.237    -.0048552    .0012012
             |
    exercise |
          0  |  -.3628786   .5589557    -0.65   0.516     -1.45927    .7335129
          1  |  -.0421962   .4315904    -0.10   0.922    -.8887606    .8043683
             |
      active |
          0  |   .2580374   .6847219     0.38   0.706    -1.085044    1.601119
          1  |    -.68492   .6740787    -1.02   0.310    -2.007125    .6372851
             |
        wt71 |   .0373642   .0831658     0.45   0.653    -.1257655     .200494
             |
      c.wt71#|
      c.wt71 |  -.0009158   .0005235    -1.75   0.080    -.0019427    .0001111
             |
       _cons |  -1.724603   4.389891    -0.39   0.694    -10.33537    6.886166
------------------------------------------------------------------------------</code></pre>
</div>
<div id="prorgam-15.2" class="section level2">
<h2>Prorgam 15.2</h2>
<ul>
<li>Estimating and plotting the propensity score</li>
<li>Data from NHEFS</li>
<li>Section 15.2</li>
</ul>
<div class="sourceCode" id="cb389"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb389-1"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">clear</span></span>
<span id="cb389-2"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-2"></a></span>
<span id="cb389-3"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-3"></a><span class="co">/*Fit a model for the exposure, quitting smoking*/</span></span>
<span id="cb389-4"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-4"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education <span class="co">///</span></span>
<span id="cb389-5"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-5"></a>  c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb389-6"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-6"></a>  c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active <span class="co">///</span></span>
<span id="cb389-7"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-7"></a>  c.wt71##c.wt71 </span>
<span id="cb389-8"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-8"></a></span>
<span id="cb389-9"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-9"></a><span class="co">/*Estimate the propensity score, P(Qsmk|Covariates)*/</span></span>
<span id="cb389-10"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-10"></a><span class="kw">predict</span> ps, pr</span>
<span id="cb389-11"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-11"></a></span>
<span id="cb389-12"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-12"></a><span class="co">/*Check the distribution of the propensity score*/</span></span>
<span id="cb389-13"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-13"></a><span class="kw">bys</span> qsmk: <span class="kw">summarize</span> ps </span>
<span id="cb389-14"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-14"></a></span>
<span id="cb389-15"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-15"></a><span class="co">/*Return extreme values of propensity score:</span></span>
<span id="cb389-16"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-16"></a><span class="co">  note, for Stata versions 15 and above, start by installing extremes*/</span></span>
<span id="cb389-17"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-17"></a>* <span class="kw">ssc</span> install extremes</span>
<span id="cb389-18"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-18"></a>extremes ps seqn</span>
<span id="cb389-19"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-19"></a><span class="kw">bys</span> qsmk: extremes ps seqn</span>
<span id="cb389-20"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-20"></a></span>
<span id="cb389-21"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-21"></a><span class="kw">save</span> ./<span class="kw">data</span>/nhefs-ps, <span class="kw">replace</span></span>
<span id="cb389-22"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-22"></a></span>
<span id="cb389-23"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-23"></a><span class="co">/*Plotting the estimated propensity score*/</span></span>
<span id="cb389-24"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-24"></a><span class="kw">histogram</span> ps, <span class="kw">width</span>(0.05) <span class="bn">start</span>(0.025) <span class="co">///</span></span>
<span id="cb389-25"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-25"></a>  <span class="kw">frequency</span> fcolor(<span class="kw">none</span>) lcolor(<span class="bn">black</span>) <span class="co">///</span></span>
<span id="cb389-26"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-26"></a>  lpattern(solid) addlabel <span class="co">///</span></span>
<span id="cb389-27"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-27"></a>  <span class="bn">addlabopts</span>(<span class="bn">mlabcolor</span>(<span class="bn">black</span>) <span class="bn">mlabposition</span>(12) <span class="co">///</span></span>
<span id="cb389-28"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-28"></a>  <span class="bn">mlabangle</span>(<span class="bn">zero</span>)) <span class="co">///</span></span>
<span id="cb389-29"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-29"></a>  <span class="bn">ytitle</span>(No. Subjects) <span class="kw">ylabel</span>(#4) <span class="co">///</span></span>
<span id="cb389-30"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-30"></a>  <span class="bn">xtitle</span>(Estimated Propensity Score) <span class="kw">xlabel</span>(#15) <span class="co">///</span></span>
<span id="cb389-31"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-31"></a>  <span class="kw">by</span>(, <span class="bn">title</span>(Estimated Propensity Score Distribution) <span class="co">///</span></span>
<span id="cb389-32"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-32"></a>  <span class="bn">subtitle</span>(By Quit Smoking Status)) <span class="co">///</span></span>
<span id="cb389-33"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-33"></a>  <span class="kw">by</span>(, <span class="bn">legend</span>(<span class="kw">off</span>)) <span class="co">///</span></span>
<span id="cb389-34"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-34"></a>  <span class="kw">by</span>(qsmk, style(compact) colfirst) <span class="co">///</span></span>
<span id="cb389-35"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-35"></a>  <span class="bn">subtitle</span>(, <span class="kw">size</span>(small) box bexpand)</span>
<span id="cb389-36"><a href="outcome-regression-and-propensity-scores-stata.html#cb389-36"></a><span class="kw">qui</span> <span class="kw">gr</span> <span class="kw">export</span> ./figs/stata-fig-15-2.png, <span class="kw">replace</span></span></code></pre></div>
<pre><code>Iteration 0:   log likelihood = -893.02712  
Iteration 1:   log likelihood = -839.70016  
Iteration 2:   log likelihood = -838.45045  
Iteration 3:   log likelihood = -838.44842  
Iteration 4:   log likelihood = -838.44842  

Logistic regression                             Number of obs     =      1,566
                                                LR chi2(18)       =     109.16
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -838.44842                     Pseudo R2         =     0.0611

------------------------------------------------------------------------------
        qsmk |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         sex |  -.5274782   .1540497    -3.42   0.001      -.82941   -.2255463
        race |  -.8392636   .2100668    -4.00   0.000    -1.250987   -.4275404
         age |   .1212052   .0512663     2.36   0.018     .0207251    .2216853
             |
 c.age#c.age |  -.0008246   .0005361    -1.54   0.124    -.0018753    .0002262
             |
   education |
          1  |  -.4759606   .2262238    -2.10   0.035    -.9193511   -.0325701
          2  |  -.5047361    .217597    -2.32   0.020    -.9312184   -.0782538
          3  |  -.3895288   .1914353    -2.03   0.042    -.7647351   -.0143226
          4  |  -.4123596   .2772868    -1.49   0.137    -.9558318    .1311126
             |
smokeinten~y |  -.0772704   .0152499    -5.07   0.000    -.1071596   -.0473812
             |
          c. |
smokeinten~y#|
          c. |
smokeinten~y |   .0010451   .0002866     3.65   0.000     .0004835    .0016068
             |
    smokeyrs |  -.0735966   .0277775    -2.65   0.008    -.1280395   -.0191538
             |
  c.smokeyrs#|
  c.smokeyrs |   .0008441   .0004632     1.82   0.068    -.0000637    .0017519
             |
    exercise |
          0  |   -.395704   .1872401    -2.11   0.035    -.7626878   -.0287201
          1  |  -.0408635   .1382674    -0.30   0.768    -.3118627    .2301357
             |
      active |
          0  |   -.176784   .2149721    -0.82   0.411    -.5981215    .2445535
          1  |  -.1448395   .2111472    -0.69   0.493    -.5586806    .2690015
             |
        wt71 |  -.0152357   .0263161    -0.58   0.563    -.0668144     .036343
             |
      c.wt71#|
      c.wt71 |   .0001352   .0001632     0.83   0.407    -.0001846     .000455
             |
       _cons |   -1.19407   1.398493    -0.85   0.393    -3.935066    1.546925
------------------------------------------------------------------------------



-------------------------------------------------------------------------------
-&gt; qsmk = No smoking cessation

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |      1,163    .2392928    .1056545   .0510008   .6814955

-------------------------------------------------------------------------------
-&gt; qsmk = Smoking cessation

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        403    .3094353    .1290642   .0598799   .7768887



  +--------------------------+
  |  obs:         ps    seqn |
  |--------------------------|
  |   65.   .0510008   22941 |
  |  364.   .0527126    1769 |
  |  427.   .0558418   21140 |
  |  578.   .0558752    2522 |
  | 1139.   .0567372   12639 |
  +--------------------------+

  +--------------------------+
  | 1365.   .6659576   22272 |
  |   13.   .6814955   22773 |
  | 1346.   .7166381   14983 |
  | 1289.   .7200644   24817 |
  | 1495.   .7768887   24949 |
  +--------------------------+


-------------------------------------------------------------------------------
-&gt; qsmk = No smoking cessation

  +--------------------------+
  |  obs:         ps    seqn |
  |--------------------------|
  |   65.   .0510008   22941 |
  |  364.   .0527126    1769 |
  |  427.   .0558418   21140 |
  |  578.   .0558752    2522 |
  | 1139.   .0567372   12639 |
  +--------------------------+

  +--------------------------+
  | 1161.   .6337243   17096 |
  |  220.   .6345721   17768 |
  | 1084.   .6440308   19147 |
  |  267.   .6566707   21983 |
  |   13.   .6814955   22773 |
  +--------------------------+

-------------------------------------------------------------------------------
-&gt; qsmk = Smoking cessation

  +--------------------------+
  |  obs:         ps    seqn |
  |--------------------------|
  | 1390.   .0598799    4289 |
  | 1545.   .0600822   23550 |
  | 1367.   .0806089   24306 |
  | 1263.   .0821677   22904 |
  | 1511.   .1021875   24584 |
  +--------------------------+

  +--------------------------+
  | 1215.    .635695   17738 |
  | 1365.   .6659576   22272 |
  | 1346.   .7166381   14983 |
  | 1289.   .7200644   24817 |
  | 1495.   .7768887   24949 |
  +--------------------------+

file ./data/nhefs-ps.dta saved
</code></pre>
<p><img src="figs/stata-fig-15-2.png" width="85%" style="display: block; margin: auto;" /></p>
</div>
<div id="program-15.3-1" class="section level2">
<h2>Program 15.3</h2>
<ul>
<li>Stratification and outcome regression using deciles of the propensity score</li>
<li>Data from NHEFS</li>
<li>Section 15.3</li>
<li>Note: Stata decides borderline cutpoints differently from SAS, so, despite identically distributed propensity scores, the results of regression using deciles are not an exact match with the book.</li>
</ul>
<div class="sourceCode" id="cb391"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb391-1"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-ps, <span class="kw">clear</span></span>
<span id="cb391-2"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-2"></a></span>
<span id="cb391-3"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-3"></a><span class="co">/*Calculation of deciles of ps*/</span></span>
<span id="cb391-4"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-4"></a><span class="kw">xtile</span> ps_dec = ps, nq(10)</span>
<span id="cb391-5"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-5"></a><span class="kw">by</span> ps_dec, <span class="kw">sort</span>: <span class="kw">summarize</span> ps</span>
<span id="cb391-6"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-6"></a></span>
<span id="cb391-7"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-7"></a><span class="co">/*Stratification on PS deciles, allowing for effect modification*/</span></span>
<span id="cb391-8"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-8"></a><span class="co">/*Note: stata compares qsmk 0 vs qsmk 1, so the coefficients are reversed relative to the book*/</span></span>
<span id="cb391-9"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-9"></a><span class="kw">by</span> ps_dec: <span class="kw">ttest</span> wt82_71, <span class="kw">by</span>(qsmk)</span>
<span id="cb391-10"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-10"></a></span>
<span id="cb391-11"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-11"></a><span class="co">/*Regression on PS deciles, with no product terms*/</span></span>
<span id="cb391-12"><a href="outcome-regression-and-propensity-scores-stata.html#cb391-12"></a><span class="kw">regress</span> wt82_71 qsmk ib(<span class="fu">last</span>).ps_dec</span></code></pre></div>
<pre><code>-&gt; ps_dec = 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        157    .0976251    .0185215   .0510008   .1240482

-------------------------------------------------------------------------------
-&gt; ps_dec = 2

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        157    .1430792    .0107751   .1241923   .1603558

-------------------------------------------------------------------------------
-&gt; ps_dec = 3

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        156    .1750423     .008773   .1606041   .1893271

-------------------------------------------------------------------------------
-&gt; ps_dec = 4

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        157    .2014066    .0062403    .189365   .2121815

-------------------------------------------------------------------------------
-&gt; ps_dec = 5

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        156    .2245376    .0073655   .2123068    .237184

-------------------------------------------------------------------------------
-&gt; ps_dec = 6

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        157    .2515298    .0078777   .2377578   .2655718

-------------------------------------------------------------------------------
-&gt; ps_dec = 7

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        157    .2827476    .0099986   .2655724   .2994968

-------------------------------------------------------------------------------
-&gt; ps_dec = 8

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        156    .3204104    .0125102   .2997581   .3438773

-------------------------------------------------------------------------------
-&gt; ps_dec = 9

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        157     .375637    .0221347   .3439862   .4174631

-------------------------------------------------------------------------------
-&gt; ps_dec = 10

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |        156    .5026508    .0733494   .4176717   .7768887



-------------------------------------------------------------------------------
-&gt; ps_dec = 1

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     146     3.74236    .6531341    7.891849    2.451467    5.033253
 Smoking |      11    3.949703    2.332995    7.737668   -1.248533     9.14794
---------+--------------------------------------------------------------------
combined |     157    3.756887    .6270464    7.856869     2.51829    4.995484
---------+--------------------------------------------------------------------
    diff |           -.2073431    2.464411               -5.075509    4.660822
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -0.0841
Ho: diff = 0                                     degrees of freedom =      155

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.4665         Pr(|T| &gt; |t|) = 0.9331          Pr(T &gt; t) = 0.5335

-------------------------------------------------------------------------------
-&gt; ps_dec = 2

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     134    2.813019     .589056    6.818816    1.647889    3.978149
 Smoking |      23    7.726944    1.260784    6.046508    5.112237    10.34165
---------+--------------------------------------------------------------------
combined |     157    3.532893    .5519826    6.916322    2.442569    4.623217
---------+--------------------------------------------------------------------
    diff |           -4.913925    1.515494               -7.907613   -1.920237
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -3.2425
Ho: diff = 0                                     degrees of freedom =      155

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0007         Pr(|T| &gt; |t|) = 0.0015          Pr(T &gt; t) = 0.9993

-------------------------------------------------------------------------------
-&gt; ps_dec = 3

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     128     3.25684    .5334655    6.035473    2.201209    4.312472
 Smoking |      28    7.954974    1.418184    7.504324    5.045101    10.86485
---------+--------------------------------------------------------------------
combined |     156    4.100095    .5245749    6.551938    3.063857    5.136334
---------+--------------------------------------------------------------------
    diff |           -4.698134    1.318074               -7.301973   -2.094294
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -3.5644
Ho: diff = 0                                     degrees of freedom =      154

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0002         Pr(|T| &gt; |t|) = 0.0005          Pr(T &gt; t) = 0.9998

-------------------------------------------------------------------------------
-&gt; ps_dec = 4

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     121    3.393929    .5267602    5.794362    2.350981    4.436877
 Smoking |      36    5.676072    1.543143    9.258861    2.543324    8.808819
---------+--------------------------------------------------------------------
combined |     157    3.917223    .5412091     6.78133    2.848179    4.986266
---------+--------------------------------------------------------------------
    diff |           -2.282143    1.278494               -4.807663    .2433778
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -1.7850
Ho: diff = 0                                     degrees of freedom =      155

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0381         Pr(|T| &gt; |t|) = 0.0762          Pr(T &gt; t) = 0.9619

-------------------------------------------------------------------------------
-&gt; ps_dec = 5

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     119    1.368438    .8042619    8.773461   -.2242199    2.961095
 Smoking |      37    5.195421    1.388723     8.44727    2.378961    8.011881
---------+--------------------------------------------------------------------
combined |     156     2.27612    .7063778    8.822656    .8807499    3.671489
---------+--------------------------------------------------------------------
    diff |           -3.826983    1.637279               -7.061407    -.592559
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -2.3374
Ho: diff = 0                                     degrees of freedom =      154

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0104         Pr(|T| &gt; |t|) = 0.0207          Pr(T &gt; t) = 0.9896

-------------------------------------------------------------------------------
-&gt; ps_dec = 6

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     112     2.25564    .6850004    7.249362    .8982664    3.613014
 Smoking |      45    7.199088    1.724899    11.57097    3.722782    10.67539
---------+--------------------------------------------------------------------
combined |     157    3.672552    .7146582    8.954642    2.260897    5.084207
---------+--------------------------------------------------------------------
    diff |           -4.943447    1.535024               -7.975714   -1.911181
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -3.2204
Ho: diff = 0                                     degrees of freedom =      155

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0008         Pr(|T| &gt; |t|) = 0.0016          Pr(T &gt; t) = 0.9992

-------------------------------------------------------------------------------
-&gt; ps_dec = 7

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     116    .7948483    .7916172    8.525978    -.773193     2.36289
 Smoking |      41    6.646091     1.00182    6.414778    4.621337    8.670844
---------+--------------------------------------------------------------------
combined |     157     2.32288    .6714693    8.413486    .9965349    3.649225
---------+--------------------------------------------------------------------
    diff |           -5.851242     1.45977               -8.734853   -2.967632
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -4.0083
Ho: diff = 0                                     degrees of freedom =      155

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0000         Pr(|T| &gt; |t|) = 0.0001          Pr(T &gt; t) = 1.0000

-------------------------------------------------------------------------------
-&gt; ps_dec = 8

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     107    1.063848    .5840159    6.041107   -.0940204    2.221716
 Smoking |      49    3.116263    1.113479    7.794356    .8774626    5.355063
---------+--------------------------------------------------------------------
combined |     156    1.708517    .5352016    6.684666    .6512864    2.765747
---------+--------------------------------------------------------------------
    diff |           -2.052415    1.144914                -4.31418    .2093492
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -1.7926
Ho: diff = 0                                     degrees of freedom =      154

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0375         Pr(|T| &gt; |t|) = 0.0750          Pr(T &gt; t) = 0.9625

-------------------------------------------------------------------------------
-&gt; ps_dec = 9

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |     100   -.0292906    .7637396    7.637396   -1.544716    1.486134
 Smoking |      57    .9112647    .9969309    7.526663   -1.085828    2.908357
---------+--------------------------------------------------------------------
combined |     157    .3121849    .6054898    7.586766   -.8838316    1.508201
---------+--------------------------------------------------------------------
    diff |           -.9405554     1.26092                -3.43136    1.550249
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -0.7459
Ho: diff = 0                                     degrees of freedom =      155

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.2284         Pr(|T| &gt; |t|) = 0.4568          Pr(T &gt; t) = 0.7716

-------------------------------------------------------------------------------
-&gt; ps_dec = 10

Two-sample t test with equal variances
------------------------------------------------------------------------------
   Group |     Obs        Mean    Std. Err.   Std. Dev.   [95% Conf. Interval]
---------+--------------------------------------------------------------------
No smoki |      80    -.768504    .9224756    8.250872   -2.604646    1.067638
 Smoking |      76     2.39532    1.053132    9.180992    .2973737    4.493267
---------+--------------------------------------------------------------------
combined |     156    .7728463    .7071067    8.831759   -.6239631    2.169656
---------+--------------------------------------------------------------------
    diff |           -3.163824    1.396178               -5.921957    -.405692
------------------------------------------------------------------------------
    diff = mean(No smoki) - mean(Smoking)                         t =  -2.2661
Ho: diff = 0                                     degrees of freedom =      154

    Ha: diff &lt; 0                 Ha: diff != 0                 Ha: diff &gt; 0
 Pr(T &lt; t) = 0.0124         Pr(|T| &gt; |t|) = 0.0248          Pr(T &gt; t) = 0.9876

      Source |       SS           df       MS      Number of obs   =     1,566
-------------+----------------------------------   F(10, 1555)     =      9.87
       Model |   5799.7817        10   579.97817   Prob &gt; F        =    0.0000
    Residual |  91375.8049     1,555  58.7625755   R-squared       =    0.0597
-------------+----------------------------------   Adj R-squared   =    0.0536
       Total |  97175.5866     1,565  62.0930266   Root MSE        =    7.6657

------------------------------------------------------------------------------
     wt82_71 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        qsmk |   3.356927   .4580399     7.33   0.000     2.458486    4.255368
             |
      ps_dec |
          1  |   4.384269   .8873947     4.94   0.000     2.643652    6.124885
          2  |   3.903694   .8805212     4.43   0.000      2.17656    5.630828
          3  |    4.36015   .8793345     4.96   0.000     2.635343    6.084956
          4  |   4.010061   .8745966     4.59   0.000     2.294548    5.725575
          5  |   2.342505   .8754878     2.68   0.008     .6252438    4.059766
          6  |   3.572955   .8714389     4.10   0.000     1.863636    5.282275
          7  |    2.30881   .8727462     2.65   0.008     .5969261    4.020693
          8  |   1.516677   .8715796     1.74   0.082    -.1929182    3.226273
          9  |  -.0439923   .8684465    -0.05   0.960    -1.747442    1.659457
             |
       _cons |  -.8625798   .6530529    -1.32   0.187    -2.143537    .4183773
------------------------------------------------------------------------------</code></pre>
</div>
<div id="program-15.4-1" class="section level2">
<h2>Program 15.4</h2>
<ul>
<li>Standardization and outcome regression using the propensity score</li>
<li>Data from NHEFS</li>
<li>Section 15.3</li>
</ul>
<div class="sourceCode" id="cb393"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb393-1"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-1"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs-formatted, <span class="kw">clear</span></span>
<span id="cb393-2"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-2"></a></span>
<span id="cb393-3"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-3"></a><span class="co">/*Estimate the propensity score*/</span></span>
<span id="cb393-4"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-4"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education <span class="co">///</span></span>
<span id="cb393-5"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-5"></a>  c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb393-6"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-6"></a>  c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise <span class="co">///</span></span>
<span id="cb393-7"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-7"></a>  ib(<span class="fu">last</span>).active c.wt71##c.wt71 </span>
<span id="cb393-8"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-8"></a><span class="kw">predict</span> ps, pr</span>
<span id="cb393-9"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-9"></a></span>
<span id="cb393-10"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-10"></a><span class="co">/*Expand the dataset for standardization*/</span></span>
<span id="cb393-11"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-11"></a>expand 2, <span class="kw">generate</span>(interv)</span>
<span id="cb393-12"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-12"></a>expand 2 <span class="kw">if</span> interv == 0, <span class="kw">generate</span>(interv2)</span>
<span id="cb393-13"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-13"></a><span class="kw">replace</span> interv = -1 <span class="kw">if</span> interv2 ==1</span>
<span id="cb393-14"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-14"></a><span class="kw">drop</span> interv2 </span>
<span id="cb393-15"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-15"></a><span class="kw">tab</span> interv</span>
<span id="cb393-16"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-16"></a><span class="kw">replace</span> wt82_71 = . <span class="kw">if</span> interv != -1</span>
<span id="cb393-17"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-17"></a><span class="kw">replace</span> qsmk = 0 <span class="kw">if</span> interv == 0</span>
<span id="cb393-18"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-18"></a><span class="kw">replace</span> qsmk = 1 <span class="kw">if</span> interv == 1</span>
<span id="cb393-19"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-19"></a><span class="kw">by</span> interv, <span class="kw">sort</span>: <span class="kw">summarize</span> qsmk</span>
<span id="cb393-20"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-20"></a></span>
<span id="cb393-21"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-21"></a><span class="co">/*Regression on the propensity score, allowing for effect modification*/</span></span>
<span id="cb393-22"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-22"></a><span class="kw">regress</span> wt82_71 qsmk##c.ps</span>
<span id="cb393-23"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-23"></a><span class="kw">predict</span> predY, <span class="kw">xb</span></span>
<span id="cb393-24"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-24"></a><span class="kw">by</span> interv, <span class="kw">sort</span>: <span class="kw">summarize</span> predY</span>
<span id="cb393-25"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-25"></a></span>
<span id="cb393-26"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-26"></a><span class="kw">quietly</span> <span class="kw">summarize</span> predY <span class="kw">if</span>(interv == -1)</span>
<span id="cb393-27"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-27"></a><span class="fu">matrix</span> input observe = (-1,<span class="ot">`r(mean)&#39;</span>)</span>
<span id="cb393-28"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-28"></a><span class="kw">quietly</span> <span class="kw">summarize</span> predY <span class="kw">if</span>(interv == 0)</span>
<span id="cb393-29"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-29"></a><span class="fu">matrix</span> observe = (observe \0,<span class="ot">`r(mean)&#39;</span>)</span>
<span id="cb393-30"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-30"></a><span class="kw">quietly</span> <span class="kw">summarize</span> predY <span class="kw">if</span>(interv == 1)</span>
<span id="cb393-31"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-31"></a><span class="fu">matrix</span> observe = (observe \1,<span class="ot">`r(mean)&#39;</span>)</span>
<span id="cb393-32"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-32"></a><span class="fu">matrix</span> observe = (observe \., observe[3,2]-observe[2,2]) </span>
<span id="cb393-33"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-33"></a><span class="fu">matrix</span> <span class="ot">rownames</span> observe = observed E(Y(a=0)) E(Y(a=1)) difference</span>
<span id="cb393-34"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-34"></a><span class="fu">matrix</span> <span class="ot">colnames</span> observe = interv <span class="ot">value</span></span>
<span id="cb393-35"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-35"></a><span class="fu">matrix</span> <span class="ot">list</span> observe </span>
<span id="cb393-36"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-36"></a></span>
<span id="cb393-37"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-37"></a><span class="co">/*bootstrap program*/</span></span>
<span id="cb393-38"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-38"></a><span class="kw">drop</span> <span class="kw">if</span> interv != -1</span>
<span id="cb393-39"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-39"></a><span class="kw">gen</span> meanY_b =.</span>
<span id="cb393-40"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-40"></a><span class="kw">qui</span> <span class="kw">save</span> ./<span class="kw">data</span>/nhefs_std, <span class="kw">replace</span></span>
<span id="cb393-41"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-41"></a></span>
<span id="cb393-42"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-42"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> bootstdz</span>
<span id="cb393-43"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-43"></a></span>
<span id="cb393-44"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-44"></a><span class="kw">program</span> <span class="kw">define</span> bootstdz, rclass</span>
<span id="cb393-45"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-45"></a><span class="kw">use</span> ./<span class="kw">data</span>/nhefs_std, <span class="kw">clear</span></span>
<span id="cb393-46"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-46"></a><span class="kw">preserve</span></span>
<span id="cb393-47"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-47"></a><span class="kw">bsample</span> </span>
<span id="cb393-48"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-48"></a><span class="co">/*Create 2 new copies of the data. </span></span>
<span id="cb393-49"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-49"></a><span class="co">Set the outcome AND the exposure to missing in the copies*/</span></span>
<span id="cb393-50"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-50"></a>expand 2, <span class="kw">generate</span>(interv_b)</span>
<span id="cb393-51"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-51"></a>expand 2 <span class="kw">if</span> interv_b == 0, <span class="kw">generate</span>(interv2_b)</span>
<span id="cb393-52"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-52"></a><span class="kw">qui</span> <span class="kw">replace</span> interv_b = -1 <span class="kw">if</span> interv2_b ==1</span>
<span id="cb393-53"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-53"></a><span class="kw">qui</span> <span class="kw">drop</span> interv2_b</span>
<span id="cb393-54"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-54"></a><span class="kw">qui</span> <span class="kw">replace</span> wt82_71 = . <span class="kw">if</span> interv_b != -1</span>
<span id="cb393-55"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-55"></a><span class="kw">qui</span> <span class="kw">replace</span> qsmk = . <span class="kw">if</span> interv_b != -1</span>
<span id="cb393-56"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-56"></a></span>
<span id="cb393-57"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-57"></a><span class="co">/*Fit the propensity score in the original data </span></span>
<span id="cb393-58"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-58"></a><span class="co">(where qsmk is not missing) and generate predictions for everyone*/</span></span>
<span id="cb393-59"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-59"></a><span class="kw">logit</span> qsmk sex race c.age##c.age ib(<span class="fu">last</span>).education <span class="co">///</span></span>
<span id="cb393-60"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-60"></a>  c.smokeintensity##c.smokeintensity <span class="co">///</span></span>
<span id="cb393-61"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-61"></a>    c.smokeyrs##c.smokeyrs ib(<span class="fu">last</span>).exercise ib(<span class="fu">last</span>).active <span class="co">///</span></span>
<span id="cb393-62"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-62"></a>    c.wt71##c.wt71 </span>
<span id="cb393-63"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-63"></a><span class="kw">predict</span> ps_b, pr</span>
<span id="cb393-64"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-64"></a></span>
<span id="cb393-65"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-65"></a><span class="co">/*Set the exposure to 0 for everyone in copy 0, </span></span>
<span id="cb393-66"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-66"></a><span class="co">and 1 to everyone for copy 1*/</span></span>
<span id="cb393-67"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-67"></a><span class="kw">qui</span> <span class="kw">replace</span> qsmk = 0 <span class="kw">if</span> interv_b == 0</span>
<span id="cb393-68"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-68"></a><span class="kw">qui</span> <span class="kw">replace</span> qsmk = 1 <span class="kw">if</span> interv_b == 1</span>
<span id="cb393-69"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-69"></a></span>
<span id="cb393-70"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-70"></a><span class="co">/*Fit the outcome regression in the original data </span></span>
<span id="cb393-71"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-71"></a><span class="co">(where wt82_71 is not missing) and </span></span>
<span id="cb393-72"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-72"></a><span class="co">generate predictions for everyone*/</span></span>
<span id="cb393-73"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-73"></a><span class="kw">regress</span> wt82_71 qsmk##c.ps</span>
<span id="cb393-74"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-74"></a><span class="kw">predict</span> predY_b, <span class="kw">xb</span></span>
<span id="cb393-75"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-75"></a></span>
<span id="cb393-76"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-76"></a><span class="co">/*Summarize the predictions in each set of copies*/</span></span>
<span id="cb393-77"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-77"></a><span class="kw">summarize</span> predY_b <span class="kw">if</span> interv_b == 0</span>
<span id="cb393-78"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-78"></a><span class="fu">return</span> <span class="fu">scalar</span> boot_0 = <span class="fu">r</span>(<span class="kw">mean</span>)</span>
<span id="cb393-79"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-79"></a><span class="kw">summarize</span> predY_b <span class="kw">if</span> interv_b == 1</span>
<span id="cb393-80"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-80"></a><span class="fu">return</span> <span class="fu">scalar</span> boot_1 = <span class="fu">r</span>(<span class="kw">mean</span>)</span>
<span id="cb393-81"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-81"></a><span class="fu">return</span> <span class="fu">scalar</span> boot_diff = <span class="fu">return</span>(boot_1) - <span class="fu">return</span>(boot_0)</span>
<span id="cb393-82"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-82"></a><span class="kw">qui</span> <span class="kw">drop</span> meanY_b</span>
<span id="cb393-83"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-83"></a><span class="kw">restore</span></span>
<span id="cb393-84"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-84"></a><span class="kw">end</span></span>
<span id="cb393-85"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-85"></a></span>
<span id="cb393-86"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-86"></a><span class="co">/*Then we use the `simulate` command to run the bootstraps </span></span>
<span id="cb393-87"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-87"></a><span class="co">as many times as we want.</span></span>
<span id="cb393-88"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-88"></a><span class="co">Start with reps(10) to make sure your code runs, </span></span>
<span id="cb393-89"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-89"></a><span class="co">and then change to reps(1000) to generate your final CIs*/</span></span>
<span id="cb393-90"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-90"></a><span class="kw">simulate</span> EY_a0=<span class="fu">r</span>(boot_0) EY_a1 = <span class="fu">r</span>(boot_1) <span class="co">///</span></span>
<span id="cb393-91"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-91"></a>  difference = <span class="fu">r</span>(boot_diff), reps(500) <span class="dv">seed</span>(1): bootstdz /</span>
<span id="cb393-92"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-92"></a></span>
<span id="cb393-93"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-93"></a><span class="fu">matrix</span> pe = observe[2..4, 2]&#39;</span>
<span id="cb393-94"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-94"></a><span class="fu">matrix</span> <span class="ot">list</span> pe</span>
<span id="cb393-95"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-95"></a><span class="kw">bstat</span>, stat(pe) n(1629) </span>
<span id="cb393-96"><a href="outcome-regression-and-propensity-scores-stata.html#cb393-96"></a><span class="kw">estat</span> <span class="kw">bootstrap</span>, <span class="kw">p</span></span></code></pre></div>
<pre><code>Iteration 0:   log likelihood = -893.02712  
Iteration 1:   log likelihood = -839.70016  
Iteration 2:   log likelihood = -838.45045  
Iteration 3:   log likelihood = -838.44842  
Iteration 4:   log likelihood = -838.44842  

Logistic regression                             Number of obs     =      1,566
                                                LR chi2(18)       =     109.16
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -838.44842                     Pseudo R2         =     0.0611

------------------------------------------------------------------------------
        qsmk |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         sex |  -.5274782   .1540497    -3.42   0.001      -.82941   -.2255463
        race |  -.8392636   .2100668    -4.00   0.000    -1.250987   -.4275404
         age |   .1212052   .0512663     2.36   0.018     .0207251    .2216853
             |
 c.age#c.age |  -.0008246   .0005361    -1.54   0.124    -.0018753    .0002262
             |
   education |
          1  |  -.4759606   .2262238    -2.10   0.035    -.9193511   -.0325701
          2  |  -.5047361    .217597    -2.32   0.020    -.9312184   -.0782538
          3  |  -.3895288   .1914353    -2.03   0.042    -.7647351   -.0143226
          4  |  -.4123596   .2772868    -1.49   0.137    -.9558318    .1311126
             |
smokeinten~y |  -.0772704   .0152499    -5.07   0.000    -.1071596   -.0473812
             |
          c. |
smokeinten~y#|
          c. |
smokeinten~y |   .0010451   .0002866     3.65   0.000     .0004835    .0016068
             |
    smokeyrs |  -.0735966   .0277775    -2.65   0.008    -.1280395   -.0191538
             |
  c.smokeyrs#|
  c.smokeyrs |   .0008441   .0004632     1.82   0.068    -.0000637    .0017519
             |
    exercise |
          0  |   -.395704   .1872401    -2.11   0.035    -.7626878   -.0287201
          1  |  -.0408635   .1382674    -0.30   0.768    -.3118627    .2301357
             |
      active |
          0  |   -.176784   .2149721    -0.82   0.411    -.5981215    .2445535
          1  |  -.1448395   .2111472    -0.69   0.493    -.5586806    .2690015
             |
        wt71 |  -.0152357   .0263161    -0.58   0.563    -.0668144     .036343
             |
      c.wt71#|
      c.wt71 |   .0001352   .0001632     0.83   0.407    -.0001846     .000455
             |
       _cons |   -1.19407   1.398493    -0.85   0.393    -3.935066    1.546925
------------------------------------------------------------------------------


(1,566 observations created)

(1,566 observations created)

(1,566 real changes made)

     interv |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |      1,566       33.33       33.33
          0 |      1,566       33.33       66.67
          1 |      1,566       33.33      100.00
------------+-----------------------------------
      Total |      4,698      100.00

(3,132 real changes made, 3,132 to missing)

(403 real changes made)

(1,163 real changes made)


-------------------------------------------------------------------------------
-&gt; interv = -1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        qsmk |      1,566    .2573436    .4373099          0          1

-------------------------------------------------------------------------------
-&gt; interv = 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        qsmk |      1,566           0           0          0          0

-------------------------------------------------------------------------------
-&gt; interv = 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        qsmk |      1,566           1           0          1          1

      Source |       SS           df       MS      Number of obs   =     1,566
-------------+----------------------------------   F(3, 1562)      =     29.96
       Model |  5287.31428         3  1762.43809   Prob &gt; F        =    0.0000
    Residual |  91888.2723     1,562   58.827319   R-squared       =    0.0544
-------------+----------------------------------   Adj R-squared   =    0.0526
       Total |  97175.5866     1,565  62.0930266   Root MSE        =    7.6699

------------------------------------------------------------------------------
     wt82_71 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        qsmk |
Smoking c..  |   4.036457    1.13904     3.54   0.000      1.80225    6.270665
          ps |   -12.3319   2.129602    -5.79   0.000    -16.50908   -8.154716
             |
   qsmk#c.ps |
Smoking c..  |  -2.038829   3.649684    -0.56   0.576    -9.197625    5.119967
             |
       _cons |   4.935432   .5570216     8.86   0.000     3.842843    6.028021
------------------------------------------------------------------------------



-------------------------------------------------------------------------------
-&gt; interv = -1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
       predY |      1,566      2.6383    1.838063    -3.4687   8.111371

-------------------------------------------------------------------------------
-&gt; interv = 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
       predY |      1,566    1.761898    1.433264  -4.645079   4.306496

-------------------------------------------------------------------------------
-&gt; interv = 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
       predY |      1,566    5.273676    1.670225  -2.192565   8.238971












observe[4,2]
               interv      value
  observed         -1  2.6382998
 E(Y(a=0))          0  1.7618979
 E(Y(a=1))          1  5.2736757
difference          .  3.5117778

(3,132 observations deleted)

(1,566 missing values generated)

      command:  bootstdz /
        EY_a0:  r(boot_0)
        EY_a1:  r(boot_1)
   difference:  r(boot_diff)

Simulations (500)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..................................................   100
..................................................   150
..................................................   200
..................................................   250
..................................................   300
..................................................   350
..................................................   400
..................................................   450
..................................................   500



pe[1,3]
        E(Y(a=0))   E(Y(a=1))  difference
value   1.7618979   5.2736757   3.5117778


Bootstrap results                               Number of obs     =      1,629
                                                Replications      =        500

------------------------------------------------------------------------------
             |   Observed   Bootstrap                         Normal-based
             |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       EY_a0 |   1.761898   .2273005     7.75   0.000     1.316397    2.207399
       EY_a1 |   5.273676   .4636993    11.37   0.000     4.364842     6.18251
  difference |   3.511778   .5247816     6.69   0.000     2.483225    4.540331
------------------------------------------------------------------------------


Bootstrap results                               Number of obs     =      1,629
                                                Replications      =        500

------------------------------------------------------------------------------
             |    Observed               Bootstrap
             |       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       EY_a0 |   1.7618979  -.0079171   .22730051    1.307729   2.191437   (P)
       EY_a1 |   5.2736757  -.0001726   .46369929    4.340613   6.210879   (P)
  difference |   3.5117778   .0077445    .5247816    2.531495   4.523983   (P)
------------------------------------------------------------------------------
(P)    percentile confidence interval</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="g-estimation-of-structural-nested-models-stata.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="instrumental-variables-estimation-stata.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/remlapmot/cibookex-r/edit/master/15-prop-scores-stata.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/remlapmot/cibookex-r/blob/master/15-prop-scores-stata.Rmd",
"text": null
},
"download": ["cibookex-r.pdf", "cibookex-r.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
