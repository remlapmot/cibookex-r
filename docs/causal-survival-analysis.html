<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>17. Causal survival analysis | Causal Inference: What If. R and Stata code for Exercises</title>
  <meta name="description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="17. Causal survival analysis | Causal Inference: What If. R and Stata code for Exercises" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="17. Causal survival analysis | Causal Inference: What If. R and Stata code for Exercises" />
  
  <meta name="twitter:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

<meta name="author" content="Book by M. A. Hern치n and J. M. Robins" />
<meta name="author" content="R code by Joy Shi and Sean McGrath" />
<meta name="author" content="Stata code by Eleanor Murray and Roger Logan" />
<meta name="author" content="R Markdown code by Tom Palmer" />


<meta name="date" content="2022-02-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="instrumental-variables-estimation.html"/>
<link rel="next" href="session-information-r.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Table of Contents</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-code"><i class="fa fa-check"></i>Downloading the code</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#installing-dependency-packages"><i class="fa fa-check"></i>Installing dependency packages</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-datasets"><i class="fa fa-check"></i>Downloading the datasets</a></li>
</ul></li>
<li class="part"><span><b>R code</b></span></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html"><i class="fa fa-check"></i>11. Why model?</a>
<ul>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.2"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.3"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.2"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.3"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.4"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.5"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.6"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.7"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.2"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.3"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.4"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.2"><i class="fa fa-check"></i>Program 14.2</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-one-possible-value-of-psi"><i class="fa fa-check"></i>G-estimation: Checking one possible value of psi</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-multiple-possible-values-of-psi"><i class="fa fa-check"></i>G-estimation: Checking multiple possible values of psi</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.3"><i class="fa fa-check"></i>Program 14.3</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-linear-mean-models"><i class="fa fa-check"></i>G-estimation: Closed form estimator linear mean models</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-for-2-parameter-model"><i class="fa fa-check"></i>G-estimation: Closed form estimator for 2-parameter model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.2"><i class="fa fa-check"></i>Program 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.3"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.4"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html"><i class="fa fa-check"></i>16. Instrumental variables estimation</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.2"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.3"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.4"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.5"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html"><i class="fa fa-check"></i>17. Causal survival analysis</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.2"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.3"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.4"><i class="fa fa-check"></i>Program 17.4</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.5"><i class="fa fa-check"></i>Program 17.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-r.html"><a href="session-information-r.html"><i class="fa fa-check"></i>Session information: R</a></li>
<li class="part"><span><b>Stata code</b></span></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html"><i class="fa fa-check"></i>11. Why model: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.1-1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.2-1"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.3-1"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.1-1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.2-1"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.3-1"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.4-1"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.5-1"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.6-1"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.7-1"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.1-1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.2-1"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.3-1"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.4-1"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.1-1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.2-1"><i class="fa fa-check"></i>Program 14.2</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.3-1"><i class="fa fa-check"></i>Program 14.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.1-1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#prorgam-15.2"><i class="fa fa-check"></i>Prorgam 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.3-1"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.4-1"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html"><i class="fa fa-check"></i>16. Instrumental variables estimation: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.1-1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.2-1"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.3-1"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.4-1"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.5-1"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html"><i class="fa fa-check"></i>17. Causal survival analysis: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.1-1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.2-1"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.3-1"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.4-1"><i class="fa fa-check"></i>Program 17.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-stata.html"><a href="session-information-stata.html"><i class="fa fa-check"></i>Session information: Stata</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Causal Inference: What If. R and Stata code for Exercises</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="causal-survival-analysis" class="section level1 unnumbered">
<h1>17. Causal survival analysis</h1>
<div id="program-17.1" class="section level2">
<h2>Program 17.1</h2>
<ul>
<li>Nonparametric estimation of survival curves</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="causal-survival-analysis.html#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code></pre></div>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="causal-survival-analysis.html#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb301-2"><a href="causal-survival-analysis.html#cb301-2" aria-hidden="true" tabindex="-1"></a>nhefs <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;NHEFS.xls&quot;</span>))</span>
<span id="cb301-3"><a href="causal-survival-analysis.html#cb301-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-4"><a href="causal-survival-analysis.html#cb301-4" aria-hidden="true" tabindex="-1"></a><span class="co"># some preprocessing of the data </span></span>
<span id="cb301-5"><a href="causal-survival-analysis.html#cb301-5" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>survtime <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(nhefs<span class="sc">$</span>death<span class="sc">==</span><span class="dv">0</span>, <span class="dv">120</span>, </span>
<span id="cb301-6"><a href="causal-survival-analysis.html#cb301-6" aria-hidden="true" tabindex="-1"></a>                         (nhefs<span class="sc">$</span>yrdth<span class="dv">-83</span>)<span class="sc">*</span><span class="dv">12</span><span class="sc">+</span>nhefs<span class="sc">$</span>modth) <span class="co"># yrdth ranges from 83 to 92</span></span>
<span id="cb301-7"><a href="causal-survival-analysis.html#cb301-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-8"><a href="causal-survival-analysis.html#cb301-8" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs<span class="sc">$</span>death, nhefs<span class="sc">$</span>qsmk)</span></code></pre></div>
<pre><code>##    
##       0   1
##   0 985 326
##   1 216 102</code></pre>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="causal-survival-analysis.html#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs[<span class="fu">which</span>(nhefs<span class="sc">$</span>death<span class="sc">==</span><span class="dv">1</span>),]<span class="sc">$</span>survtime)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.00   35.00   61.00   61.14   86.75  120.00</code></pre>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="causal-survival-analysis.html#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;survival&quot;)</span></span>
<span id="cb305-2"><a href="causal-survival-analysis.html#cb305-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;ggplot2&quot;) # for plots</span></span>
<span id="cb305-3"><a href="causal-survival-analysis.html#cb305-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;survminer&quot;) # for plots</span></span>
<span id="cb305-4"><a href="causal-survival-analysis.html#cb305-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;survival&quot;</span>)</span>
<span id="cb305-5"><a href="causal-survival-analysis.html#cb305-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb305-6"><a href="causal-survival-analysis.html#cb305-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;survminer&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: ggpubr</code></pre>
<pre><code>## 
## Attaching package: &#39;survminer&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:survival&#39;:
## 
##     myeloma</code></pre>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="causal-survival-analysis.html#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(survtime, death) <span class="sc">~</span> qsmk, <span class="at">data=</span>nhefs)</span></code></pre></div>
<pre><code>## Call:
## survdiff(formula = Surv(survtime, death) ~ qsmk, data = nhefs)
## 
##           N Observed Expected (O-E)^2/E (O-E)^2/V
## qsmk=0 1201      216    237.5      1.95      7.73
## qsmk=1  428      102     80.5      5.76      7.73
## 
##  Chisq= 7.7  on 1 degrees of freedom, p= 0.005</code></pre>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="causal-survival-analysis.html#cb311-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(survtime, death) <span class="sc">~</span> qsmk, <span class="at">data=</span>nhefs)</span>
<span id="cb311-2"><a href="causal-survival-analysis.html#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit, <span class="at">data =</span> nhefs, <span class="at">xlab=</span><span class="st">&quot;Months of follow-up&quot;</span>,</span>
<span id="cb311-3"><a href="causal-survival-analysis.html#cb311-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab=</span><span class="st">&quot;Survival probability&quot;</span>,</span>
<span id="cb311-4"><a href="causal-survival-analysis.html#cb311-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">main=</span><span class="st">&quot;Product-Limit Survival Estimates&quot;</span>, <span class="at">risk.table =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="17-causal-surv-r_files/figure-html/unnamed-chunk-2-1.png" width="85%" style="display: block; margin: auto;" /></p>
</div>
<div id="program-17.2" class="section level2">
<h2>Program 17.2</h2>
<ul>
<li>Parametric estimation of survival curves via hazards model</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="causal-survival-analysis.html#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creation of person-month data</span></span>
<span id="cb312-2"><a href="causal-survival-analysis.html#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;splitstackshape&quot;)</span></span>
<span id="cb312-3"><a href="causal-survival-analysis.html#cb312-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;splitstackshape&quot;</span>)</span>
<span id="cb312-4"><a href="causal-survival-analysis.html#cb312-4" aria-hidden="true" tabindex="-1"></a>nhefs.surv <span class="ot">&lt;-</span> <span class="fu">expandRows</span>(nhefs, <span class="st">&quot;survtime&quot;</span>, <span class="at">drop=</span>F) </span>
<span id="cb312-5"><a href="causal-survival-analysis.html#cb312-5" aria-hidden="true" tabindex="-1"></a>nhefs.surv<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">sequence</span>(<span class="fu">rle</span>(nhefs.surv<span class="sc">$</span>seqn)<span class="sc">$</span>lengths)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb312-6"><a href="causal-survival-analysis.html#cb312-6" aria-hidden="true" tabindex="-1"></a>nhefs.surv<span class="sc">$</span>event <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(nhefs.surv<span class="sc">$</span>time<span class="sc">==</span>nhefs.surv<span class="sc">$</span>survtime<span class="dv">-1</span> <span class="sc">&amp;</span> </span>
<span id="cb312-7"><a href="causal-survival-analysis.html#cb312-7" aria-hidden="true" tabindex="-1"></a>                             nhefs.surv<span class="sc">$</span>death<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb312-8"><a href="causal-survival-analysis.html#cb312-8" aria-hidden="true" tabindex="-1"></a>nhefs.surv<span class="sc">$</span>timesq <span class="ot">&lt;-</span> nhefs.surv<span class="sc">$</span>time<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb312-9"><a href="causal-survival-analysis.html#cb312-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-10"><a href="causal-survival-analysis.html#cb312-10" aria-hidden="true" tabindex="-1"></a><span class="co"># fit of parametric hazards model</span></span>
<span id="cb312-11"><a href="causal-survival-analysis.html#cb312-11" aria-hidden="true" tabindex="-1"></a>hazards.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(event<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> qsmk <span class="sc">+</span> <span class="fu">I</span>(qsmk<span class="sc">*</span>time) <span class="sc">+</span> <span class="fu">I</span>(qsmk<span class="sc">*</span>timesq) <span class="sc">+</span> </span>
<span id="cb312-12"><a href="causal-survival-analysis.html#cb312-12" aria-hidden="true" tabindex="-1"></a>                       time <span class="sc">+</span> timesq, <span class="at">family=</span><span class="fu">binomial</span>(), <span class="at">data=</span>nhefs.surv)</span>
<span id="cb312-13"><a href="causal-survival-analysis.html#cb312-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hazards.model)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = event == 0 ~ qsmk + I(qsmk * time) + I(qsmk * timesq) + 
##     time + timesq, family = binomial(), data = nhefs.surv)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -3.7253   0.0546   0.0601   0.0625   0.0783  
## 
## Coefficients:
##                    Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)       6.996e+00  2.309e-01  30.292   &lt;2e-16 ***
## qsmk             -3.355e-01  3.970e-01  -0.845   0.3981    
## I(qsmk * time)   -1.208e-02  1.503e-02  -0.804   0.4215    
## I(qsmk * timesq)  1.612e-04  1.246e-04   1.293   0.1960    
## time             -1.960e-02  8.413e-03  -2.329   0.0198 *  
## timesq            1.256e-04  6.686e-05   1.878   0.0604 .  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4655.3  on 176763  degrees of freedom
## Residual deviance: 4631.3  on 176758  degrees of freedom
## AIC: 4643.3
## 
## Number of Fisher Scoring iterations: 9</code></pre>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="causal-survival-analysis.html#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creation of dataset with all time points under each treatment level</span></span>
<span id="cb314-2"><a href="causal-survival-analysis.html#cb314-2" aria-hidden="true" tabindex="-1"></a>qsmk0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>),<span class="dv">0</span>,(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>))<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb314-3"><a href="causal-survival-analysis.html#cb314-3" aria-hidden="true" tabindex="-1"></a>qsmk1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>),<span class="dv">1</span>,(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>))<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb314-4"><a href="causal-survival-analysis.html#cb314-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-5"><a href="causal-survival-analysis.html#cb314-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(qsmk0) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;qsmk&quot;</span>, <span class="st">&quot;timesq&quot;</span>)</span>
<span id="cb314-6"><a href="causal-survival-analysis.html#cb314-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(qsmk1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;qsmk&quot;</span>, <span class="st">&quot;timesq&quot;</span>)</span>
<span id="cb314-7"><a href="causal-survival-analysis.html#cb314-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-8"><a href="causal-survival-analysis.html#cb314-8" aria-hidden="true" tabindex="-1"></a><span class="co"># assignment of estimated (1-hazard) to each person-month */</span></span>
<span id="cb314-9"><a href="causal-survival-analysis.html#cb314-9" aria-hidden="true" tabindex="-1"></a>qsmk0<span class="sc">$</span>p.noevent0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(hazards.model, qsmk0, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb314-10"><a href="causal-survival-analysis.html#cb314-10" aria-hidden="true" tabindex="-1"></a>qsmk1<span class="sc">$</span>p.noevent1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(hazards.model, qsmk1, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb314-11"><a href="causal-survival-analysis.html#cb314-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-12"><a href="causal-survival-analysis.html#cb314-12" aria-hidden="true" tabindex="-1"></a><span class="co"># computation of survival for each person-month</span></span>
<span id="cb314-13"><a href="causal-survival-analysis.html#cb314-13" aria-hidden="true" tabindex="-1"></a>qsmk0<span class="sc">$</span>surv0 <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(qsmk0<span class="sc">$</span>p.noevent0)</span>
<span id="cb314-14"><a href="causal-survival-analysis.html#cb314-14" aria-hidden="true" tabindex="-1"></a>qsmk1<span class="sc">$</span>surv1 <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(qsmk1<span class="sc">$</span>p.noevent1)</span>
<span id="cb314-15"><a href="causal-survival-analysis.html#cb314-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-16"><a href="causal-survival-analysis.html#cb314-16" aria-hidden="true" tabindex="-1"></a><span class="co"># some data management to plot estimated survival curves</span></span>
<span id="cb314-17"><a href="causal-survival-analysis.html#cb314-17" aria-hidden="true" tabindex="-1"></a>hazards.graph <span class="ot">&lt;-</span> <span class="fu">merge</span>(qsmk0, qsmk1, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;timesq&quot;</span>))</span>
<span id="cb314-18"><a href="causal-survival-analysis.html#cb314-18" aria-hidden="true" tabindex="-1"></a>hazards.graph<span class="sc">$</span>survdiff <span class="ot">&lt;-</span> hazards.graph<span class="sc">$</span>surv1<span class="sc">-</span>hazards.graph<span class="sc">$</span>surv0</span>
<span id="cb314-19"><a href="causal-survival-analysis.html#cb314-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-20"><a href="causal-survival-analysis.html#cb314-20" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb314-21"><a href="causal-survival-analysis.html#cb314-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hazards.graph, <span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>surv)) <span class="sc">+</span> </span>
<span id="cb314-22"><a href="causal-survival-analysis.html#cb314-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> surv0, <span class="at">colour =</span> <span class="st">&quot;0&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb314-23"><a href="causal-survival-analysis.html#cb314-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> surv1, <span class="at">colour =</span> <span class="st">&quot;1&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb314-24"><a href="causal-survival-analysis.html#cb314-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Months&quot;</span>) <span class="sc">+</span> </span>
<span id="cb314-25"><a href="causal-survival-analysis.html#cb314-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">120</span>,<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb314-26"><a href="causal-survival-analysis.html#cb314-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.6</span>, <span class="dv">1</span>), <span class="at">breaks=</span><span class="fu">seq</span>(<span class="fl">0.6</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb314-27"><a href="causal-survival-analysis.html#cb314-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Survival&quot;</span>) <span class="sc">+</span> </span>
<span id="cb314-28"><a href="causal-survival-analysis.html#cb314-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Survival from hazards model&quot;</span>) <span class="sc">+</span> </span>
<span id="cb314-29"><a href="causal-survival-analysis.html#cb314-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour=</span><span class="st">&quot;A:&quot;</span>) <span class="sc">+</span></span>
<span id="cb314-30"><a href="causal-survival-analysis.html#cb314-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb314-31"><a href="causal-survival-analysis.html#cb314-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="17-causal-surv-r_files/figure-html/unnamed-chunk-3-1.png" width="85%" style="display: block; margin: auto;" /></p>
</div>
<div id="program-17.3" class="section level2">
<h2>Program 17.3</h2>
<ul>
<li>Estimation of survival curves via IP weighted hazards model</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="causal-survival-analysis.html#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights</span></span>
<span id="cb315-2"><a href="causal-survival-analysis.html#cb315-2" aria-hidden="true" tabindex="-1"></a>p.denom <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> sex <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">*</span>age) <span class="sc">+</span> <span class="fu">as.factor</span>(education)</span>
<span id="cb315-3"><a href="causal-survival-analysis.html#cb315-3" aria-hidden="true" tabindex="-1"></a>               <span class="sc">+</span> smokeintensity <span class="sc">+</span> <span class="fu">I</span>(smokeintensity<span class="sc">*</span>smokeintensity)</span>
<span id="cb315-4"><a href="causal-survival-analysis.html#cb315-4" aria-hidden="true" tabindex="-1"></a>               <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs<span class="sc">*</span>smokeyrs) <span class="sc">+</span> <span class="fu">as.factor</span>(exercise)</span>
<span id="cb315-5"><a href="causal-survival-analysis.html#cb315-5" aria-hidden="true" tabindex="-1"></a>               <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71<span class="sc">*</span>wt71), </span>
<span id="cb315-6"><a href="causal-survival-analysis.html#cb315-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>nhefs, <span class="at">family=</span><span class="fu">binomial</span>())</span>
<span id="cb315-7"><a href="causal-survival-analysis.html#cb315-7" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>pd.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(p.denom, nhefs, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb315-8"><a href="causal-survival-analysis.html#cb315-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-9"><a href="causal-survival-analysis.html#cb315-9" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights</span></span>
<span id="cb315-10"><a href="causal-survival-analysis.html#cb315-10" aria-hidden="true" tabindex="-1"></a>p.num <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data=</span>nhefs, <span class="at">family=</span><span class="fu">binomial</span>())</span>
<span id="cb315-11"><a href="causal-survival-analysis.html#cb315-11" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>pn.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(p.num, nhefs, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb315-12"><a href="causal-survival-analysis.html#cb315-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-13"><a href="causal-survival-analysis.html#cb315-13" aria-hidden="true" tabindex="-1"></a><span class="co"># computation of estimated weights</span></span>
<span id="cb315-14"><a href="causal-survival-analysis.html#cb315-14" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>sw.a <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(nhefs<span class="sc">$</span>qsmk<span class="sc">==</span><span class="dv">1</span>, nhefs<span class="sc">$</span>pn.qsmk<span class="sc">/</span>nhefs<span class="sc">$</span>pd.qsmk,</span>
<span id="cb315-15"><a href="causal-survival-analysis.html#cb315-15" aria-hidden="true" tabindex="-1"></a>                     (<span class="dv">1</span><span class="sc">-</span>nhefs<span class="sc">$</span>pn.qsmk)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>nhefs<span class="sc">$</span>pd.qsmk))</span>
<span id="cb315-16"><a href="causal-survival-analysis.html#cb315-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs<span class="sc">$</span>sw.a)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.3312  0.8640  0.9504  0.9991  1.0755  4.2054</code></pre>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="causal-survival-analysis.html#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creation of person-month data</span></span>
<span id="cb317-2"><a href="causal-survival-analysis.html#cb317-2" aria-hidden="true" tabindex="-1"></a>nhefs.ipw <span class="ot">&lt;-</span> <span class="fu">expandRows</span>(nhefs, <span class="st">&quot;survtime&quot;</span>, <span class="at">drop=</span>F) </span>
<span id="cb317-3"><a href="causal-survival-analysis.html#cb317-3" aria-hidden="true" tabindex="-1"></a>nhefs.ipw<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">sequence</span>(<span class="fu">rle</span>(nhefs.ipw<span class="sc">$</span>seqn)<span class="sc">$</span>lengths)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb317-4"><a href="causal-survival-analysis.html#cb317-4" aria-hidden="true" tabindex="-1"></a>nhefs.ipw<span class="sc">$</span>event <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(nhefs.ipw<span class="sc">$</span>time<span class="sc">==</span>nhefs.ipw<span class="sc">$</span>survtime<span class="dv">-1</span> <span class="sc">&amp;</span> </span>
<span id="cb317-5"><a href="causal-survival-analysis.html#cb317-5" aria-hidden="true" tabindex="-1"></a>                            nhefs.ipw<span class="sc">$</span>death<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb317-6"><a href="causal-survival-analysis.html#cb317-6" aria-hidden="true" tabindex="-1"></a>nhefs.ipw<span class="sc">$</span>timesq <span class="ot">&lt;-</span> nhefs.ipw<span class="sc">$</span>time<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb317-7"><a href="causal-survival-analysis.html#cb317-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-8"><a href="causal-survival-analysis.html#cb317-8" aria-hidden="true" tabindex="-1"></a><span class="co"># fit of weighted hazards model</span></span>
<span id="cb317-9"><a href="causal-survival-analysis.html#cb317-9" aria-hidden="true" tabindex="-1"></a>ipw.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(event<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> qsmk <span class="sc">+</span> <span class="fu">I</span>(qsmk<span class="sc">*</span>time) <span class="sc">+</span> <span class="fu">I</span>(qsmk<span class="sc">*</span>timesq) <span class="sc">+</span> </span>
<span id="cb317-10"><a href="causal-survival-analysis.html#cb317-10" aria-hidden="true" tabindex="-1"></a>                   time <span class="sc">+</span> timesq, <span class="at">family=</span><span class="fu">binomial</span>(), <span class="at">weight=</span>sw.a,</span>
<span id="cb317-11"><a href="causal-survival-analysis.html#cb317-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data=</span>nhefs.ipw)</span></code></pre></div>
<pre><code>## Warning in eval(family$initialize): non-integer #successes in a binomial glm!</code></pre>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="causal-survival-analysis.html#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ipw.model)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = event == 0 ~ qsmk + I(qsmk * time) + I(qsmk * timesq) + 
##     time + timesq, family = binomial(), data = nhefs.ipw, weights = sw.a)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -7.1859   0.0528   0.0595   0.0640   0.1452  
## 
## Coefficients:
##                    Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)       6.897e+00  2.208e-01  31.242   &lt;2e-16 ***
## qsmk              1.794e-01  4.399e-01   0.408   0.6834    
## I(qsmk * time)   -1.895e-02  1.640e-02  -1.155   0.2481    
## I(qsmk * timesq)  2.103e-04  1.352e-04   1.556   0.1198    
## time             -1.889e-02  8.053e-03  -2.345   0.0190 *  
## timesq            1.181e-04  6.399e-05   1.846   0.0649 .  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4643.9  on 176763  degrees of freedom
## Residual deviance: 4626.2  on 176758  degrees of freedom
## AIC: 4633.5
## 
## Number of Fisher Scoring iterations: 9</code></pre>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="causal-survival-analysis.html#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creation of survival curves</span></span>
<span id="cb321-2"><a href="causal-survival-analysis.html#cb321-2" aria-hidden="true" tabindex="-1"></a>ipw.qsmk0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>),<span class="dv">0</span>,(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>))<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb321-3"><a href="causal-survival-analysis.html#cb321-3" aria-hidden="true" tabindex="-1"></a>ipw.qsmk1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>),<span class="dv">1</span>,(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>))<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb321-4"><a href="causal-survival-analysis.html#cb321-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-5"><a href="causal-survival-analysis.html#cb321-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ipw.qsmk0) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;qsmk&quot;</span>, <span class="st">&quot;timesq&quot;</span>)</span>
<span id="cb321-6"><a href="causal-survival-analysis.html#cb321-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ipw.qsmk1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;qsmk&quot;</span>, <span class="st">&quot;timesq&quot;</span>)</span>
<span id="cb321-7"><a href="causal-survival-analysis.html#cb321-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-8"><a href="causal-survival-analysis.html#cb321-8" aria-hidden="true" tabindex="-1"></a><span class="co"># assignment of estimated (1-hazard) to each person-month */</span></span>
<span id="cb321-9"><a href="causal-survival-analysis.html#cb321-9" aria-hidden="true" tabindex="-1"></a>ipw.qsmk0<span class="sc">$</span>p.noevent0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(ipw.model, ipw.qsmk0, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb321-10"><a href="causal-survival-analysis.html#cb321-10" aria-hidden="true" tabindex="-1"></a>ipw.qsmk1<span class="sc">$</span>p.noevent1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(ipw.model, ipw.qsmk1, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb321-11"><a href="causal-survival-analysis.html#cb321-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-12"><a href="causal-survival-analysis.html#cb321-12" aria-hidden="true" tabindex="-1"></a><span class="co"># computation of survival for each person-month</span></span>
<span id="cb321-13"><a href="causal-survival-analysis.html#cb321-13" aria-hidden="true" tabindex="-1"></a>ipw.qsmk0<span class="sc">$</span>surv0 <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(ipw.qsmk0<span class="sc">$</span>p.noevent0)</span>
<span id="cb321-14"><a href="causal-survival-analysis.html#cb321-14" aria-hidden="true" tabindex="-1"></a>ipw.qsmk1<span class="sc">$</span>surv1 <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(ipw.qsmk1<span class="sc">$</span>p.noevent1)</span>
<span id="cb321-15"><a href="causal-survival-analysis.html#cb321-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-16"><a href="causal-survival-analysis.html#cb321-16" aria-hidden="true" tabindex="-1"></a><span class="co"># some data management to plot estimated survival curves</span></span>
<span id="cb321-17"><a href="causal-survival-analysis.html#cb321-17" aria-hidden="true" tabindex="-1"></a>ipw.graph <span class="ot">&lt;-</span> <span class="fu">merge</span>(ipw.qsmk0, ipw.qsmk1, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;timesq&quot;</span>))</span>
<span id="cb321-18"><a href="causal-survival-analysis.html#cb321-18" aria-hidden="true" tabindex="-1"></a>ipw.graph<span class="sc">$</span>survdiff <span class="ot">&lt;-</span> ipw.graph<span class="sc">$</span>surv1<span class="sc">-</span>ipw.graph<span class="sc">$</span>surv0</span>
<span id="cb321-19"><a href="causal-survival-analysis.html#cb321-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-20"><a href="causal-survival-analysis.html#cb321-20" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb321-21"><a href="causal-survival-analysis.html#cb321-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ipw.graph, <span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>surv)) <span class="sc">+</span> </span>
<span id="cb321-22"><a href="causal-survival-analysis.html#cb321-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> surv0, <span class="at">colour =</span> <span class="st">&quot;0&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb321-23"><a href="causal-survival-analysis.html#cb321-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> surv1, <span class="at">colour =</span> <span class="st">&quot;1&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb321-24"><a href="causal-survival-analysis.html#cb321-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Months&quot;</span>) <span class="sc">+</span> </span>
<span id="cb321-25"><a href="causal-survival-analysis.html#cb321-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">120</span>,<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb321-26"><a href="causal-survival-analysis.html#cb321-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.6</span>, <span class="dv">1</span>), <span class="at">breaks=</span><span class="fu">seq</span>(<span class="fl">0.6</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb321-27"><a href="causal-survival-analysis.html#cb321-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Survival&quot;</span>) <span class="sc">+</span> </span>
<span id="cb321-28"><a href="causal-survival-analysis.html#cb321-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Survival from IP weighted hazards model&quot;</span>) <span class="sc">+</span> </span>
<span id="cb321-29"><a href="causal-survival-analysis.html#cb321-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour=</span><span class="st">&quot;A:&quot;</span>) <span class="sc">+</span></span>
<span id="cb321-30"><a href="causal-survival-analysis.html#cb321-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb321-31"><a href="causal-survival-analysis.html#cb321-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="17-causal-surv-r_files/figure-html/unnamed-chunk-4-1.png" width="85%" style="display: block; margin: auto;" /></p>
</div>
<div id="program-17.4" class="section level2">
<h2>Program 17.4</h2>
<ul>
<li>Estimating of survival curves via g-formula</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="causal-survival-analysis.html#cb322-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit of hazards model with covariates</span></span>
<span id="cb322-2"><a href="causal-survival-analysis.html#cb322-2" aria-hidden="true" tabindex="-1"></a>gf.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(event<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> qsmk <span class="sc">+</span> <span class="fu">I</span>(qsmk<span class="sc">*</span>time) <span class="sc">+</span> <span class="fu">I</span>(qsmk<span class="sc">*</span>timesq)</span>
<span id="cb322-3"><a href="causal-survival-analysis.html#cb322-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> time <span class="sc">+</span> timesq <span class="sc">+</span> sex <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">*</span>age)</span>
<span id="cb322-4"><a href="causal-survival-analysis.html#cb322-4" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity </span>
<span id="cb322-5"><a href="causal-survival-analysis.html#cb322-5" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> <span class="fu">I</span>(smokeintensity<span class="sc">*</span>smokeintensity) <span class="sc">+</span> smkintensity82_71 </span>
<span id="cb322-6"><a href="causal-survival-analysis.html#cb322-6" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs<span class="sc">*</span>smokeyrs) <span class="sc">+</span> <span class="fu">as.factor</span>(exercise) </span>
<span id="cb322-7"><a href="causal-survival-analysis.html#cb322-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71<span class="sc">*</span>wt71), </span>
<span id="cb322-8"><a href="causal-survival-analysis.html#cb322-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">data=</span>nhefs.surv, <span class="at">family=</span><span class="fu">binomial</span>())</span>
<span id="cb322-9"><a href="causal-survival-analysis.html#cb322-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gf.model)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = event == 0 ~ qsmk + I(qsmk * time) + I(qsmk * timesq) + 
##     time + timesq + sex + race + age + I(age * age) + as.factor(education) + 
##     smokeintensity + I(smokeintensity * smokeintensity) + smkintensity82_71 + 
##     smokeyrs + I(smokeyrs * smokeyrs) + as.factor(exercise) + 
##     as.factor(active) + wt71 + I(wt71 * wt71), family = binomial(), 
##     data = nhefs.surv)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -4.3160   0.0244   0.0395   0.0640   0.3303  
## 
## Coefficients:
##                                      Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)                         9.272e+00  1.379e+00   6.724 1.76e-11 ***
## qsmk                                5.959e-02  4.154e-01   0.143 0.885924    
## I(qsmk * time)                     -1.485e-02  1.506e-02  -0.987 0.323824    
## I(qsmk * timesq)                    1.702e-04  1.245e-04   1.367 0.171643    
## time                               -2.270e-02  8.437e-03  -2.690 0.007142 ** 
## timesq                              1.174e-04  6.709e-05   1.751 0.080020 .  
## sex                                 4.368e-01  1.409e-01   3.101 0.001930 ** 
## race                               -5.240e-02  1.734e-01  -0.302 0.762572    
## age                                -8.750e-02  5.907e-02  -1.481 0.138536    
## I(age * age)                        8.128e-05  5.470e-04   0.149 0.881865    
## as.factor(education)2               1.401e-01  1.566e-01   0.895 0.370980    
## as.factor(education)3               4.335e-01  1.526e-01   2.841 0.004502 ** 
## as.factor(education)4               2.350e-01  2.790e-01   0.842 0.399750    
## as.factor(education)5               3.750e-01  2.386e-01   1.571 0.116115    
## smokeintensity                     -1.626e-03  1.430e-02  -0.114 0.909431    
## I(smokeintensity * smokeintensity) -7.182e-05  2.390e-04  -0.301 0.763741    
## smkintensity82_71                  -1.686e-03  6.501e-03  -0.259 0.795399    
## smokeyrs                           -1.677e-02  3.065e-02  -0.547 0.584153    
## I(smokeyrs * smokeyrs)             -5.280e-05  4.244e-04  -0.124 0.900997    
## as.factor(exercise)1                1.469e-01  1.792e-01   0.820 0.412300    
## as.factor(exercise)2               -1.504e-01  1.762e-01  -0.854 0.393177    
## as.factor(active)1                 -1.601e-01  1.300e-01  -1.232 0.218048    
## as.factor(active)2                 -2.294e-01  1.877e-01  -1.222 0.221766    
## wt71                                6.222e-02  1.902e-02   3.271 0.001073 ** 
## I(wt71 * wt71)                     -4.046e-04  1.129e-04  -3.584 0.000338 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4655.3  on 176763  degrees of freedom
## Residual deviance: 4185.7  on 176739  degrees of freedom
## AIC: 4235.7
## 
## Number of Fisher Scoring iterations: 10</code></pre>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="causal-survival-analysis.html#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creation of dataset with all time points for </span></span>
<span id="cb324-2"><a href="causal-survival-analysis.html#cb324-2" aria-hidden="true" tabindex="-1"></a><span class="co"># each individual under each treatment level</span></span>
<span id="cb324-3"><a href="causal-survival-analysis.html#cb324-3" aria-hidden="true" tabindex="-1"></a>gf.qsmk0 <span class="ot">&lt;-</span> <span class="fu">expandRows</span>(nhefs, <span class="at">count=</span><span class="dv">120</span>, <span class="at">count.is.col=</span>F) </span>
<span id="cb324-4"><a href="causal-survival-analysis.html#cb324-4" aria-hidden="true" tabindex="-1"></a>gf.qsmk0<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">119</span>), <span class="fu">nrow</span>(nhefs))</span>
<span id="cb324-5"><a href="causal-survival-analysis.html#cb324-5" aria-hidden="true" tabindex="-1"></a>gf.qsmk0<span class="sc">$</span>timesq <span class="ot">&lt;-</span> gf.qsmk0<span class="sc">$</span>time<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb324-6"><a href="causal-survival-analysis.html#cb324-6" aria-hidden="true" tabindex="-1"></a>gf.qsmk0<span class="sc">$</span>qsmk <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb324-7"><a href="causal-survival-analysis.html#cb324-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-8"><a href="causal-survival-analysis.html#cb324-8" aria-hidden="true" tabindex="-1"></a>gf.qsmk1 <span class="ot">&lt;-</span> gf.qsmk0</span>
<span id="cb324-9"><a href="causal-survival-analysis.html#cb324-9" aria-hidden="true" tabindex="-1"></a>gf.qsmk1<span class="sc">$</span>qsmk <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb324-10"><a href="causal-survival-analysis.html#cb324-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-11"><a href="causal-survival-analysis.html#cb324-11" aria-hidden="true" tabindex="-1"></a>gf.qsmk0<span class="sc">$</span>p.noevent0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(gf.model, gf.qsmk0, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb324-12"><a href="causal-survival-analysis.html#cb324-12" aria-hidden="true" tabindex="-1"></a>gf.qsmk1<span class="sc">$</span>p.noevent1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(gf.model, gf.qsmk1, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb324-13"><a href="causal-survival-analysis.html#cb324-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-14"><a href="causal-survival-analysis.html#cb324-14" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;dplyr&quot;)</span></span>
<span id="cb324-15"><a href="causal-survival-analysis.html#cb324-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;dplyr&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="causal-survival-analysis.html#cb328-1" aria-hidden="true" tabindex="-1"></a>gf.qsmk0.surv <span class="ot">&lt;-</span> gf.qsmk0 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(seqn) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">surv0 =</span> <span class="fu">cumprod</span>(p.noevent0))</span>
<span id="cb328-2"><a href="causal-survival-analysis.html#cb328-2" aria-hidden="true" tabindex="-1"></a>gf.qsmk1.surv <span class="ot">&lt;-</span> gf.qsmk1 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(seqn) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">surv1 =</span> <span class="fu">cumprod</span>(p.noevent1))</span>
<span id="cb328-3"><a href="causal-survival-analysis.html#cb328-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-4"><a href="causal-survival-analysis.html#cb328-4" aria-hidden="true" tabindex="-1"></a>gf.surv0 <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(gf.qsmk0.surv, <span class="at">by=</span><span class="fu">list</span>(gf.qsmk0.surv<span class="sc">$</span>time), <span class="at">FUN=</span>mean)[<span class="fu">c</span>(<span class="st">&quot;qsmk&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;surv0&quot;</span>)]</span>
<span id="cb328-5"><a href="causal-survival-analysis.html#cb328-5" aria-hidden="true" tabindex="-1"></a>gf.surv1 <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(gf.qsmk1.surv, <span class="at">by=</span><span class="fu">list</span>(gf.qsmk1.surv<span class="sc">$</span>time), <span class="at">FUN=</span>mean)[<span class="fu">c</span>(<span class="st">&quot;qsmk&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;surv1&quot;</span>)]</span>
<span id="cb328-6"><a href="causal-survival-analysis.html#cb328-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-7"><a href="causal-survival-analysis.html#cb328-7" aria-hidden="true" tabindex="-1"></a>gf.graph <span class="ot">&lt;-</span> <span class="fu">merge</span>(gf.surv0, gf.surv1, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;time&quot;</span>))</span>
<span id="cb328-8"><a href="causal-survival-analysis.html#cb328-8" aria-hidden="true" tabindex="-1"></a>gf.graph<span class="sc">$</span>survdiff <span class="ot">&lt;-</span> gf.graph<span class="sc">$</span>surv1<span class="sc">-</span>gf.graph<span class="sc">$</span>surv0</span>
<span id="cb328-9"><a href="causal-survival-analysis.html#cb328-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-10"><a href="causal-survival-analysis.html#cb328-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb328-11"><a href="causal-survival-analysis.html#cb328-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gf.graph, <span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>surv)) <span class="sc">+</span> </span>
<span id="cb328-12"><a href="causal-survival-analysis.html#cb328-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> surv0, <span class="at">colour =</span> <span class="st">&quot;0&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb328-13"><a href="causal-survival-analysis.html#cb328-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> surv1, <span class="at">colour =</span> <span class="st">&quot;1&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb328-14"><a href="causal-survival-analysis.html#cb328-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Months&quot;</span>) <span class="sc">+</span> </span>
<span id="cb328-15"><a href="causal-survival-analysis.html#cb328-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">120</span>,<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb328-16"><a href="causal-survival-analysis.html#cb328-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.6</span>, <span class="dv">1</span>), <span class="at">breaks=</span><span class="fu">seq</span>(<span class="fl">0.6</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb328-17"><a href="causal-survival-analysis.html#cb328-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Survival&quot;</span>) <span class="sc">+</span> </span>
<span id="cb328-18"><a href="causal-survival-analysis.html#cb328-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Survival from g-formula&quot;</span>) <span class="sc">+</span> </span>
<span id="cb328-19"><a href="causal-survival-analysis.html#cb328-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour=</span><span class="st">&quot;A:&quot;</span>) <span class="sc">+</span></span>
<span id="cb328-20"><a href="causal-survival-analysis.html#cb328-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb328-21"><a href="causal-survival-analysis.html#cb328-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="17-causal-surv-r_files/figure-html/unnamed-chunk-5-1.png" width="85%" style="display: block; margin: auto;" /></p>
</div>
<div id="program-17.5" class="section level2">
<h2>Program 17.5</h2>
<ul>
<li>Estimating of median survival time ratio via a structural nested AFT model</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="causal-survival-analysis.html#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="co"># some preprocessing of the data</span></span>
<span id="cb329-2"><a href="causal-survival-analysis.html#cb329-2" aria-hidden="true" tabindex="-1"></a>nhefs <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;NHEFS.xls&quot;</span>))</span>
<span id="cb329-3"><a href="causal-survival-analysis.html#cb329-3" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>survtime <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(nhefs<span class="sc">$</span>death<span class="sc">==</span><span class="dv">0</span>, <span class="cn">NA</span>, (nhefs<span class="sc">$</span>yrdth<span class="dv">-83</span>)<span class="sc">*</span><span class="dv">12</span><span class="sc">+</span>nhefs<span class="sc">$</span>modth) <span class="co"># * yrdth ranges from 83 to 92</span></span>
<span id="cb329-4"><a href="causal-survival-analysis.html#cb329-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-5"><a href="causal-survival-analysis.html#cb329-5" aria-hidden="true" tabindex="-1"></a><span class="co"># model to estimate E[A|L]</span></span>
<span id="cb329-6"><a href="causal-survival-analysis.html#cb329-6" aria-hidden="true" tabindex="-1"></a>modelA <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> sex <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">*</span>age)</span>
<span id="cb329-7"><a href="causal-survival-analysis.html#cb329-7" aria-hidden="true" tabindex="-1"></a>              <span class="sc">+</span> <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity</span>
<span id="cb329-8"><a href="causal-survival-analysis.html#cb329-8" aria-hidden="true" tabindex="-1"></a>              <span class="sc">+</span> <span class="fu">I</span>(smokeintensity<span class="sc">*</span>smokeintensity) <span class="sc">+</span> smokeyrs</span>
<span id="cb329-9"><a href="causal-survival-analysis.html#cb329-9" aria-hidden="true" tabindex="-1"></a>              <span class="sc">+</span> <span class="fu">I</span>(smokeyrs<span class="sc">*</span>smokeyrs) <span class="sc">+</span> <span class="fu">as.factor</span>(exercise)</span>
<span id="cb329-10"><a href="causal-survival-analysis.html#cb329-10" aria-hidden="true" tabindex="-1"></a>              <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71<span class="sc">*</span>wt71),</span>
<span id="cb329-11"><a href="causal-survival-analysis.html#cb329-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nhefs, <span class="at">family=</span><span class="fu">binomial</span>())</span>
<span id="cb329-12"><a href="causal-survival-analysis.html#cb329-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-13"><a href="causal-survival-analysis.html#cb329-13" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>p.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelA, nhefs, <span class="at">type=</span><span class="st">&quot;response&quot;</span>) </span>
<span id="cb329-14"><a href="causal-survival-analysis.html#cb329-14" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> nhefs[<span class="sc">!</span><span class="fu">is.na</span>(nhefs<span class="sc">$</span>survtime),] <span class="co"># select only those with observed death time</span></span>
<span id="cb329-15"><a href="causal-survival-analysis.html#cb329-15" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d)</span>
<span id="cb329-16"><a href="causal-survival-analysis.html#cb329-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-17"><a href="causal-survival-analysis.html#cb329-17" aria-hidden="true" tabindex="-1"></a><span class="co"># define the estimating function that needs to be minimized</span></span>
<span id="cb329-18"><a href="causal-survival-analysis.html#cb329-18" aria-hidden="true" tabindex="-1"></a>sumeef <span class="ot">&lt;-</span> <span class="cf">function</span>(psi){</span>
<span id="cb329-19"><a href="causal-survival-analysis.html#cb329-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb329-20"><a href="causal-survival-analysis.html#cb329-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># creation of delta indicator</span></span>
<span id="cb329-21"><a href="causal-survival-analysis.html#cb329-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (psi<span class="sc">&gt;=</span><span class="dv">0</span>){</span>
<span id="cb329-22"><a href="causal-survival-analysis.html#cb329-22" aria-hidden="true" tabindex="-1"></a>    delta <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(d<span class="sc">$</span>qsmk<span class="sc">==</span><span class="dv">0</span> <span class="sc">|</span> </span>
<span id="cb329-23"><a href="causal-survival-analysis.html#cb329-23" aria-hidden="true" tabindex="-1"></a>                      (d<span class="sc">$</span>qsmk<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> psi <span class="sc">&lt;=</span> <span class="fu">log</span>(<span class="dv">120</span><span class="sc">/</span>d<span class="sc">$</span>survtime)), </span>
<span id="cb329-24"><a href="causal-survival-analysis.html#cb329-24" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb329-25"><a href="causal-survival-analysis.html#cb329-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (psi <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb329-26"><a href="causal-survival-analysis.html#cb329-26" aria-hidden="true" tabindex="-1"></a>    delta <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(d<span class="sc">$</span>qsmk<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> </span>
<span id="cb329-27"><a href="causal-survival-analysis.html#cb329-27" aria-hidden="true" tabindex="-1"></a>                      (d<span class="sc">$</span>qsmk<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> psi <span class="sc">&gt;</span> <span class="fu">log</span>(d<span class="sc">$</span>survtime<span class="sc">/</span><span class="dv">120</span>)), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb329-28"><a href="causal-survival-analysis.html#cb329-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb329-29"><a href="causal-survival-analysis.html#cb329-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb329-30"><a href="causal-survival-analysis.html#cb329-30" aria-hidden="true" tabindex="-1"></a>  smat <span class="ot">&lt;-</span> delta<span class="sc">*</span>(d<span class="sc">$</span>qsmk<span class="sc">-</span>d<span class="sc">$</span>p.qsmk)</span>
<span id="cb329-31"><a href="causal-survival-analysis.html#cb329-31" aria-hidden="true" tabindex="-1"></a>  sval <span class="ot">&lt;-</span> <span class="fu">sum</span>(smat, <span class="at">na.rm=</span>T)</span>
<span id="cb329-32"><a href="causal-survival-analysis.html#cb329-32" aria-hidden="true" tabindex="-1"></a>  save <span class="ot">&lt;-</span> sval<span class="sc">/</span>n</span>
<span id="cb329-33"><a href="causal-survival-analysis.html#cb329-33" aria-hidden="true" tabindex="-1"></a>  smat <span class="ot">&lt;-</span> smat <span class="sc">-</span> <span class="fu">rep</span>(save, n)</span>
<span id="cb329-34"><a href="causal-survival-analysis.html#cb329-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb329-35"><a href="causal-survival-analysis.html#cb329-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># covariance</span></span>
<span id="cb329-36"><a href="causal-survival-analysis.html#cb329-36" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">t</span>(smat) <span class="sc">%*%</span> smat</span>
<span id="cb329-37"><a href="causal-survival-analysis.html#cb329-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sigma <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb329-38"><a href="causal-survival-analysis.html#cb329-38" aria-hidden="true" tabindex="-1"></a>    sigma <span class="ot">&lt;-</span> <span class="fl">1e-16</span></span>
<span id="cb329-39"><a href="causal-survival-analysis.html#cb329-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb329-40"><a href="causal-survival-analysis.html#cb329-40" aria-hidden="true" tabindex="-1"></a>  estimeq <span class="ot">&lt;-</span> sval<span class="sc">*</span><span class="fu">solve</span>(sigma)<span class="sc">*</span><span class="fu">t</span>(sval)</span>
<span id="cb329-41"><a href="causal-survival-analysis.html#cb329-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(estimeq)</span>
<span id="cb329-42"><a href="causal-survival-analysis.html#cb329-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb329-43"><a href="causal-survival-analysis.html#cb329-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-44"><a href="causal-survival-analysis.html#cb329-44" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">optimize</span>(sumeef, <span class="at">interval =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>,<span class="fl">0.2</span>))</span>
<span id="cb329-45"><a href="causal-survival-analysis.html#cb329-45" aria-hidden="true" tabindex="-1"></a>psi1 <span class="ot">&lt;-</span> res<span class="sc">$</span>minimum</span>
<span id="cb329-46"><a href="causal-survival-analysis.html#cb329-46" aria-hidden="true" tabindex="-1"></a>objfunc <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(res<span class="sc">$</span>objective)</span>
<span id="cb329-47"><a href="causal-survival-analysis.html#cb329-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-48"><a href="causal-survival-analysis.html#cb329-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-49"><a href="causal-survival-analysis.html#cb329-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Use simple bisection method to find estimates of lower and upper 95% confidence bounds</span></span>
<span id="cb329-50"><a href="causal-survival-analysis.html#cb329-50" aria-hidden="true" tabindex="-1"></a>increm <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb329-51"><a href="causal-survival-analysis.html#cb329-51" aria-hidden="true" tabindex="-1"></a>for_conf <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb329-52"><a href="causal-survival-analysis.html#cb329-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sumeef</span>(x) <span class="sc">-</span> <span class="fl">3.84</span>)</span>
<span id="cb329-53"><a href="causal-survival-analysis.html#cb329-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb329-54"><a href="causal-survival-analysis.html#cb329-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-55"><a href="causal-survival-analysis.html#cb329-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (objfunc <span class="sc">&lt;</span> <span class="fl">3.84</span>){</span>
<span id="cb329-56"><a href="causal-survival-analysis.html#cb329-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find estimate of where sumeef(x) &gt; 3.84</span></span>
<span id="cb329-57"><a href="causal-survival-analysis.html#cb329-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb329-58"><a href="causal-survival-analysis.html#cb329-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lower bound of 95% CI</span></span>
<span id="cb329-59"><a href="causal-survival-analysis.html#cb329-59" aria-hidden="true" tabindex="-1"></a>  psilow <span class="ot">&lt;-</span> psi1</span>
<span id="cb329-60"><a href="causal-survival-analysis.html#cb329-60" aria-hidden="true" tabindex="-1"></a>  testlow <span class="ot">&lt;-</span> objfunc</span>
<span id="cb329-61"><a href="causal-survival-analysis.html#cb329-61" aria-hidden="true" tabindex="-1"></a>  countlow <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb329-62"><a href="causal-survival-analysis.html#cb329-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (testlow <span class="sc">&lt;</span> <span class="fl">3.84</span> <span class="sc">&amp;</span> countlow <span class="sc">&lt;</span> <span class="dv">100</span>){</span>
<span id="cb329-63"><a href="causal-survival-analysis.html#cb329-63" aria-hidden="true" tabindex="-1"></a>    psilow <span class="ot">&lt;-</span> psilow <span class="sc">-</span> increm</span>
<span id="cb329-64"><a href="causal-survival-analysis.html#cb329-64" aria-hidden="true" tabindex="-1"></a>    testlow <span class="ot">&lt;-</span> <span class="fu">sumeef</span>(psilow)</span>
<span id="cb329-65"><a href="causal-survival-analysis.html#cb329-65" aria-hidden="true" tabindex="-1"></a>    countlow <span class="ot">&lt;-</span> countlow <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb329-66"><a href="causal-survival-analysis.html#cb329-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb329-67"><a href="causal-survival-analysis.html#cb329-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb329-68"><a href="causal-survival-analysis.html#cb329-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Upper bound of 95% CI</span></span>
<span id="cb329-69"><a href="causal-survival-analysis.html#cb329-69" aria-hidden="true" tabindex="-1"></a>  psihigh <span class="ot">&lt;-</span> psi1</span>
<span id="cb329-70"><a href="causal-survival-analysis.html#cb329-70" aria-hidden="true" tabindex="-1"></a>  testhigh <span class="ot">&lt;-</span> objfunc</span>
<span id="cb329-71"><a href="causal-survival-analysis.html#cb329-71" aria-hidden="true" tabindex="-1"></a>  counthigh <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb329-72"><a href="causal-survival-analysis.html#cb329-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (testhigh <span class="sc">&lt;</span> <span class="fl">3.84</span> <span class="sc">&amp;</span> counthigh <span class="sc">&lt;</span> <span class="dv">100</span>){</span>
<span id="cb329-73"><a href="causal-survival-analysis.html#cb329-73" aria-hidden="true" tabindex="-1"></a>    psihigh <span class="ot">&lt;-</span> psihigh <span class="sc">+</span> increm</span>
<span id="cb329-74"><a href="causal-survival-analysis.html#cb329-74" aria-hidden="true" tabindex="-1"></a>    testhigh <span class="ot">&lt;-</span> <span class="fu">sumeef</span>(psihigh)</span>
<span id="cb329-75"><a href="causal-survival-analysis.html#cb329-75" aria-hidden="true" tabindex="-1"></a>    counthigh <span class="ot">&lt;-</span> counthigh <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb329-76"><a href="causal-survival-analysis.html#cb329-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb329-77"><a href="causal-survival-analysis.html#cb329-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb329-78"><a href="causal-survival-analysis.html#cb329-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Better estimate using bisection method</span></span>
<span id="cb329-79"><a href="causal-survival-analysis.html#cb329-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((testhigh <span class="sc">&gt;</span> <span class="fl">3.84</span>) <span class="sc">&amp;</span> (testlow <span class="sc">&gt;</span> <span class="fl">3.84</span>)){</span>
<span id="cb329-80"><a href="causal-survival-analysis.html#cb329-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb329-81"><a href="causal-survival-analysis.html#cb329-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bisection method</span></span>
<span id="cb329-82"><a href="causal-survival-analysis.html#cb329-82" aria-hidden="true" tabindex="-1"></a>    left <span class="ot">&lt;-</span> psi1</span>
<span id="cb329-83"><a href="causal-survival-analysis.html#cb329-83" aria-hidden="true" tabindex="-1"></a>    fleft <span class="ot">&lt;-</span> objfunc <span class="sc">-</span> <span class="fl">3.84</span></span>
<span id="cb329-84"><a href="causal-survival-analysis.html#cb329-84" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> psihigh</span>
<span id="cb329-85"><a href="causal-survival-analysis.html#cb329-85" aria-hidden="true" tabindex="-1"></a>    fright <span class="ot">&lt;-</span> testhigh <span class="sc">-</span> <span class="fl">3.84</span></span>
<span id="cb329-86"><a href="causal-survival-analysis.html#cb329-86" aria-hidden="true" tabindex="-1"></a>    middle <span class="ot">&lt;-</span> (left  <span class="sc">+</span> right) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb329-87"><a href="causal-survival-analysis.html#cb329-87" aria-hidden="true" tabindex="-1"></a>    fmiddle <span class="ot">&lt;-</span> <span class="fu">for_conf</span>(middle)</span>
<span id="cb329-88"><a href="causal-survival-analysis.html#cb329-88" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb329-89"><a href="causal-survival-analysis.html#cb329-89" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> right <span class="sc">-</span> left</span>
<span id="cb329-90"><a href="causal-survival-analysis.html#cb329-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb329-91"><a href="causal-survival-analysis.html#cb329-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="sc">!</span>(<span class="fu">abs</span>(fmiddle) <span class="sc">&lt;</span> <span class="fl">0.0001</span> <span class="sc">|</span> diff <span class="sc">&lt;</span> <span class="fl">0.0001</span> <span class="sc">|</span> count <span class="sc">&gt;</span> <span class="dv">100</span>)){</span>
<span id="cb329-92"><a href="causal-survival-analysis.html#cb329-92" aria-hidden="true" tabindex="-1"></a>      test <span class="ot">&lt;-</span> fmiddle <span class="sc">*</span> fleft</span>
<span id="cb329-93"><a href="causal-survival-analysis.html#cb329-93" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (test <span class="sc">&lt;</span> <span class="dv">0</span>){</span>
<span id="cb329-94"><a href="causal-survival-analysis.html#cb329-94" aria-hidden="true" tabindex="-1"></a>        right <span class="ot">&lt;-</span> middle</span>
<span id="cb329-95"><a href="causal-survival-analysis.html#cb329-95" aria-hidden="true" tabindex="-1"></a>        fright <span class="ot">&lt;-</span> fmiddle</span>
<span id="cb329-96"><a href="causal-survival-analysis.html#cb329-96" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb329-97"><a href="causal-survival-analysis.html#cb329-97" aria-hidden="true" tabindex="-1"></a>        left <span class="ot">&lt;-</span> middle</span>
<span id="cb329-98"><a href="causal-survival-analysis.html#cb329-98" aria-hidden="true" tabindex="-1"></a>        fleft <span class="ot">&lt;-</span> fmiddle</span>
<span id="cb329-99"><a href="causal-survival-analysis.html#cb329-99" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb329-100"><a href="causal-survival-analysis.html#cb329-100" aria-hidden="true" tabindex="-1"></a>      middle <span class="ot">&lt;-</span> (left <span class="sc">+</span> right) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb329-101"><a href="causal-survival-analysis.html#cb329-101" aria-hidden="true" tabindex="-1"></a>      fmiddle <span class="ot">&lt;-</span> <span class="fu">for_conf</span>(middle)</span>
<span id="cb329-102"><a href="causal-survival-analysis.html#cb329-102" aria-hidden="true" tabindex="-1"></a>      count <span class="ot">&lt;-</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb329-103"><a href="causal-survival-analysis.html#cb329-103" aria-hidden="true" tabindex="-1"></a>      diff <span class="ot">&lt;-</span> right <span class="sc">-</span> left</span>
<span id="cb329-104"><a href="causal-survival-analysis.html#cb329-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb329-105"><a href="causal-survival-analysis.html#cb329-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb329-106"><a href="causal-survival-analysis.html#cb329-106" aria-hidden="true" tabindex="-1"></a>    psi_high <span class="ot">&lt;-</span> middle</span>
<span id="cb329-107"><a href="causal-survival-analysis.html#cb329-107" aria-hidden="true" tabindex="-1"></a>    objfunc_high <span class="ot">&lt;-</span> fmiddle <span class="sc">+</span> <span class="fl">3.84</span></span>
<span id="cb329-108"><a href="causal-survival-analysis.html#cb329-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb329-109"><a href="causal-survival-analysis.html#cb329-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lower bound of 95% CI</span></span>
<span id="cb329-110"><a href="causal-survival-analysis.html#cb329-110" aria-hidden="true" tabindex="-1"></a>    left <span class="ot">&lt;-</span> psilow</span>
<span id="cb329-111"><a href="causal-survival-analysis.html#cb329-111" aria-hidden="true" tabindex="-1"></a>    fleft <span class="ot">&lt;-</span> testlow <span class="sc">-</span> <span class="fl">3.84</span></span>
<span id="cb329-112"><a href="causal-survival-analysis.html#cb329-112" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> psi1</span>
<span id="cb329-113"><a href="causal-survival-analysis.html#cb329-113" aria-hidden="true" tabindex="-1"></a>    fright <span class="ot">&lt;-</span> objfunc <span class="sc">-</span> <span class="fl">3.84</span></span>
<span id="cb329-114"><a href="causal-survival-analysis.html#cb329-114" aria-hidden="true" tabindex="-1"></a>    middle <span class="ot">&lt;-</span> (left <span class="sc">+</span> right) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb329-115"><a href="causal-survival-analysis.html#cb329-115" aria-hidden="true" tabindex="-1"></a>    fmiddle <span class="ot">&lt;-</span> <span class="fu">for_conf</span>(middle)</span>
<span id="cb329-116"><a href="causal-survival-analysis.html#cb329-116" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb329-117"><a href="causal-survival-analysis.html#cb329-117" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> right <span class="sc">-</span> left</span>
<span id="cb329-118"><a href="causal-survival-analysis.html#cb329-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb329-119"><a href="causal-survival-analysis.html#cb329-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(<span class="sc">!</span>(<span class="fu">abs</span>(fmiddle) <span class="sc">&lt;</span> <span class="fl">0.0001</span> <span class="sc">|</span> diff <span class="sc">&lt;</span> <span class="fl">0.0001</span> <span class="sc">|</span> count <span class="sc">&gt;</span> <span class="dv">100</span>)){</span>
<span id="cb329-120"><a href="causal-survival-analysis.html#cb329-120" aria-hidden="true" tabindex="-1"></a>      test <span class="ot">&lt;-</span> fmiddle <span class="sc">*</span> fleft</span>
<span id="cb329-121"><a href="causal-survival-analysis.html#cb329-121" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (test <span class="sc">&lt;</span> <span class="dv">0</span>){</span>
<span id="cb329-122"><a href="causal-survival-analysis.html#cb329-122" aria-hidden="true" tabindex="-1"></a>        right <span class="ot">&lt;-</span> middle</span>
<span id="cb329-123"><a href="causal-survival-analysis.html#cb329-123" aria-hidden="true" tabindex="-1"></a>        fright <span class="ot">&lt;-</span> fmiddle</span>
<span id="cb329-124"><a href="causal-survival-analysis.html#cb329-124" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb329-125"><a href="causal-survival-analysis.html#cb329-125" aria-hidden="true" tabindex="-1"></a>        left <span class="ot">&lt;-</span> middle</span>
<span id="cb329-126"><a href="causal-survival-analysis.html#cb329-126" aria-hidden="true" tabindex="-1"></a>        fleft <span class="ot">&lt;-</span> fmiddle</span>
<span id="cb329-127"><a href="causal-survival-analysis.html#cb329-127" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb329-128"><a href="causal-survival-analysis.html#cb329-128" aria-hidden="true" tabindex="-1"></a>      middle <span class="ot">&lt;-</span> (left <span class="sc">+</span> right) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb329-129"><a href="causal-survival-analysis.html#cb329-129" aria-hidden="true" tabindex="-1"></a>      fmiddle <span class="ot">&lt;-</span> <span class="fu">for_conf</span>(middle)</span>
<span id="cb329-130"><a href="causal-survival-analysis.html#cb329-130" aria-hidden="true" tabindex="-1"></a>      diff <span class="ot">&lt;-</span> right <span class="sc">-</span> left</span>
<span id="cb329-131"><a href="causal-survival-analysis.html#cb329-131" aria-hidden="true" tabindex="-1"></a>      count <span class="ot">&lt;-</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb329-132"><a href="causal-survival-analysis.html#cb329-132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb329-133"><a href="causal-survival-analysis.html#cb329-133" aria-hidden="true" tabindex="-1"></a>    psi_low <span class="ot">&lt;-</span> middle</span>
<span id="cb329-134"><a href="causal-survival-analysis.html#cb329-134" aria-hidden="true" tabindex="-1"></a>    objfunc_low <span class="ot">&lt;-</span> fmiddle <span class="sc">+</span> <span class="fl">3.84</span></span>
<span id="cb329-135"><a href="causal-survival-analysis.html#cb329-135" aria-hidden="true" tabindex="-1"></a>    psi <span class="ot">&lt;-</span> psi1</span>
<span id="cb329-136"><a href="causal-survival-analysis.html#cb329-136" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb329-137"><a href="causal-survival-analysis.html#cb329-137" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb329-138"><a href="causal-survival-analysis.html#cb329-138" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(psi, psi_low, psi_high)</span></code></pre></div>
<pre><code>## [1] -0.05041591 -0.22312099  0.33312901</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="instrumental-variables-estimation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="session-information-r.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/remlapmot/cibookex-r/edit/master/17-causal-surv-r.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/remlapmot/cibookex-r/blob/master/17-causal-surv-r.Rmd",
"text": null
},
"download": ["cibookex-r.pdf", "cibookex-r.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
